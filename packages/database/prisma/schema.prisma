generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  name          String
  phone         String?
  role          String    @default("CLIENT") // ADMIN, CLIENT, PARTNER, WAREHOUSE_STAFF, DRIVER, PICKUP_AGENT, DELIVERY_AGENT, HUB_OPERATOR
  isActive      Boolean   @default(true) @map("is_active")
  hubId         String?   @map("hub_id") // For agents/operators assigned to a hub
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  client         Client?
  partner        Partner?
  warehouseStaff WarehouseStaff?
  sessions       Session[]
  tasks          Task[]

  @@map("users")
}

// ============================================
// AUTH SESSIONS (Mobile App)
// ============================================

model Session {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  token         String    @unique
  deviceId      String?   @map("device_id")
  deviceName    String?   @map("device_name")
  platform      String?   // IOS, ANDROID
  expiresAt     DateTime  @map("expires_at")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  lastUsedAt    DateTime  @default(now()) @map("last_used_at")

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// ============================================
// MOBILE TASK ASSIGNMENT
// ============================================

model Task {
  id              String    @id @default(cuid())
  taskNumber      String    @unique @map("task_number")

  // Assignment
  assignedToId    String    @map("assigned_to_id")
  hubId           String?   @map("hub_id")

  // Task Type
  type            String    // PICKUP, DELIVERY, INSCAN, OUTSCAN, LOAD, UNLOAD
  priority        Int       @default(1) // 1=Low, 2=Medium, 3=High, 4=Urgent
  sequence        Int       @default(0) // Order in the delivery route

  // Related entities
  shipmentId      String?   @map("shipment_id")
  awbNumber       String?   @map("awb_number")
  tripId          String?   @map("trip_id")
  consignmentId   String?   @map("consignment_id")

  // Location details
  address         String?
  pincode         String?
  city            String?
  latitude        Float?
  longitude       Float?

  // Contact
  contactName     String?   @map("contact_name")
  contactPhone    String?   @map("contact_phone")

  // COD
  isCod           Boolean   @default(false) @map("is_cod")
  codAmount       Float     @default(0) @map("cod_amount")
  codCollected    Float     @default(0) @map("cod_collected")
  paymentMode     String?   @map("payment_mode") // CASH, UPI, CARD

  // Scheduling
  scheduledDate   DateTime  @map("scheduled_date")
  timeSlotStart   String?   @map("time_slot_start")
  timeSlotEnd     String?   @map("time_slot_end")

  // Status
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELLED

  // Attempt tracking
  attemptNumber   Int       @default(1) @map("attempt_number")
  maxAttempts     Int       @default(3) @map("max_attempts")
  failedReason    String?   @map("failed_reason")

  // Completion
  completedAt     DateTime? @map("completed_at")
  completedLat    Float?    @map("completed_lat")
  completedLng    Float?    @map("completed_lng")

  // POD (for deliveries)
  podReceiverName String?   @map("pod_receiver_name")
  podRelation     String?   @map("pod_relation")
  podSignature    String?   @map("pod_signature")
  podPhoto        String?   @map("pod_photo")
  podOtpVerified  Boolean   @default(false) @map("pod_otp_verified")

  notes           String?

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  assignedTo      User      @relation(fields: [assignedToId], references: [id])

  @@index([assignedToId, status])
  @@index([hubId, scheduledDate])
  @@index([status])
  @@map("tasks")
}

// ============================================
// CLIENT (B2B CUSTOMERS)
// ============================================

model Client {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  companyName         String   @map("company_name")
  gstNumber           String?  @map("gst_number")
  billingAddress      String   @map("billing_address")
  creditLimit         Float    @default(0) @map("credit_limit")
  currentBalance      Float    @default(0) @map("current_balance")
  paymentTermsDays    Int      @default(15) @map("payment_terms_days")

  weightCost          Float    @default(0.4) @map("weight_cost")
  weightSpeed         Float    @default(0.3) @map("weight_speed")
  weightReliability   Float    @default(0.3) @map("weight_reliability")

  webhookUrl          String?  @map("webhook_url")
  apiKey              String?  @unique @map("api_key")

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user                User       @relation(fields: [userId], references: [id])
  orders              Order[]
  invoices            Invoice[]
  warehouses          Warehouse[]
  customerSessions    CustomerSession[]

  // Compliance Relations
  ulipIntegrations    ULIPIntegration[]
  ewayBills           EwayBill[]
  einvoices           EInvoice[]
  paymentGateways     PaymentGateway[]

  @@map("clients")
}

// ============================================
// LOGISTICS PARTNERS
// ============================================

model Partner {
  id                  String   @id @default(cuid())
  userId              String?  @unique @map("user_id")
  code                String   @unique
  name                String
  displayName         String   @map("display_name")
  apiBaseUrl          String   @map("api_base_url")
  apiKey              String   @map("api_key")
  apiSecret           String?  @map("api_secret")
  webhookSecret       String?  @map("webhook_secret")

  isActive            Boolean  @default(true) @map("is_active")
  settlementCycleDays Int      @default(15) @map("settlement_cycle_days")

  supportsCod         Boolean  @default(true) @map("supports_cod")
  supportsReverse     Boolean  @default(false) @map("supports_reverse")
  supportsHyperlocal  Boolean  @default(false) @map("supports_hyperlocal")

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  user                User?    @relation(fields: [userId], references: [id])
  serviceability      PartnerServiceability[]
  performance         PartnerPerformance[]
  orders              Order[]
  settlements         PartnerSettlement[]

  @@map("partners")
}

model PartnerServiceability {
  id                 String   @id @default(cuid())
  partnerId          String   @map("partner_id")
  originPincode      String   @map("origin_pincode")
  destinationPincode String   @map("destination_pincode")

  baseRate           Float    @map("base_rate")
  ratePerKg          Float    @map("rate_per_kg")
  codChargePercent   Float    @default(2) @map("cod_charge_percent")
  codChargeMin       Float    @default(30) @map("cod_charge_min")

  estimatedTatDays   Int      @map("estimated_tat_days")
  isActive           Boolean  @default(true) @map("is_active")

  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  partner            Partner  @relation(fields: [partnerId], references: [id])

  @@unique([partnerId, originPincode, destinationPincode])
  @@index([originPincode, destinationPincode])
  @@map("partner_serviceability")
}

model PartnerPerformance {
  id                  String   @id @default(cuid())
  partnerId           String   @map("partner_id")
  calculationDate     DateTime @map("calculation_date")

  totalOrders         Int      @default(0) @map("total_orders")
  deliveredOrders     Int      @default(0) @map("delivered_orders")
  onTimeDeliveries    Int      @default(0) @map("on_time_deliveries")
  ndrRaised           Int      @default(0) @map("ndr_raised")
  ndrResolved         Int      @default(0) @map("ndr_resolved")
  rtoOrders           Int      @default(0) @map("rto_orders")

  otpPercentage       Float    @default(0) @map("otp_percentage")
  ndrResolutionRate   Float    @default(0) @map("ndr_resolution_rate")
  rtoPercentage       Float    @default(0) @map("rto_percentage")
  avgRating           Float    @default(5) @map("avg_rating")

  reliabilityScore    Float    @default(80) @map("reliability_score")

  createdAt           DateTime @default(now()) @map("created_at")

  partner             Partner  @relation(fields: [partnerId], references: [id])

  @@unique([partnerId, calculationDate])
  @@map("partner_performance")
}

// ============================================
// WAREHOUSE & INVENTORY
// ============================================

model Warehouse {
  id            String   @id @default(cuid())
  clientId      String   @map("client_id")
  name          String
  code          String   @unique
  address       String
  pincode       String
  city          String
  state         String
  contactName   String   @map("contact_name")
  contactPhone  String   @map("contact_phone")
  isActive      Boolean  @default(true) @map("is_active")

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  client        Client   @relation(fields: [clientId], references: [id])
  staff         WarehouseStaff[]
  orders        Order[]

  @@map("warehouses")
}

model WarehouseStaff {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id")
  warehouseId   String   @map("warehouse_id")
  employeeCode  String   @unique @map("employee_code")

  createdAt     DateTime @default(now()) @map("created_at")

  user          User     @relation(fields: [userId], references: [id])
  warehouse     Warehouse @relation(fields: [warehouseId], references: [id])
  pickedOrders  Order[]  @relation("PickedBy")
  packedOrders  Order[]  @relation("PackedBy")
  dispatchedOrders Order[] @relation("DispatchedBy")

  @@map("warehouse_staff")
}

// ============================================
// ORDER & LIFECYCLE
// ============================================

model Order {
  id                  String    @id @default(cuid())
  orderNumber         String    @unique @map("order_number")
  clientId            String    @map("client_id")
  partnerId           String?   @map("partner_id")
  warehouseId         String?   @map("warehouse_id")

  customerName        String    @map("customer_name")
  customerPhone       String    @map("customer_phone")
  customerEmail       String?   @map("customer_email")
  deliveryAddress     String    @map("delivery_address")
  deliveryPincode     String    @map("delivery_pincode")
  deliveryCity        String    @map("delivery_city")
  deliveryState       String    @map("delivery_state")

  originPincode       String    @map("origin_pincode")

  weightKg            Float     @map("weight_kg")
  lengthCm            Float?    @map("length_cm")
  widthCm             Float?    @map("width_cm")
  heightCm            Float?    @map("height_cm")
  volumetricWeight    Float?    @map("volumetric_weight")
  chargeableWeight    Float?    @map("chargeable_weight")

  itemDescription     String    @map("item_description")
  itemValue           Float     @map("item_value")
  itemQuantity        Int       @default(1) @map("item_quantity")
  itemSku             String?   @map("item_sku")

  paymentMode         String    @default("PREPAID") @map("payment_mode") // PREPAID, COD
  codAmount           Float     @default(0) @map("cod_amount")

  awbNumber           String?   @unique @map("awb_number")
  partnerRate         Float?    @map("partner_rate")
  clientRate          Float?    @map("client_rate")
  partnerScore        Float?    @map("partner_score")
  labelUrl            String?   @map("label_url")
  trackingUrl         String?   @map("tracking_url")

  status              String    @default("CREATED") // OrderStatus enum values

  manifestedAt        DateTime? @map("manifested_at")
  pickupScheduledAt   DateTime? @map("pickup_scheduled_at")
  pickedAt            DateTime? @map("picked_at")
  packedAt            DateTime? @map("packed_at")
  dispatchedAt        DateTime? @map("dispatched_at")
  handedOverAt        DateTime? @map("handed_over_at")
  deliveredAt         DateTime? @map("delivered_at")

  pickedById          String?   @map("picked_by_id")
  packedById          String?   @map("packed_by_id")
  dispatchedById      String?   @map("dispatched_by_id")

  expectedDeliveryDate DateTime? @map("expected_delivery_date")

  podSignature        String?   @map("pod_signature")
  podPhoto            String?   @map("pod_photo")
  podOtp              String?   @map("pod_otp")
  podReceiverName     String?   @map("pod_receiver_name")
  podReceiverRelation String?   @map("pod_receiver_relation")
  podLatitude         Float?    @map("pod_latitude")
  podLongitude        Float?    @map("pod_longitude")

  isSettled           Boolean   @default(false) @map("is_settled")
  settlementId        String?   @map("settlement_id")

  isInvoiced          Boolean   @default(false) @map("is_invoiced")
  invoiceId           String?   @map("invoice_id")

  clientOrderId       String?   @map("client_order_id")
  notes               String?

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  client              Client    @relation(fields: [clientId], references: [id])
  partner             Partner?  @relation(fields: [partnerId], references: [id])
  warehouse           Warehouse? @relation(fields: [warehouseId], references: [id])
  pickedBy            WarehouseStaff? @relation("PickedBy", fields: [pickedById], references: [id])
  packedBy            WarehouseStaff? @relation("PackedBy", fields: [packedById], references: [id])
  dispatchedBy        WarehouseStaff? @relation("DispatchedBy", fields: [dispatchedById], references: [id])
  events              OrderEvent[]
  ndrCase             NdrCase?
  invoice             Invoice?  @relation(fields: [invoiceId], references: [id])
  settlement          PartnerSettlement? @relation(fields: [settlementId], references: [id])

  @@index([clientId, status])
  @@index([partnerId, status])
  @@index([status, createdAt])
  @@index([deliveryPincode])
  @@index([originPincode])
  @@map("orders")
}

// ============================================
// ORDER EVENTS (TRACKING)
// ============================================

model OrderEvent {
  id            String   @id @default(cuid())
  orderId       String   @map("order_id")

  status        String   // OrderStatus value
  statusText    String   @map("status_text")
  location      String?
  remarks       String?

  source        String   @default("SYSTEM")
  sourceRef     String?  @map("source_ref")

  eventTime     DateTime @map("event_time")
  createdAt     DateTime @default(now()) @map("created_at")

  order         Order    @relation(fields: [orderId], references: [id])

  @@index([orderId, eventTime])
  @@map("order_events")
}

// ============================================
// NDR MANAGEMENT
// ============================================

model NdrCase {
  id                String    @id @default(cuid())
  orderId           String    @unique @map("order_id")

  reason            String    // NdrReason enum value
  reasonText        String?   @map("reason_text")
  attemptNumber     Int       @default(1) @map("attempt_number")
  maxAttempts       Int       @default(3) @map("max_attempts")

  action            String    @default("PENDING") // NdrAction enum value
  actionNotes       String?   @map("action_notes")

  correctedAddress  String?   @map("corrected_address")
  correctedPincode  String?   @map("corrected_pincode")

  rescheduledDate   DateTime? @map("rescheduled_date")

  isResolved        Boolean   @default(false) @map("is_resolved")
  resolvedAt        DateTime? @map("resolved_at")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  order             Order     @relation(fields: [orderId], references: [id])

  @@map("ndr_cases")
}

// ============================================
// BILLING & INVOICES
// ============================================

model Invoice {
  id                String    @id @default(cuid())
  invoiceNumber     String    @unique @map("invoice_number")

  // Client
  clientId          String    @map("client_id")
  clientName        String?   @map("client_name")
  clientGstin       String?   @map("client_gstin")
  clientAddress     String?   @map("client_address")

  // Invoice period
  periodStart       DateTime? @map("period_start")
  periodEnd         DateTime? @map("period_end")
  invoiceDate       DateTime  @map("invoice_date")
  dueDate           DateTime  @map("due_date")

  // Shipment counts
  totalShipments    Int       @default(0) @map("total_shipments")
  deliveredCount    Int       @default(0) @map("delivered_count")
  rtoCount          Int       @default(0) @map("rto_count")

  // Amount breakdown
  freightCharges    Float     @default(0) @map("freight_charges")
  codCharges        Float     @default(0) @map("cod_charges")
  fuelSurcharge     Float     @default(0) @map("fuel_surcharge")
  handlingCharges   Float     @default(0) @map("handling_charges")
  otherCharges      Float     @default(0) @map("other_charges")

  // Totals
  subtotal          Float
  taxAmount         Float     @map("tax_amount")
  gstAmount         Float     @default(0) @map("gst_amount")
  totalAmount       Float     @map("total_amount")

  // Adjustments
  discountAmount    Float     @default(0) @map("discount_amount")
  adjustmentAmount  Float     @default(0) @map("adjustment_amount")
  netPayable        Float     @default(0) @map("net_payable")

  // Payment status
  paidAmount        Float     @default(0) @map("paid_amount")
  balanceDue        Float     @default(0) @map("balance_due")
  status            String    @default("PENDING") // DRAFT, PENDING, SENT, PAID, PARTIALLY_PAID, OVERDUE, CANCELLED

  // GST details
  cgstAmount        Float     @default(0) @map("cgst_amount")
  sgstAmount        Float     @default(0) @map("sgst_amount")
  igstAmount        Float     @default(0) @map("igst_amount")

  // PDF and sharing
  pdfUrl            String?   @map("pdf_url")
  sentAt            DateTime? @map("sent_at")
  sentTo            String?   @map("sent_to")

  paidAt            DateTime? @map("paid_at")
  paymentRef        String?   @map("payment_ref")

  // Notes
  notes             String?
  internalNotes     String?   @map("internal_notes")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  client            Client    @relation(fields: [clientId], references: [id])
  orders            Order[]
  lineItems         InvoiceLineItem[]
  payments          Payment[]
  creditNotes       CreditNote[]

  @@index([clientId, status])
  @@index([invoiceDate])
  @@index([dueDate, status])
  @@map("invoices")
}

// ============================================
// PARTNER SETTLEMENTS
// ============================================

model PartnerSettlement {
  id                  String   @id @default(cuid())
  settlementNumber    String   @unique @map("settlement_number")
  partnerId           String   @map("partner_id")

  periodStart         DateTime @map("period_start")
  periodEnd           DateTime @map("period_end")

  totalOrders         Int      @map("total_orders")
  freightAmount       Float    @map("freight_amount")
  codCollected        Float    @map("cod_collected")
  codRemittance       Float    @map("cod_remittance")
  netPayable          Float    @map("net_payable")

  status              String   @default("PENDING") // SettlementStatus enum value

  processedAt         DateTime? @map("processed_at")
  paymentRef          String?   @map("payment_ref")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  partner             Partner   @relation(fields: [partnerId], references: [id])
  orders              Order[]

  @@index([partnerId, status])
  @@map("partner_settlements")
}

// ============================================
// PINCODE MASTER
// ============================================

model PincodeMaster {
  id          String   @id @default(cuid())
  pincode     String   @unique
  city        String
  state       String
  region      String?
  zone        String?  // NORTH, SOUTH, EAST, WEST, CENTRAL
  tier        Int      @default(1) // 1=Metro, 2=Tier-1, 3=Tier-2, 4=Tier-3, 5=Rural
  isActive    Boolean  @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")

  @@map("pincode_master")
}

// ============================================
// ZONE TAT MATRIX (PTL SLA)
// ============================================

model ZoneTatMatrix {
  id                String   @id @default(cuid())

  // Origin/Destination Zone
  originZone        String   @map("origin_zone")       // NORTH, SOUTH, EAST, WEST, CENTRAL
  destinationZone   String   @map("destination_zone")

  // Service Type
  serviceType       String   @default("STANDARD") @map("service_type") // EXPRESS, STANDARD, ECONOMY

  // Route Type (calculated)
  routeType         String   @map("route_type")        // LOCAL, ZONAL, NATIONAL

  // TAT in days
  tatDays           Int      @map("tat_days")
  minDays           Int      @default(1) @map("min_days")
  maxDays           Int      @map("max_days")

  // Rates
  baseRatePerKg     Float    @map("base_rate_per_kg")
  minChargeableKg   Float    @default(10) @map("min_chargeable_kg")

  // SLA commitment
  slaPercentage     Float    @default(95) @map("sla_percentage") // Target SLA %

  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([originZone, destinationZone, serviceType])
  @@index([originZone, destinationZone])
  @@map("zone_tat_matrix")
}

// ============================================
// PTL CUSTOMER SESSIONS
// ============================================

model CustomerSession {
  id            String    @id @default(cuid())
  clientId      String    @map("client_id")
  token         String    @unique
  deviceInfo    String?   @map("device_info")
  ipAddress     String?   @map("ip_address")
  expiresAt     DateTime  @map("expires_at")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  lastUsedAt    DateTime  @default(now()) @map("last_used_at")

  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([token])
  @@map("customer_sessions")
}

// ============================================
// WEBHOOK LOGS
// ============================================

model WebhookLog {
  id            String   @id @default(cuid())
  direction     String
  source        String
  endpoint      String
  payload       String   // JSON as string for SQLite
  responseCode  Int?     @map("response_code")
  responseBody  String?  @map("response_body")
  isSuccess     Boolean  @default(false) @map("is_success")
  errorMessage  String?  @map("error_message")
  retryCount    Int      @default(0) @map("retry_count")

  createdAt     DateTime @default(now()) @map("created_at")

  @@index([source, createdAt])
  @@map("webhook_logs")
}

// ============================================
// HUB NETWORK (PTL Operations)
// ============================================

model Hub {
  id                  String   @id @default(cuid())
  code                String   @unique
  name                String
  type                String   @default("TRANSSHIPMENT") // GATEWAY, TRANSSHIPMENT, SPOKE

  // Location
  address             String
  pincode             String
  city                String
  state               String
  latitude            Float?
  longitude           Float?

  // Capacity
  totalBays           Int      @default(10) @map("total_bays")
  loadingBays         Int      @default(5) @map("loading_bays")
  unloadingBays       Int      @default(5) @map("unloading_bays")
  sortingCapacity     Int      @default(1000) @map("sorting_capacity") // packages per hour

  // Operations
  operatingHoursStart String   @default("06:00") @map("operating_hours_start")
  operatingHoursEnd   String   @default("22:00") @map("operating_hours_end")

  // Contact
  contactName         String   @map("contact_name")
  contactPhone        String   @map("contact_phone")
  contactEmail        String?  @map("contact_email")

  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  staff               HubStaff[]
  servicedPincodes    HubPincodeMapping[]

  @@index([pincode])
  @@index([city, state])
  @@map("hubs")
}

model HubPincodeMapping {
  id          String   @id @default(cuid())
  hubId       String   @map("hub_id")
  pincode     String
  type        String   @default("DELIVERY") // PICKUP, DELIVERY, BOTH
  priority    Int      @default(1) // For multiple hubs serving same pincode

  createdAt   DateTime @default(now()) @map("created_at")

  hub         Hub      @relation(fields: [hubId], references: [id], onDelete: Cascade)

  @@unique([hubId, pincode, type])
  @@index([pincode])
  @@map("hub_pincode_mapping")
}

model HubStaff {
  id            String   @id @default(cuid())
  hubId         String   @map("hub_id")
  employeeCode  String   @unique @map("employee_code")
  name          String
  phone         String
  email         String?
  role          String   @default("OPERATOR") // MANAGER, SUPERVISOR, OPERATOR, LOADER

  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  hub           Hub      @relation(fields: [hubId], references: [id], onDelete: Cascade)

  @@index([hubId])
  @@map("hub_staff")
}

// ============================================
// FLEET MANAGEMENT
// ============================================

model Vehicle {
  id                String    @id @default(cuid())
  registrationNo    String    @unique @map("registration_no")
  type              String    // TATA_ACE, EICHER_14FT, TATA_407, TATA_709, CONTAINER_20FT

  // Capacity
  capacityTonnage   Float     @map("capacity_tonnage") // in tons
  capacityVolumeCBM Float     @map("capacity_volume_cbm") // cubic meters

  // Dimensions (internal cargo space in feet)
  lengthFt          Float?    @map("length_ft")
  widthFt           Float?    @map("width_ft")
  heightFt          Float?    @map("height_ft")

  // Vehicle Details
  make              String?
  model             String?
  year              Int?
  fuelType          String    @default("DIESEL") @map("fuel_type") // DIESEL, PETROL, CNG, EV

  // Documents
  rcExpiryDate      DateTime? @map("rc_expiry_date")
  insuranceExpiry   DateTime? @map("insurance_expiry")
  fitnessExpiry     DateTime? @map("fitness_expiry")
  permitExpiry      DateTime? @map("permit_expiry")
  pollutionExpiry   DateTime? @map("pollution_expiry")

  // Status
  status            String    @default("AVAILABLE") // AVAILABLE, IN_TRANSIT, MAINTENANCE, BREAKDOWN, RETIRED
  currentHubId      String?   @map("current_hub_id")
  currentLocation   String?   @map("current_location") // GPS coordinates or location description

  // Ownership
  ownershipType     String    @default("OWNED") @map("ownership_type") // OWNED, LEASED, ATTACHED
  ownerName         String?   @map("owner_name")
  ownerPhone        String?   @map("owner_phone")

  // GPS Tracking
  gpsDeviceId       String?   @map("gps_device_id")
  lastGpsUpdate     DateTime? @map("last_gps_update")
  lastLatitude      Float?    @map("last_latitude")
  lastLongitude     Float?    @map("last_longitude")

  isActive          Boolean   @default(true) @map("is_active")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  maintenanceLogs   VehicleMaintenance[]

  @@index([status])
  @@index([currentHubId])
  @@index([type])
  @@map("vehicles")
}

model VehicleMaintenance {
  id              String    @id @default(cuid())
  vehicleId       String    @map("vehicle_id")

  type            String    // SCHEDULED, BREAKDOWN, ACCIDENT, INSPECTION
  description     String
  odometerReading Int?      @map("odometer_reading")

  startDate       DateTime  @map("start_date")
  endDate         DateTime? @map("end_date")

  cost            Float?
  vendorName      String?   @map("vendor_name")
  invoiceNumber   String?   @map("invoice_number")

  createdAt       DateTime  @default(now()) @map("created_at")

  vehicle         Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId, startDate])
  @@map("vehicle_maintenance")
}

// ============================================
// DRIVER MANAGEMENT
// ============================================

model Driver {
  id              String    @id @default(cuid())
  employeeCode    String    @unique @map("employee_code")

  name            String
  phone           String
  altPhone        String?   @map("alt_phone")
  email           String?

  // Address
  address         String?
  city            String?
  state           String?
  pincode         String?

  // License Details
  licenseNumber   String    @unique @map("license_number")
  licenseType     String    @map("license_type") // LMV, HMV, TRANS
  licenseExpiry   DateTime  @map("license_expiry")
  licenseState    String?   @map("license_state")

  // Identity Documents
  aadharNumber    String?   @map("aadhar_number")
  panNumber       String?   @map("pan_number")

  // Status
  status          String    @default("AVAILABLE") // AVAILABLE, ON_TRIP, ON_LEAVE, INACTIVE
  currentHubId    String?   @map("current_hub_id")

  // Experience & Employment
  joiningDate     DateTime  @map("joining_date")
  yearsExperience Int?      @map("years_experience")

  // Performance Metrics
  totalTrips      Int       @default(0) @map("total_trips")
  totalKm         Int       @default(0) @map("total_km")
  rating          Float     @default(5) // 1-5 scale

  // Emergency Contact
  emergencyContactName  String? @map("emergency_contact_name")
  emergencyContactPhone String? @map("emergency_contact_phone")

  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  leaves          DriverLeave[]

  @@index([status])
  @@index([currentHubId])
  @@map("drivers")
}

model DriverLeave {
  id          String    @id @default(cuid())
  driverId    String    @map("driver_id")

  type        String    // CASUAL, SICK, PLANNED, EMERGENCY
  startDate   DateTime  @map("start_date")
  endDate     DateTime  @map("end_date")
  reason      String?

  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy  String?   @map("approved_by")
  approvedAt  DateTime? @map("approved_at")

  createdAt   DateTime  @default(now()) @map("created_at")

  driver      Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@index([driverId, startDate])
  @@map("driver_leaves")
}

// ============================================
// ROUTES & TRIPS (Transport Management)
// ============================================

model Route {
  id                   String   @id @default(cuid())
  code                 String   @unique
  name                 String

  type                 String   @default("LINE_HAUL") // LINE_HAUL, MILK_RUN_PICKUP, MILK_RUN_DELIVERY, FEEDER

  // Route endpoints
  originHubId          String?  @map("origin_hub_id")
  destinationHubId     String?  @map("destination_hub_id")

  // Route details
  distanceKm           Float    @map("distance_km")
  estimatedDurationMin Int      @map("estimated_duration_min")

  // For milk runs: array of stops [{pincode, sequence, estimatedTime}]
  stops                String?  // JSON string for SQLite

  // Schedule
  departureTime        String?  @map("departure_time") // HH:MM format
  arrivalTime          String?  @map("arrival_time")   // HH:MM format
  frequency            String   @default("DAILY") // DAILY, MON_WED_FRI, TUE_THU_SAT, WEEKLY, ON_DEMAND

  // Cost
  baseCostPerTrip      Float?   @map("base_cost_per_trip")
  fuelCostPerKm        Float?   @map("fuel_cost_per_km")
  tollCost             Float?   @map("toll_cost")

  // Recommended vehicle type
  recommendedVehicle   String?  @map("recommended_vehicle")

  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  trips                Trip[]

  @@index([originHubId])
  @@index([destinationHubId])
  @@index([type])
  @@map("routes")
}

model Trip {
  id                 String    @id @default(cuid())
  tripNumber         String    @unique @map("trip_number")

  routeId            String    @map("route_id")
  vehicleId          String    @map("vehicle_id")
  driverId           String    @map("driver_id")

  type               String    @default("LINE_HAUL") // LINE_HAUL, MILK_RUN_PICKUP, MILK_RUN_DELIVERY, FEEDER

  // Route overrides (if different from base route)
  originHubId        String?   @map("origin_hub_id")
  destinationHubId   String?   @map("destination_hub_id")

  // Schedule
  scheduledDeparture DateTime  @map("scheduled_departure")
  scheduledArrival   DateTime  @map("scheduled_arrival")
  actualDeparture    DateTime? @map("actual_departure")
  actualArrival      DateTime? @map("actual_arrival")

  // Load details
  totalShipments     Int       @default(0) @map("total_shipments")
  totalWeightKg      Float     @default(0) @map("total_weight_kg")
  totalVolumeCBM     Float     @default(0) @map("total_volume_cbm")
  totalPackages      Int       @default(0) @map("total_packages")

  // Capacity utilization
  fillRateWeight     Float     @default(0) @map("fill_rate_weight")   // percentage
  fillRateVolume     Float     @default(0) @map("fill_rate_volume")   // percentage

  // Status
  status             String    @default("PLANNED") // PLANNED, LOADING, READY, IN_TRANSIT, ARRIVED, UNLOADING, COMPLETED, CANCELLED

  // Live tracking
  lastLatitude       Float?    @map("last_latitude")
  lastLongitude      Float?    @map("last_longitude")
  lastLocationUpdate DateTime? @map("last_location_update")
  currentLocation    String?   @map("current_location") // Human readable location

  // Distance tracking
  plannedDistanceKm  Float?    @map("planned_distance_km")
  actualDistanceKm   Float?    @map("actual_distance_km")

  // Cost tracking
  estimatedCost      Float?    @map("estimated_cost")
  actualCost         Float?    @map("actual_cost")
  fuelCost           Float?    @map("fuel_cost")
  tollCost           Float?    @map("toll_cost")
  driverAllowance    Float?    @map("driver_allowance")
  otherExpenses      Float?    @map("other_expenses")

  // Notes
  notes              String?
  loadManifest       String?   @map("load_manifest") // JSON string: [{orderId, awb, weight, volume}]
  sealNumber         String?   @map("seal_number")

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  route              Route     @relation(fields: [routeId], references: [id])
  events             TripEvent[]

  @@index([routeId])
  @@index([vehicleId])
  @@index([driverId])
  @@index([status])
  @@index([scheduledDeparture])
  @@map("trips")
}

model TripEvent {
  id          String   @id @default(cuid())
  tripId      String   @map("trip_id")

  eventType   String   @map("event_type") // DEPARTURE, ARRIVAL, CHECKPOINT, DELAY, BREAKDOWN, FUEL_STOP, REST_STOP, INCIDENT
  description String

  // Location
  location    String?
  latitude    Float?
  longitude   Float?

  // Related hub (for arrivals/departures)
  hubId       String?  @map("hub_id")

  eventTime   DateTime @map("event_time")
  createdAt   DateTime @default(now()) @map("created_at")

  trip        Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId, eventTime])
  @@map("trip_events")
}

// ============================================
// SHIPMENT ORCHESTRATION
// ============================================

model Shipment {
  id                  String    @id @default(cuid())
  awbNumber           String    @unique @map("awb_number") // Air Waybill / Tracking number

  // Link to order
  orderId             String?   @unique @map("order_id")

  // Client info
  clientId            String    @map("client_id")
  clientOrderRef      String?   @map("client_order_ref")

  // Shipper (Pickup) Details
  shipperName         String    @map("shipper_name")
  shipperPhone        String    @map("shipper_phone")
  shipperAddress      String    @map("shipper_address")
  shipperPincode      String    @map("shipper_pincode")
  shipperCity         String    @map("shipper_city")
  shipperState        String    @map("shipper_state")

  // Consignee (Delivery) Details
  consigneeName       String    @map("consignee_name")
  consigneePhone      String    @map("consignee_phone")
  consigneeAddress    String    @map("consignee_address")
  consigneePincode    String    @map("consignee_pincode")
  consigneeCity       String    @map("consignee_city")
  consigneeState      String    @map("consignee_state")

  // Package Details
  pieces              Int       @default(1)
  actualWeightKg      Float     @map("actual_weight_kg")
  volumetricWeightKg  Float?    @map("volumetric_weight_kg")
  chargeableWeightKg  Float     @map("chargeable_weight_kg")
  lengthCm            Float?    @map("length_cm")
  widthCm             Float?    @map("width_cm")
  heightCm            Float?    @map("height_cm")

  // Content
  contentDescription  String    @map("content_description")
  declaredValue       Float     @map("declared_value")

  // Payment
  paymentMode         String    @default("PREPAID") @map("payment_mode") // PREPAID, COD, TO_PAY
  codAmount           Float     @default(0) @map("cod_amount")

  // Service Type
  serviceType         String    @default("STANDARD") @map("service_type") // EXPRESS, STANDARD, ECONOMY

  // Fulfillment Mode
  fulfillmentMode     String    @default("OWN_FLEET") @map("fulfillment_mode") // OWN_FLEET, PARTNER, HYBRID

  // Journey Planning
  originHubId         String?   @map("origin_hub_id")
  destinationHubId    String?   @map("destination_hub_id")
  currentHubId        String?   @map("current_hub_id")
  journeyPlanId       String?   @map("journey_plan_id")

  // Consignment (grouped shipments)
  consignmentId       String?   @map("consignment_id")

  // Current Status
  status              String    @default("BOOKED") // See ShipmentStatus enum below
  currentLegIndex     Int       @default(0) @map("current_leg_index")

  // Partner Handover (for hybrid fulfillment)
  handedOverToPartner Boolean   @default(false) @map("handed_over_to_partner")
  partnerId           String?   @map("partner_id")
  partnerAwb          String?   @map("partner_awb")
  partnerHandoverAt   DateTime? @map("partner_handover_at")
  partnerHandoverHub  String?   @map("partner_handover_hub")

  // Delivery Details
  expectedDeliveryDate DateTime? @map("expected_delivery_date")
  actualDeliveryDate   DateTime? @map("actual_delivery_date")
  deliveryAttempts     Int       @default(0) @map("delivery_attempts")

  // POD
  podCaptured         Boolean   @default(false) @map("pod_captured")
  podReceiverName     String?   @map("pod_receiver_name")
  podSignature        String?   @map("pod_signature")
  podPhoto            String?   @map("pod_photo")
  podRelation         String?   @map("pod_relation")
  podLatitude         Float?    @map("pod_latitude")
  podLongitude        Float?    @map("pod_longitude")

  // Timestamps
  bookedAt            DateTime  @default(now()) @map("booked_at")
  pickedUpAt          DateTime? @map("picked_up_at")
  deliveredAt         DateTime? @map("delivered_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  consignment         Consignment? @relation(fields: [consignmentId], references: [id])
  journeyPlan         JourneyPlan? @relation(fields: [journeyPlanId], references: [id])
  scans               ShipmentScan[]
  legs                ShipmentLeg[]
  events              ShipmentEvent[]

  @@index([clientId])
  @@index([status])
  @@index([shipperPincode])
  @@index([consigneePincode])
  @@index([currentHubId])
  @@index([consignmentId])
  @@index([partnerId])
  @@map("shipments")
}

// Shipment Status Enum Values:
// BOOKED -> PICKUP_SCHEDULED -> PICKED_UP ->
// RECEIVED_AT_ORIGIN_HUB -> IN_SORTING -> SORTED ->
// CONSOLIDATED -> LOADED -> IN_TRANSIT ->
// ARRIVED_AT_HUB -> UNLOADED -> (repeat for multi-leg) ->
// HANDED_TO_PARTNER -> PARTNER_IN_TRANSIT ->
// OUT_FOR_DELIVERY -> DELIVERED / DELIVERY_FAILED / RTO_INITIATED

model ShipmentScan {
  id            String   @id @default(cuid())
  shipmentId    String   @map("shipment_id")

  scanType      String   @map("scan_type") // See ScanType enum below
  scanCode      String   @map("scan_code") // Barcode/AWB scanned

  // Location
  hubId         String?  @map("hub_id")
  hubCode       String?  @map("hub_code")
  location      String?

  // Context
  tripId        String?  @map("trip_id")
  consignmentId String?  @map("consignment_id")
  bagId         String?  @map("bag_id")

  // Scan details
  scannedBy     String   @map("scanned_by") // User/Staff ID
  scannedByName String?  @map("scanned_by_name")
  deviceId      String?  @map("device_id")

  // Coordinates
  latitude      Float?
  longitude     Float?

  remarks       String?
  scanTime      DateTime @map("scan_time")
  createdAt     DateTime @default(now()) @map("created_at")

  shipment      Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, scanTime])
  @@index([hubId, scanTime])
  @@index([scanType])
  @@map("shipment_scans")
}

// ScanType Enum Values:
// PICKUP_SCAN, INSCAN, OUTSCAN, BAG_OPEN, BAG_CLOSE,
// LOAD_SCAN, UNLOAD_SCAN, RECEIVED_SCAN, DISPATCH_SCAN,
// OUT_FOR_DELIVERY_SCAN, DELIVERY_SCAN, POD_SCAN,
// PARTNER_HANDOVER_SCAN, PARTNER_RECEIVED_SCAN,
// RTO_SCAN, DAMAGE_SCAN, MISSING_SCAN

model ShipmentEvent {
  id            String   @id @default(cuid())
  shipmentId    String   @map("shipment_id")

  eventType     String   @map("event_type")
  status        String   // New status after event
  statusText    String   @map("status_text") // Human readable status

  // Location
  hubId         String?  @map("hub_id")
  location      String?

  // Source
  source        String   @default("SYSTEM") // SYSTEM, HUB_SCAN, PARTNER_API, MANUAL
  sourceRef     String?  @map("source_ref")

  remarks       String?
  eventTime     DateTime @map("event_time")
  createdAt     DateTime @default(now()) @map("created_at")

  shipment      Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId, eventTime])
  @@map("shipment_events")
}

// ============================================
// CONSIGNMENT MANAGEMENT
// ============================================

model Consignment {
  id                  String    @id @default(cuid())
  consignmentNumber   String    @unique @map("consignment_number")

  // Route
  originHubId         String    @map("origin_hub_id")
  destinationHubId    String    @map("destination_hub_id")

  // Consolidation
  shipmentCount       Int       @default(0) @map("shipment_count")
  totalPieces         Int       @default(0) @map("total_pieces")
  totalWeightKg       Float     @default(0) @map("total_weight_kg")
  totalVolumeCBM      Float     @default(0) @map("total_volume_cbm")

  // Bag/Container
  bagCount            Int       @default(0) @map("bag_count")
  sealNumbers         String?   @map("seal_numbers") // JSON array of seal numbers

  // Assignment
  tripId              String?   @map("trip_id")
  vehicleId           String?   @map("vehicle_id")

  // Status
  status              String    @default("OPEN") // OPEN, CLOSED, LOADED, IN_TRANSIT, ARRIVED, DELIVERED

  // Timestamps
  closedAt            DateTime? @map("closed_at")
  loadedAt            DateTime? @map("loaded_at")
  dispatchedAt        DateTime? @map("dispatched_at")
  arrivedAt           DateTime? @map("arrived_at")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  shipments           Shipment[]
  bags                ConsignmentBag[]

  @@index([originHubId, destinationHubId])
  @@index([status])
  @@index([tripId])
  @@map("consignments")
}

model ConsignmentBag {
  id              String    @id @default(cuid())
  bagNumber       String    @unique @map("bag_number")
  consignmentId   String    @map("consignment_id")

  // Contents
  shipmentCount   Int       @default(0) @map("shipment_count")
  totalWeightKg   Float     @default(0) @map("total_weight_kg")
  shipmentAwbs    String?   @map("shipment_awbs") // JSON array of AWB numbers

  // Seal
  sealNumber      String?   @map("seal_number")

  // Status
  status          String    @default("OPEN") // OPEN, CLOSED, LOADED, UNLOADED

  closedAt        DateTime? @map("closed_at")
  closedBy        String?   @map("closed_by")

  createdAt       DateTime  @default(now()) @map("created_at")

  consignment     Consignment @relation(fields: [consignmentId], references: [id], onDelete: Cascade)

  @@index([consignmentId])
  @@map("consignment_bags")
}

// ============================================
// JOURNEY PLANNING (Multi-leg orchestration)
// ============================================

model JourneyPlan {
  id                    String    @id @default(cuid())

  // Origin/Destination
  originPincode         String    @map("origin_pincode")
  originHubId           String    @map("origin_hub_id")
  destinationPincode    String    @map("destination_pincode")
  destinationHubId      String    @map("destination_hub_id")

  // Route planning
  totalLegs             Int       @map("total_legs")
  estimatedTransitDays  Int       @map("estimated_transit_days")
  estimatedDeliveryDate DateTime? @map("estimated_delivery_date")

  // Fulfillment strategy
  fulfillmentMode       String    @default("OWN_FLEET") @map("fulfillment_mode") // OWN_FLEET, PARTNER, HYBRID
  partnerHandoverLeg    Int?      @map("partner_handover_leg") // Leg index where partner takes over
  partnerId             String?   @map("partner_id")

  // Leg details (JSON for flexibility)
  legs                  String?   // JSON: [{legIndex, type, fromHub, toHub, mode, partnerId}]

  status                String    @default("PLANNED") // PLANNED, ACTIVE, COMPLETED

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  shipments             Shipment[]
  shipmentLegs          ShipmentLeg[]

  @@index([originPincode, destinationPincode])
  @@map("journey_plans")
}

model ShipmentLeg {
  id              String    @id @default(cuid())
  shipmentId      String    @map("shipment_id")
  journeyPlanId   String?   @map("journey_plan_id")

  legIndex        Int       @map("leg_index")
  legType         String    @map("leg_type") // FIRST_MILE, LINE_HAUL, TRANSSHIPMENT, LAST_MILE

  // Endpoints
  fromHubId       String?   @map("from_hub_id")
  toHubId         String?   @map("to_hub_id")
  fromLocation    String?   @map("from_location")
  toLocation      String?   @map("to_location")

  // Fulfillment
  mode            String    @default("OWN_FLEET") // OWN_FLEET, PARTNER
  partnerId       String?   @map("partner_id")
  partnerAwb      String?   @map("partner_awb")

  // Assignment
  tripId          String?   @map("trip_id")
  consignmentId   String?   @map("consignment_id")

  // Status
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, SKIPPED

  // Timestamps
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  // Scan references
  loadScanId      String?   @map("load_scan_id")
  unloadScanId    String?   @map("unload_scan_id")

  createdAt       DateTime  @default(now()) @map("created_at")

  shipment        Shipment    @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  journeyPlan     JourneyPlan? @relation(fields: [journeyPlanId], references: [id])

  @@unique([shipmentId, legIndex])
  @@index([shipmentId])
  @@index([tripId])
  @@index([status])
  @@map("shipment_legs")
}

// ============================================
// PARTNER INTEGRATION
// ============================================

model PartnerZoneMapping {
  id              String   @id @default(cuid())
  partnerId       String   @map("partner_id")

  // Zone definition
  zoneName        String   @map("zone_name")
  zoneType        String   @map("zone_type") // SERVICEABLE, LOW_VOLUME, REMOTE

  // Pincodes covered
  pincodes        String   // JSON array or comma-separated

  // Handover hub (where we hand shipments to this partner)
  handoverHubId   String   @map("handover_hub_id")

  // Rates
  baseRate        Float    @map("base_rate")
  ratePerKg       Float    @map("rate_per_kg")
  minWeight       Float    @default(0.5) @map("min_weight")

  // SLA
  estimatedTatDays Int     @map("estimated_tat_days")

  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([partnerId])
  @@index([handoverHubId])
  @@map("partner_zone_mappings")
}

model PartnerHandover {
  id              String    @id @default(cuid())
  handoverNumber  String    @unique @map("handover_number")

  // Partner
  partnerId       String    @map("partner_id")

  // Hub where handover happens
  handoverHubId   String    @map("handover_hub_id")

  // Shipments being handed over
  shipmentCount   Int       @map("shipment_count")
  totalWeightKg   Float     @map("total_weight_kg")
  shipmentIds     String    @map("shipment_ids") // JSON array

  // Manifest
  manifestNumber  String?   @map("manifest_number")
  manifestUrl     String?   @map("manifest_url")

  // Status
  status          String    @default("PENDING") // PENDING, HANDED_OVER, ACKNOWLEDGED, REJECTED

  // Handover details
  handedOverBy    String?   @map("handed_over_by")
  handedOverAt    DateTime? @map("handed_over_at")
  receivedBy      String?   @map("received_by")
  acknowledgedAt  DateTime? @map("acknowledged_at")

  // Partner reference
  partnerRef      String?   @map("partner_ref")

  remarks         String?

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([partnerId])
  @@index([handoverHubId])
  @@index([status])
  @@map("partner_handovers")
}

// ============================================
// CONTROL TOWER - ETA PREDICTIONS
// ============================================

model ETAPrediction {
  id                    String    @id @default(cuid())
  shipmentId            String    @map("shipment_id")

  // Predicted values
  predictedDeliveryTime DateTime  @map("predicted_delivery_time")
  delayMinutes          Int       @default(0) @map("delay_minutes")

  // Risk assessment
  riskScore             Float     @map("risk_score") // 0-100
  delayRisk             String    @map("delay_risk") // LOW, MEDIUM, HIGH

  // Confidence interval
  confidenceLow         DateTime  @map("confidence_low")
  confidenceHigh        DateTime  @map("confidence_high")
  confidencePercent     Float     @default(80) @map("confidence_percent")

  // Contributing factors (JSON)
  factors               String    // JSON array of { factor, impact, description }

  // Metadata
  calculatedAt          DateTime  @default(now()) @map("calculated_at")
  isActive              Boolean   @default(true) @map("is_active")

  @@index([shipmentId])
  @@index([delayRisk, isActive])
  @@index([calculatedAt])
  @@map("eta_predictions")
}

model HistoricalTransitTime {
  id                    String    @id @default(cuid())

  // Route identification
  originPincode         String    @map("origin_pincode")
  destinationPincode    String    @map("destination_pincode")
  originHubId           String?   @map("origin_hub_id")
  destinationHubId      String?   @map("destination_hub_id")

  // Aggregated metrics (updated daily)
  sampleCount           Int       @map("sample_count")
  avgTransitMinutes     Float     @map("avg_transit_minutes")
  medianTransitMinutes  Float     @default(0) @map("median_transit_minutes")
  stdDevMinutes         Float     @map("std_dev_minutes")
  percentile10          Float     @default(0) @map("percentile_10")
  percentile90          Float     @map("percentile_90")
  onTimePercentage      Float     @map("on_time_percentage")

  // Time period
  periodStart           DateTime  @map("period_start")
  periodEnd             DateTime? @map("period_end")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([originPincode, destinationPincode, periodStart])
  @@index([originHubId, destinationHubId])
  @@map("historical_transit_times")
}

model HubCongestionSnapshot {
  id                    String    @id @default(cuid())
  hubId                 String    @map("hub_id")

  // Current state
  shipmentsInHub        Int       @map("shipments_in_hub")
  sortingCapacity       Int       @map("sorting_capacity")
  utilizationPercent    Float     @map("utilization_percent")

  // Processing metrics
  avgProcessingMinutes  Float     @default(0) @map("avg_processing_minutes")
  pendingOutscans       Int       @default(0) @map("pending_outscans")

  snapshotTime          DateTime  @default(now()) @map("snapshot_time")

  @@index([hubId, snapshotTime])
  @@map("hub_congestion_snapshots")
}

model ControlTowerAlert {
  id                    String    @id @default(cuid())

  // Alert type
  alertType             String    @map("alert_type") // DELAY_RISK, HUB_CONGESTION, VEHICLE_DELAY, SLA_BREACH, SHIPMENT_STUCK
  severity              String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL

  // Related entities
  shipmentId            String?   @map("shipment_id")
  tripId                String?   @map("trip_id")
  hubId                 String?   @map("hub_id")

  // Alert details
  title                 String
  description           String
  metrics               String?   // JSON with relevant metrics

  // Status
  status                String    @default("ACTIVE") // ACTIVE, ACKNOWLEDGED, RESOLVED, EXPIRED
  acknowledgedBy        String?   @map("acknowledged_by")
  acknowledgedAt        DateTime? @map("acknowledged_at")
  resolvedAt            DateTime? @map("resolved_at")

  createdAt             DateTime  @default(now()) @map("created_at")
  expiresAt             DateTime? @map("expires_at")

  @@index([alertType, status])
  @@index([severity, status])
  @@index([createdAt])
  @@map("control_tower_alerts")
}

// ============================================
// COD MANAGEMENT
// ============================================

// Track COD collection at delivery level
model CODCollection {
  id                String    @id @default(cuid())

  // Link to shipment/order
  shipmentId        String?   @map("shipment_id")
  orderId           String?   @map("order_id")
  awbNumber         String    @map("awb_number")

  // Collection details
  expectedAmount    Float     @map("expected_amount")
  collectedAmount   Float     @map("collected_amount")
  shortageAmount    Float     @default(0) @map("shortage_amount")

  // Payment mode
  paymentMode       String    @map("payment_mode") // CASH, UPI, CARD, CHEQUE
  paymentRef        String?   @map("payment_ref") // UPI ref, card last 4, cheque number

  // Collector (driver/agent)
  collectedById     String    @map("collected_by_id")
  collectedByName   String    @map("collected_by_name")
  collectedByType   String    @map("collected_by_type") // DRIVER, DELIVERY_AGENT, PARTNER

  // Location & time
  collectionTime    DateTime  @map("collection_time")
  latitude          Float?
  longitude         Float?

  // Status
  status            String    @default("COLLECTED") // COLLECTED, DEPOSITED, RECONCILED, DISPUTED

  // Deposit tracking
  depositId         String?   @map("deposit_id")
  depositedAt       DateTime? @map("deposited_at")

  // Reconciliation
  isReconciled      Boolean   @default(false) @map("is_reconciled")
  reconciledAt      DateTime? @map("reconciled_at")
  remittanceId      String?   @map("remittance_id")

  // Notes
  remarks           String?

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  deposit           CODDeposit?   @relation(fields: [depositId], references: [id])
  remittance        CODRemittance? @relation(fields: [remittanceId], references: [id])

  @@index([awbNumber])
  @@index([collectedById, status])
  @@index([status, createdAt])
  @@index([depositId])
  @@map("cod_collections")
}

// Driver/Agent deposits cash at hub
model CODDeposit {
  id                String    @id @default(cuid())
  depositNumber     String    @unique @map("deposit_number")

  // Depositor
  depositedById     String    @map("deposited_by_id")
  depositedByName   String    @map("deposited_by_name")
  depositedByType   String    @map("deposited_by_type") // DRIVER, DELIVERY_AGENT

  // Receiver at hub
  receivedById      String    @map("received_by_id")
  receivedByName    String    @map("received_by_name")
  hubId             String    @map("hub_id")

  // Amount details
  expectedAmount    Float     @map("expected_amount") // Sum of all COD collections
  depositedAmount   Float     @map("deposited_amount")
  shortageAmount    Float     @default(0) @map("shortage_amount")
  excessAmount      Float     @default(0) @map("excess_amount")

  // Collection count
  collectionCount   Int       @map("collection_count")

  // Breakdown by payment mode
  cashAmount        Float     @default(0) @map("cash_amount")
  upiAmount         Float     @default(0) @map("upi_amount")
  cardAmount        Float     @default(0) @map("card_amount")
  chequeAmount      Float     @default(0) @map("cheque_amount")

  // Status
  status            String    @default("PENDING") // PENDING, VERIFIED, DISCREPANCY, RESOLVED

  // Verification
  verifiedAt        DateTime? @map("verified_at")
  verifiedBy        String?   @map("verified_by")

  // Discrepancy handling
  discrepancyReason String?   @map("discrepancy_reason")
  discrepancyAction String?   @map("discrepancy_action") // ADJUST, RECOVER, WAIVE

  // Bank deposit (if cash)
  bankDepositRef    String?   @map("bank_deposit_ref")
  bankDepositDate   DateTime? @map("bank_deposit_date")

  depositTime       DateTime  @map("deposit_time")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  collections       CODCollection[]

  @@index([depositedById])
  @@index([hubId, depositTime])
  @@index([status])
  @@map("cod_deposits")
}

// Client COD Remittance (payment to clients)
model CODRemittance {
  id                  String    @id @default(cuid())
  remittanceNumber    String    @unique @map("remittance_number")

  // Client
  clientId            String    @map("client_id")

  // Period
  periodStart         DateTime  @map("period_start")
  periodEnd           DateTime  @map("period_end")

  // Amount breakdown
  grossCodCollected   Float     @map("gross_cod_collected")
  deductions          Float     @default(0) // Freight, COD charges, returns
  netRemittance       Float     @map("net_remittance")

  // Deduction details (JSON)
  deductionDetails    String?   @map("deduction_details") // {freightCharges, codFee, rtoCharges, adjustments}

  // Shipment details
  shipmentCount       Int       @map("shipment_count")
  deliveredCount      Int       @map("delivered_count")
  rtoCount            Int       @default(0) @map("rto_count")

  // Status
  status              String    @default("PENDING") // PENDING, APPROVED, PROCESSING, PAID, FAILED

  // Approval
  approvedBy          String?   @map("approved_by")
  approvedAt          DateTime? @map("approved_at")

  // Payment
  paymentMode         String?   @map("payment_mode") // NEFT, RTGS, IMPS, UPI
  paymentRef          String?   @map("payment_ref")
  paidAt              DateTime? @map("paid_at")

  // Bank details
  bankAccountNumber   String?   @map("bank_account_number")
  bankIfsc            String?   @map("bank_ifsc")
  bankName            String?   @map("bank_name")

  // UTR details
  utrNumber           String?   @map("utr_number")

  // Documents
  invoiceUrl          String?   @map("invoice_url")

  remarks             String?

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  collections         CODCollection[]

  @@index([clientId, status])
  @@index([periodStart, periodEnd])
  @@index([status])
  @@map("cod_remittances")
}

// Daily COD Summary per driver/hub
model CODDailySummary {
  id                String    @id @default(cuid())

  summaryDate       DateTime  @map("summary_date")

  // Entity type
  entityType        String    @map("entity_type") // DRIVER, HUB, CLIENT
  entityId          String    @map("entity_id")
  entityName        String    @map("entity_name")

  // Totals
  totalCollections  Int       @map("total_collections")
  totalExpected     Float     @map("total_expected")
  totalCollected    Float     @map("total_collected")
  totalShortage     Float     @default(0) @map("total_shortage")

  // By payment mode
  cashCollected     Float     @default(0) @map("cash_collected")
  upiCollected      Float     @default(0) @map("upi_collected")
  cardCollected     Float     @default(0) @map("card_collected")

  // Deposit status
  totalDeposited    Float     @default(0) @map("total_deposited")
  pendingDeposit    Float     @default(0) @map("pending_deposit")

  // Remittance status (for clients)
  totalRemitted     Float     @default(0) @map("total_remitted")
  pendingRemittance Float     @default(0) @map("pending_remittance")

  createdAt         DateTime  @default(now()) @map("created_at")

  @@unique([summaryDate, entityType, entityId])
  @@index([entityType, entityId])
  @@index([summaryDate])
  @@map("cod_daily_summaries")
}

// COD Ledger for complete audit trail
model CODLedger {
  id                String    @id @default(cuid())

  // Transaction type
  transactionType   String    @map("transaction_type") // COLLECTION, DEPOSIT, REMITTANCE, ADJUSTMENT, RECOVERY

  // Reference
  referenceType     String    @map("reference_type") // COLLECTION, DEPOSIT, REMITTANCE
  referenceId       String    @map("reference_id")

  // Entities
  clientId          String?   @map("client_id")
  driverId          String?   @map("driver_id")
  hubId             String?   @map("hub_id")

  // Amount
  amount            Float
  runningBalance    Float?    @map("running_balance")

  // Direction
  direction         String    // CREDIT, DEBIT

  // Description
  description       String
  awbNumber         String?   @map("awb_number")

  transactionTime   DateTime  @map("transaction_time")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([clientId, transactionTime])
  @@index([driverId, transactionTime])
  @@index([hubId, transactionTime])
  @@index([transactionType])
  @@map("cod_ledger")
}

// ============================================
// NDR (NON-DELIVERY REPORT) MANAGEMENT
// ============================================

// Main NDR record - created when delivery fails
model NDRReport {
  id                  String    @id @default(cuid())
  ndrNumber           String    @unique @map("ndr_number")

  // Shipment reference
  shipmentId          String    @map("shipment_id")
  awbNumber           String    @map("awb_number")
  clientId            String    @map("client_id")

  // Delivery attempt details
  attemptNumber       Int       @map("attempt_number")
  attemptDate         DateTime  @map("attempt_date")
  attemptTime         String?   @map("attempt_time")

  // Driver/Agent who attempted
  attemptedById       String    @map("attempted_by_id")
  attemptedByName     String    @map("attempted_by_name")

  // Failure reason
  failureReason       String    @map("failure_reason") // CUSTOMER_UNAVAILABLE, WRONG_ADDRESS, REFUSED, INCOMPLETE_ADDRESS, CUSTOMER_RESCHEDULED, CUSTOMER_UNREACHABLE, PREMISES_CLOSED, COD_NOT_READY, OTHER
  failureSubReason    String?   @map("failure_sub_reason")
  failureRemarks      String?   @map("failure_remarks")

  // Location of attempt
  attemptLatitude     Float?    @map("attempt_latitude")
  attemptLongitude    Float?    @map("attempt_longitude")
  attemptLocation     String?   @map("attempt_location")

  // Customer contact from shipment
  customerName        String    @map("customer_name")
  customerPhone       String    @map("customer_phone")
  customerAltPhone    String?   @map("customer_alt_phone")
  deliveryAddress     String    @map("delivery_address")
  deliveryPincode     String    @map("delivery_pincode")

  // NDR Status
  status              String    @default("OPEN") // OPEN, CUSTOMER_CONTACTED, ACTION_TAKEN, REATTEMPT_SCHEDULED, RTO_INITIATED, DELIVERED, CLOSED

  // Priority based on SLA/value
  priority            String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL

  // Customer response
  customerContacted   Boolean   @default(false) @map("customer_contacted")
  customerResponse    String?   @map("customer_response") // REATTEMPT, ADDRESS_CHANGE, RESCHEDULE, CANCEL, NO_RESPONSE
  customerResponseAt  DateTime? @map("customer_response_at")

  // Resolution action
  actionTaken         String?   @map("action_taken") // REATTEMPT, ADDRESS_CORRECTED, RESCHEDULED, RTO, DELIVERED
  actionDetails       String?   @map("action_details")
  actionTakenAt       DateTime? @map("action_taken_at")
  actionTakenBy       String?   @map("action_taken_by")

  // Address correction
  correctedAddress    String?   @map("corrected_address")
  correctedPincode    String?   @map("corrected_pincode")
  correctedPhone      String?   @map("corrected_phone")
  correctedLandmark   String?   @map("corrected_landmark")

  // Rescheduling
  rescheduledDate     DateTime? @map("rescheduled_date")
  preferredTimeSlot   String?   @map("preferred_time_slot")

  // Resolution
  isResolved          Boolean   @default(false) @map("is_resolved")
  resolvedAt          DateTime? @map("resolved_at")
  resolutionType      String?   @map("resolution_type") // DELIVERED, RTO, CANCELLED

  // Aging
  agingHours          Int       @default(0) @map("aging_hours")
  slaBreached         Boolean   @default(false) @map("sla_breached")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  callLogs            NDRCallLog[]
  actions             NDRAction[]

  @@index([shipmentId])
  @@index([awbNumber])
  @@index([clientId, status])
  @@index([status, priority])
  @@index([attemptDate])
  @@index([isResolved])
  @@map("ndr_reports")
}

// Call/Contact logs for NDR follow-up
model NDRCallLog {
  id                String    @id @default(cuid())
  ndrReportId       String    @map("ndr_report_id")

  // Call details
  callType          String    @map("call_type") // OUTBOUND, INBOUND, SMS, WHATSAPP, IVR
  callTime          DateTime  @map("call_time")
  callDuration      Int?      @map("call_duration") // in seconds

  // Caller
  calledById        String?   @map("called_by_id")
  calledByName      String?   @map("called_by_name")
  calledByType      String?   @map("called_by_type") // AGENT, SYSTEM, IVR

  // Contact
  contactNumber     String    @map("contact_number")
  contactName       String?   @map("contact_name")

  // Outcome
  callStatus        String    @map("call_status") // CONNECTED, NO_ANSWER, BUSY, SWITCHED_OFF, WRONG_NUMBER, DISCONNECTED
  callOutcome       String?   @map("call_outcome") // REATTEMPT_REQUESTED, ADDRESS_UPDATED, RESCHEDULED, CANCEL_REQUESTED, CALLBACK_REQUESTED, NO_ACTION

  // Customer response captured
  customerResponse  String?   @map("customer_response")
  newAddress        String?   @map("new_address")
  newPhone          String?   @map("new_phone")
  preferredDate     DateTime? @map("preferred_date")
  preferredSlot     String?   @map("preferred_slot")

  remarks           String?

  createdAt         DateTime  @default(now()) @map("created_at")

  ndrReport         NDRReport @relation(fields: [ndrReportId], references: [id], onDelete: Cascade)

  @@index([ndrReportId, callTime])
  @@index([callStatus])
  @@map("ndr_call_logs")
}

// NDR Action history
model NDRAction {
  id                String    @id @default(cuid())
  ndrReportId       String    @map("ndr_report_id")

  // Action details
  actionType        String    @map("action_type") // REATTEMPT_SCHEDULED, ADDRESS_UPDATED, PHONE_UPDATED, ESCALATED, RTO_INITIATED, DELIVERED, CLOSED
  actionDetails     String?   @map("action_details")

  // Before/After values
  previousStatus    String    @map("previous_status")
  newStatus         String    @map("new_status")

  // Changes made
  changesJson       String?   @map("changes_json") // JSON of what changed

  // Performed by
  performedById     String    @map("performed_by_id")
  performedByName   String    @map("performed_by_name")
  performedByType   String    @map("performed_by_type") // AGENT, CUSTOMER, SYSTEM, DRIVER

  remarks           String?
  actionTime        DateTime  @map("action_time")
  createdAt         DateTime  @default(now()) @map("created_at")

  ndrReport         NDRReport @relation(fields: [ndrReportId], references: [id], onDelete: Cascade)

  @@index([ndrReportId, actionTime])
  @@index([actionType])
  @@map("ndr_actions")
}

// NDR Daily Summary
model NDRDailySummary {
  id                String    @id @default(cuid())

  summaryDate       DateTime  @map("summary_date")
  entityType        String    @map("entity_type") // HUB, CLIENT, DRIVER
  entityId          String    @map("entity_id")
  entityName        String    @map("entity_name")

  // Counts
  totalNdrs         Int       @map("total_ndrs")
  openNdrs          Int       @map("open_ndrs")
  contactedNdrs     Int       @map("contacted_ndrs")
  resolvedNdrs      Int       @map("resolved_ndrs")
  rtoInitiated      Int       @map("rto_initiated")
  delivered         Int       @default(0)

  // By reason
  customerUnavailable Int     @default(0) @map("customer_unavailable")
  wrongAddress        Int     @default(0) @map("wrong_address")
  refused             Int     @default(0) @map("refused")
  otherReasons        Int     @default(0) @map("other_reasons")

  // Resolution rate
  resolutionRate    Float     @default(0) @map("resolution_rate")
  avgResolutionHours Float    @default(0) @map("avg_resolution_hours")

  createdAt         DateTime  @default(now()) @map("created_at")

  @@unique([summaryDate, entityType, entityId])
  @@index([entityType, entityId])
  @@index([summaryDate])
  @@map("ndr_daily_summaries")
}

// ============================================
// POD (PROOF OF DELIVERY) MANAGEMENT
// ============================================

// Detailed POD capture record
model PODCapture {
  id                String    @id @default(cuid())

  // Link to shipment
  shipmentId        String    @unique @map("shipment_id")
  awbNumber         String    @map("awb_number")
  clientId          String    @map("client_id")

  // Receiver details
  receiverName      String    @map("receiver_name")
  receiverRelation  String?   @map("receiver_relation") // SELF, FAMILY, SECURITY, COLLEAGUE, NEIGHBOR
  receiverIdType    String?   @map("receiver_id_type") // AADHAAR, PAN, DRIVING_LICENSE, VOTER_ID
  receiverIdNumber  String?   @map("receiver_id_number") // Last 4 digits only

  // Capture method
  captureMethod     String    @map("capture_method") // SIGNATURE, PHOTO, OTP, QR_CODE, BIOMETRIC

  // OTP verification
  otpSent           Boolean   @default(false) @map("otp_sent")
  otpVerified       Boolean   @default(false) @map("otp_verified")
  otpPhone          String?   @map("otp_phone")

  // Digital signature
  signatureData     String?   @map("signature_data") // Base64 encoded signature
  signatureUrl      String?   @map("signature_url") // S3/storage URL

  // Photos
  deliveryPhotoUrl  String?   @map("delivery_photo_url") // Photo of package at delivery
  receiverPhotoUrl  String?   @map("receiver_photo_url") // Photo of receiver (optional)
  idProofPhotoUrl   String?   @map("id_proof_photo_url") // ID proof photo

  // Location at delivery
  deliveryLatitude  Float?    @map("delivery_latitude")
  deliveryLongitude Float?    @map("delivery_longitude")
  deliveryAddress   String?   @map("delivery_address") // Captured from GPS
  geoAccuracyMeters Float?    @map("geo_accuracy_meters")

  // Delivery agent/driver
  deliveredById     String    @map("delivered_by_id")
  deliveredByName   String    @map("delivered_by_name")
  deliveredByType   String    @map("delivered_by_type") // DRIVER, DELIVERY_AGENT, PARTNER

  // Timestamps
  capturedAt        DateTime  @map("captured_at")
  syncedAt          DateTime? @map("synced_at") // When synced from mobile

  // Verification status
  verificationStatus String   @default("PENDING") @map("verification_status") // PENDING, VERIFIED, DISPUTED, REJECTED
  verifiedAt        DateTime? @map("verified_at")
  verifiedBy        String?   @map("verified_by")

  // Quality score (auto-calculated)
  qualityScore      Int       @default(0) @map("quality_score") // 0-100
  qualityFlags      String?   @map("quality_flags") // JSON array of flags

  // Dispute handling
  isDisputed        Boolean   @default(false) @map("is_disputed")
  disputeReason     String?   @map("dispute_reason")
  disputeRaisedAt   DateTime? @map("dispute_raised_at")
  disputeRaisedBy   String?   @map("dispute_raised_by")
  disputeResolvedAt DateTime? @map("dispute_resolved_at")
  disputeResolution String?   @map("dispute_resolution")

  // Additional notes
  deliveryNotes     String?   @map("delivery_notes")
  customerFeedback  String?   @map("customer_feedback")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([awbNumber])
  @@index([clientId, capturedAt])
  @@index([verificationStatus])
  @@index([isDisputed])
  @@index([capturedAt])
  @@map("pod_captures")
}

// POD Quality Audit Trail
model PODAudit {
  id              String    @id @default(cuid())
  podCaptureId    String    @map("pod_capture_id")

  // Action
  action          String    // CREATED, VERIFIED, DISPUTED, RESOLVED, REJECTED, QUALITY_CHECKED
  previousStatus  String?   @map("previous_status")
  newStatus       String?   @map("new_status")

  // Performed by
  performedById   String    @map("performed_by_id")
  performedByName String    @map("performed_by_name")

  // Details
  details         String?   // JSON with action details
  remarks         String?

  createdAt       DateTime  @default(now()) @map("created_at")

  @@index([podCaptureId, createdAt])
  @@index([action])
  @@map("pod_audits")
}

// RTO (Return to Origin) tracking
model RTOShipment {
  id                String    @id @default(cuid())
  rtoNumber         String    @unique @map("rto_number")

  // Original shipment
  shipmentId        String    @unique @map("shipment_id")
  awbNumber         String    @map("awb_number")
  clientId          String    @map("client_id")

  // NDR reference
  ndrReportId       String?   @map("ndr_report_id")

  // RTO reason
  rtoReason         String    @map("rto_reason") // MAX_ATTEMPTS_EXCEEDED, CUSTOMER_REFUSED, CUSTOMER_CANCELLED, UNDELIVERABLE_ADDRESS, DAMAGED, OTHER
  rtoRemarks        String?   @map("rto_remarks")

  // RTO initiated
  initiatedAt       DateTime  @map("initiated_at")
  initiatedBy       String    @map("initiated_by")
  initiatedFromHub  String    @map("initiated_from_hub")

  // Return journey
  returnTripId      String?   @map("return_trip_id")
  currentStatus     String    @default("INITIATED") @map("current_status") // INITIATED, IN_TRANSIT, ARRIVED_AT_ORIGIN, DELIVERED_TO_CLIENT

  // Delivery to client
  deliveredAt       DateTime? @map("delivered_at")
  receivedBy        String?   @map("received_by")
  podPhoto          String?   @map("pod_photo")

  // Cost allocation
  forwardFreight    Float     @default(0) @map("forward_freight")
  returnFreight     Float     @default(0) @map("return_freight")
  totalRtoCost      Float     @default(0) @map("total_rto_cost")
  chargedToClient   Boolean   @default(true) @map("charged_to_client")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([shipmentId])
  @@index([awbNumber])
  @@index([clientId, currentStatus])
  @@index([currentStatus])
  @@map("rto_shipments")
}

// ============================================
// BILLING & INVOICING
// ============================================

// Rate Card - Client-specific pricing configuration
model RateCard {
  id                String    @id @default(cuid())

  clientId          String    @map("client_id")
  clientName        String    @map("client_name")

  // Rate card details
  name              String
  description       String?

  // Validity
  effectiveFrom     DateTime  @map("effective_from")
  effectiveTo       DateTime? @map("effective_to")
  isActive          Boolean   @default(true) @map("is_active")

  // Base charges
  baseFreightPerKg  Float     @default(0) @map("base_freight_per_kg")
  minFreight        Float     @default(0) @map("min_freight")

  // COD charges
  codChargePercent  Float     @default(0) @map("cod_charge_percent")
  codMinCharge      Float     @default(0) @map("cod_min_charge")

  // Fuel surcharge
  fuelSurchargePercent Float  @default(0) @map("fuel_surcharge_percent")

  // Other charges
  handlingChargePerShipment Float @default(0) @map("handling_charge_per_shipment")
  packagingCharge   Float     @default(0) @map("packaging_charge")
  insurancePercent  Float     @default(0) @map("insurance_percent")

  // RTO charges
  rtoChargePercent  Float     @default(100) @map("rto_charge_percent") // % of forward freight

  // GST
  gstPercent        Float     @default(18) @map("gst_percent")

  // Billing cycle
  billingCycle      String    @default("WEEKLY") @map("billing_cycle") // DAILY, WEEKLY, BIWEEKLY, MONTHLY
  paymentTermsDays  Int       @default(7) @map("payment_terms_days")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  zoneRates         ZoneRate[]
  weightSlabs       WeightSlab[]

  @@index([clientId, isActive])
  @@map("rate_cards")
}

// Zone-based pricing
model ZoneRate {
  id                String    @id @default(cuid())
  rateCardId        String    @map("rate_card_id")

  // Zone definition
  zoneName          String    @map("zone_name") // LOCAL, REGIONAL, METRO, REST_OF_INDIA, SPECIAL
  zoneCode          String    @map("zone_code")

  // Zone-specific rates
  baseRatePerKg     Float     @map("base_rate_per_kg")
  additionalPerKg   Float     @map("additional_per_kg")
  minWeight         Float     @default(0.5) @map("min_weight")

  // Transit time
  expectedTatDays   Int       @map("expected_tat_days")

  createdAt         DateTime  @default(now()) @map("created_at")

  rateCard          RateCard  @relation(fields: [rateCardId], references: [id], onDelete: Cascade)

  @@unique([rateCardId, zoneCode])
  @@map("zone_rates")
}

// Weight-based pricing slabs
model WeightSlab {
  id                String    @id @default(cuid())
  rateCardId        String    @map("rate_card_id")

  // Weight range
  fromWeight        Float     @map("from_weight")
  toWeight          Float     @map("to_weight")

  // Slab-specific rate
  ratePerKg         Float     @map("rate_per_kg")
  flatRate          Float?    @map("flat_rate") // If flat rate instead of per kg

  createdAt         DateTime  @default(now()) @map("created_at")

  rateCard          RateCard  @relation(fields: [rateCardId], references: [id], onDelete: Cascade)

  @@index([rateCardId, fromWeight])
  @@map("weight_slabs")
}

// Invoice Line Items
model InvoiceLineItem {
  id                String    @id @default(cuid())
  invoiceId         String    @map("invoice_id")

  // Shipment reference
  shipmentId        String?   @map("shipment_id")
  awbNumber         String?   @map("awb_number")

  // Item details
  description       String
  itemType          String    @map("item_type") // FREIGHT, COD_CHARGE, FUEL_SURCHARGE, HANDLING, RTO_CHARGE, OTHER

  // Quantity and rate
  quantity          Float     @default(1)
  rate              Float
  amount            Float

  // Tax
  taxPercent        Float     @default(0) @map("tax_percent")
  taxAmount         Float     @default(0) @map("tax_amount")
  totalAmount       Float     @map("total_amount")

  // Additional info
  weight            Float?
  zone              String?

  createdAt         DateTime  @default(now()) @map("created_at")

  invoice           Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([shipmentId])
  @@map("invoice_line_items")
}

// Payment records
model Payment {
  id                String    @id @default(cuid())
  paymentNumber     String    @unique @map("payment_number")

  // Invoice reference
  invoiceId         String    @map("invoice_id")

  // Client
  clientId          String    @map("client_id")

  // Payment details
  amount            Float
  paymentDate       DateTime  @map("payment_date")
  paymentMode       String    @map("payment_mode") // BANK_TRANSFER, CHEQUE, UPI, CASH, NEFT, RTGS

  // Bank details
  bankName          String?   @map("bank_name")
  transactionRef    String?   @map("transaction_ref")
  chequeNumber      String?   @map("cheque_number")
  chequeDate        DateTime? @map("cheque_date")

  // Status
  status            String    @default("PENDING") // PENDING, CONFIRMED, BOUNCED, REVERSED
  confirmedAt       DateTime? @map("confirmed_at")
  confirmedBy       String?   @map("confirmed_by")

  remarks           String?

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  invoice           Invoice   @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([clientId, paymentDate])
  @@map("payments")
}

// Credit Notes for adjustments/refunds
model CreditNote {
  id                String    @id @default(cuid())
  creditNoteNumber  String    @unique @map("credit_note_number")

  // Reference
  invoiceId         String    @map("invoice_id")
  clientId          String    @map("client_id")

  // Reason
  reason            String    // RATE_DIFFERENCE, SERVICE_ISSUE, OVERCHARGE, DAMAGE, OTHER
  description       String

  // Amount
  amount            Float
  gstAmount         Float     @default(0) @map("gst_amount")
  totalAmount       Float     @map("total_amount")

  // Status
  status            String    @default("PENDING") // PENDING, APPROVED, APPLIED, REJECTED
  approvedBy        String?   @map("approved_by")
  approvedAt        DateTime? @map("approved_at")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  invoice           Invoice   @relation(fields: [invoiceId], references: [id])

  @@index([invoiceId])
  @@index([clientId])
  @@map("credit_notes")
}

// Debit Notes for additional charges
model DebitNote {
  id                String    @id @default(cuid())
  debitNoteNumber   String    @unique @map("debit_note_number")

  // Reference
  clientId          String    @map("client_id")
  invoiceId         String?   @map("invoice_id") // Optional, can be standalone

  // Reason
  reason            String    // ADDITIONAL_CHARGES, PENALTY, RATE_REVISION, OTHER
  description       String

  // Amount
  amount            Float
  gstAmount         Float     @default(0) @map("gst_amount")
  totalAmount       Float     @map("total_amount")

  // Status
  status            String    @default("PENDING") // PENDING, APPROVED, INVOICED, REJECTED
  approvedBy        String?   @map("approved_by")
  approvedAt        DateTime? @map("approved_at")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([clientId])
  @@map("debit_notes")
}

// Client Ledger - Running balance
model ClientLedger {
  id                String    @id @default(cuid())

  clientId          String    @map("client_id")

  // Transaction
  transactionDate   DateTime  @map("transaction_date")
  transactionType   String    @map("transaction_type") // INVOICE, PAYMENT, CREDIT_NOTE, DEBIT_NOTE, OPENING_BALANCE
  referenceType     String    @map("reference_type")
  referenceId       String    @map("reference_id")
  referenceNumber   String    @map("reference_number")

  // Amount
  debitAmount       Float     @default(0) @map("debit_amount")
  creditAmount      Float     @default(0) @map("credit_amount")
  balanceAmount     Float     @map("balance_amount") // Running balance

  description       String

  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([clientId, transactionDate])
  @@index([referenceType, referenceId])
  @@map("client_ledger")
}

// ============================================
// AUTOMATED COMMUNICATIONS
// ============================================

// Communication Templates
model NotificationTemplate {
  id                String    @id @default(cuid())

  // Template identification
  code              String    @unique // e.g., SHIPMENT_BOOKED, OUT_FOR_DELIVERY, DELIVERED
  name              String
  description       String?

  // Channel and type
  channel           String    // SMS, WHATSAPP, EMAIL, PUSH
  triggerEvent      String    @map("trigger_event") // Event that triggers this notification

  // Recipients
  recipientType     String    @map("recipient_type") // CONSIGNEE, SHIPPER, CLIENT, DRIVER, AGENT

  // Template content
  subject           String?   // For EMAIL
  body              String    // Message body with placeholders {{awb}}, {{status}}, etc.
  bodyHtml          String?   @map("body_html") // HTML body for email

  // Settings
  isActive          Boolean   @default(true) @map("is_active")
  isClientSpecific  Boolean   @default(false) @map("is_client_specific")
  clientId          String?   @map("client_id") // If client-specific

  // Variables available
  availableVars     String    @map("available_vars") // JSON array of available placeholders

  // Timing
  delayMinutes      Int       @default(0) @map("delay_minutes") // Delay before sending
  scheduledTime     String?   @map("scheduled_time") // HH:MM if time-specific

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([channel, triggerEvent])
  @@index([isActive])
  @@map("notification_templates")
}

// Notification Queue - Pending notifications
model NotificationQueue {
  id                String    @id @default(cuid())

  // Template
  templateId        String    @map("template_id")
  templateCode      String    @map("template_code")
  channel           String

  // Recipient
  recipientType     String    @map("recipient_type")
  recipientPhone    String?   @map("recipient_phone")
  recipientEmail    String?   @map("recipient_email")
  recipientName     String?   @map("recipient_name")

  // Reference
  shipmentId        String?   @map("shipment_id")
  awbNumber         String?   @map("awb_number")
  clientId          String?   @map("client_id")

  // Content (resolved from template)
  subject           String?
  messageBody       String    @map("message_body")

  // Scheduling
  scheduledAt       DateTime  @map("scheduled_at")
  priority          Int       @default(1) // 1=Normal, 2=High, 3=Urgent

  // Status
  status            String    @default("PENDING") // PENDING, PROCESSING, SENT, FAILED, CANCELLED
  attempts          Int       @default(0)
  maxAttempts       Int       @default(3) @map("max_attempts")

  // Processing
  processedAt       DateTime? @map("processed_at")
  failureReason     String?   @map("failure_reason")
  providerRef       String?   @map("provider_ref") // External provider reference

  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([status, scheduledAt])
  @@index([shipmentId])
  @@index([channel, status])
  @@map("notification_queue")
}

// Notification Log - Sent notifications
model NotificationLog {
  id                String    @id @default(cuid())

  // Template reference
  templateId        String?   @map("template_id")
  templateCode      String?   @map("template_code")

  // Channel
  channel           String    // SMS, WHATSAPP, EMAIL, PUSH

  // Recipient details
  recipientType     String    @map("recipient_type")
  recipientPhone    String?   @map("recipient_phone")
  recipientEmail    String?   @map("recipient_email")
  recipientName     String?   @map("recipient_name")

  // Reference
  shipmentId        String?   @map("shipment_id")
  awbNumber         String?   @map("awb_number")
  clientId          String?   @map("client_id")

  // Content sent
  subject           String?
  messageBody       String    @map("message_body")

  // Delivery status
  status            String    @default("SENT") // SENT, DELIVERED, READ, FAILED, BOUNCED
  deliveredAt       DateTime? @map("delivered_at")
  readAt            DateTime? @map("read_at")

  // Provider details
  providerName      String?   @map("provider_name") // MSG91, TWILIO, SENDGRID
  providerRef       String?   @map("provider_ref")
  providerResponse  String?   @map("provider_response") // JSON response

  // Cost
  costCredits       Float     @default(0) @map("cost_credits")

  // Failure info
  failureReason     String?   @map("failure_reason")

  sentAt            DateTime  @map("sent_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  @@index([shipmentId, sentAt])
  @@index([clientId, sentAt])
  @@index([channel, status])
  @@index([sentAt])
  @@map("notification_logs")
}

// Notification Preferences - Client/User preferences
model NotificationPreference {
  id                String    @id @default(cuid())

  // Owner
  ownerType         String    @map("owner_type") // CLIENT, USER
  ownerId           String    @map("owner_id")

  // Channels enabled
  smsEnabled        Boolean   @default(true) @map("sms_enabled")
  whatsappEnabled   Boolean   @default(true) @map("whatsapp_enabled")
  emailEnabled      Boolean   @default(true) @map("email_enabled")
  pushEnabled       Boolean   @default(true) @map("push_enabled")

  // Event preferences (JSON - which events to notify)
  enabledEvents     String    @map("enabled_events") // JSON array

  // Quiet hours
  quietHoursStart   String?   @map("quiet_hours_start") // HH:MM
  quietHoursEnd     String?   @map("quiet_hours_end") // HH:MM

  // Language
  preferredLanguage String    @default("en") @map("preferred_language")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@unique([ownerType, ownerId])
  @@map("notification_preferences")
}

// =============================================================================
// CUSTOMER FEEDBACK & NPS
// =============================================================================

// Delivery Feedback - Customer ratings and reviews
model DeliveryFeedback {
  id                String    @id @default(cuid())

  // Reference
  shipmentId        String    @unique @map("shipment_id")
  awbNumber         String    @map("awb_number")
  clientId          String    @map("client_id")

  // Customer info
  customerName      String?   @map("customer_name")
  customerPhone     String?   @map("customer_phone")
  customerEmail     String?   @map("customer_email")

  // Ratings (1-5 stars)
  overallRating     Int       @map("overall_rating") // 1-5
  deliverySpeedRating Int?    @map("delivery_speed_rating") // 1-5
  packagingRating   Int?      @map("packaging_rating") // 1-5
  courierBehaviorRating Int?  @map("courier_behavior_rating") // 1-5

  // NPS Score (0-10)
  npsScore          Int?      @map("nps_score") // 0-10: How likely to recommend?

  // Feedback text
  feedbackText      String?   @map("feedback_text")

  // Categories (JSON array of selected issues/compliments)
  categories        String?   // JSON: ["FAST_DELIVERY", "GOOD_PACKAGING", "FRIENDLY_COURIER"]

  // Sentiment (calculated)
  sentiment         String?   // POSITIVE, NEUTRAL, NEGATIVE

  // Source
  source            String    @default("TRACKING_PAGE") // TRACKING_PAGE, SMS_LINK, APP, CALL

  // Response handling
  requiresFollowUp  Boolean   @default(false) @map("requires_follow_up")
  followUpStatus    String?   @map("follow_up_status") // PENDING, CONTACTED, RESOLVED
  followUpNotes     String?   @map("follow_up_notes")
  resolvedBy        String?   @map("resolved_by")
  resolvedAt        DateTime? @map("resolved_at")

  // Timestamps
  submittedAt       DateTime  @default(now()) @map("submitted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([shipmentId])
  @@index([clientId, submittedAt])
  @@index([overallRating])
  @@index([npsScore])
  @@index([requiresFollowUp, followUpStatus])
  @@map("delivery_feedback")
}

// =============================================================================
// SLOT-BASED DELIVERY
// =============================================================================

// Delivery Slot Configuration - Hub-level slot definitions
model DeliverySlotConfig {
  id                String    @id @default(cuid())

  hubId             String    @map("hub_id")
  name              String    // e.g., "Morning Slot", "Afternoon Slot"

  // Time window
  startTime         String    @map("start_time") // HH:MM format
  endTime           String    @map("end_time") // HH:MM format

  // Days available (JSON array: ["MONDAY", "TUESDAY", ...])
  availableDays     String    @map("available_days")

  // Capacity
  maxOrders         Int       @default(50) @map("max_orders")

  // Premium pricing (if any)
  premiumCharge     Float     @default(0) @map("premium_charge")
  isPremium         Boolean   @default(false) @map("is_premium")

  // Settings
  isActive          Boolean   @default(true) @map("is_active")
  cutoffHours       Int       @default(12) @map("cutoff_hours") // Hours before slot to stop booking

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([hubId, isActive])
  @@map("delivery_slot_configs")
}

// Delivery Slot Booking - Customer slot selections
model DeliverySlotBooking {
  id                String    @id @default(cuid())

  shipmentId        String    @unique @map("shipment_id")
  awbNumber         String    @map("awb_number")

  // Slot details
  slotConfigId      String?   @map("slot_config_id")
  slotDate          DateTime  @map("slot_date")
  slotStartTime     String    @map("slot_start_time")
  slotEndTime       String    @map("slot_end_time")
  slotName          String?   @map("slot_name")

  // Customer preference
  preferredTime     String?   @map("preferred_time") // MORNING, AFTERNOON, EVENING
  alternateDate     DateTime? @map("alternate_date")

  // Status
  status            String    @default("BOOKED") // BOOKED, CONFIRMED, DELIVERED, MISSED, RESCHEDULED
  confirmedBy       String?   @map("confirmed_by")
  confirmedAt       DateTime? @map("confirmed_at")

  // Customer contact
  customerPhone     String?   @map("customer_phone")
  customerEmail     String?   @map("customer_email")

  // Notes
  specialInstructions String? @map("special_instructions")

  // Premium
  premiumCharge     Float     @default(0) @map("premium_charge")

  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([shipmentId])
  @@index([slotDate, status])
  @@index([slotConfigId, slotDate])
  @@map("delivery_slot_bookings")
}

// =============================================================================
// WMS - WAREHOUSE MANAGEMENT SYSTEM
// =============================================================================

// Warehouse Zones - Areas within a warehouse (Receiving, Storage, Picking, Packing, Shipping)
model WarehouseZone {
  id              String    @id @default(cuid())
  warehouseId     String    @map("warehouse_id")

  code            String    // Zone code e.g., "RCV-A", "STG-1", "PCK-01"
  name            String    // Zone name e.g., "Receiving Area A"
  type            String    // RECEIVING, STORAGE, PICKING, PACKING, SHIPPING, RETURNS, QUARANTINE

  // Physical dimensions
  lengthM         Float?    @map("length_m")
  widthM          Float?    @map("width_m")
  heightM         Float?    @map("height_m")
  areaM2          Float?    @map("area_m2")

  // Capacity
  maxBins         Int       @default(100) @map("max_bins")
  maxWeightKg     Float?    @map("max_weight_kg")

  // Temperature control (for cold storage)
  isTemperatureControlled Boolean @default(false) @map("is_temperature_controlled")
  minTempC        Float?    @map("min_temp_c")
  maxTempC        Float?    @map("max_temp_c")

  // Access control
  requiresSpecialAccess Boolean @default(false) @map("requires_special_access")
  accessLevel     String?   @map("access_level") // PUBLIC, RESTRICTED, HIGH_VALUE

  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  bins            StorageBin[]
  packStations    PackStation[]

  @@unique([warehouseId, code])
  @@index([warehouseId, type])
  @@map("warehouse_zones")
}

// Storage Bins - Individual storage locations
model StorageBin {
  id              String    @id @default(cuid())
  zoneId          String    @map("zone_id")

  code            String    // Bin code e.g., "A-01-02-03" (Aisle-Rack-Level-Position)
  barcode         String    @unique

  // Location within zone
  aisle           String?
  rack            String?
  level           String?   // Shelf level
  position        String?   // Position on shelf

  // Bin type
  type            String    @default("STANDARD") // STANDARD, PALLET, BULK, SMALL_PARTS, HAZMAT

  // Dimensions
  lengthCm        Float?    @map("length_cm")
  widthCm         Float?    @map("width_cm")
  heightCm        Float?    @map("height_cm")
  volumeCm3       Float?    @map("volume_cm3")
  maxWeightKg     Float?    @map("max_weight_kg")

  // Current status
  status          String    @default("EMPTY") // EMPTY, PARTIAL, FULL, RESERVED, BLOCKED

  // Occupancy
  currentItemCount Int      @default(0) @map("current_item_count")
  currentWeightKg Float     @default(0) @map("current_weight_kg")
  currentVolumeCm3 Float    @default(0) @map("current_volume_cm3")

  // Priority for picking (lower = pick first)
  pickPriority    Int       @default(100) @map("pick_priority")

  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  zone            WarehouseZone @relation(fields: [zoneId], references: [id])
  inventoryBatches InventoryBatch[]

  @@unique([zoneId, code])
  @@index([status])
  @@index([type])
  @@map("storage_bins")
}

// Inventory Items - SKU master data
model InventoryItem {
  id              String    @id @default(cuid())
  clientId        String    @map("client_id")
  warehouseId     String    @map("warehouse_id")

  // SKU identification
  sku             String    // Client's SKU code
  barcode         String?
  upc             String?   // Universal Product Code
  ean             String?   // European Article Number

  // Product info
  name            String
  description     String?
  category        String?
  subcategory     String?
  brand           String?

  // Dimensions
  lengthCm        Float?    @map("length_cm")
  widthCm         Float?    @map("width_cm")
  heightCm        Float?    @map("height_cm")
  weightGrams     Float?    @map("weight_grams")

  // Packaging
  unitsPerCase    Int       @default(1) @map("units_per_case")
  casesPerPallet  Int       @default(1) @map("cases_per_pallet")

  // Inventory settings
  minStockLevel   Int       @default(0) @map("min_stock_level")
  reorderPoint    Int       @default(0) @map("reorder_point")
  reorderQty      Int       @default(0) @map("reorder_qty")
  maxStockLevel   Int?      @map("max_stock_level")

  // Special handling
  isFragile       Boolean   @default(false) @map("is_fragile")
  isHazardous     Boolean   @default(false) @map("is_hazardous")
  requiresColdStorage Boolean @default(false) @map("requires_cold_storage")
  isSerialTracked Boolean   @default(false) @map("is_serial_tracked")
  isBatchTracked  Boolean   @default(false) @map("is_batch_tracked")

  // Picking method
  pickingMethod   String    @default("PIECE") // PIECE, CASE, PALLET

  // Status
  status          String    @default("ACTIVE") // ACTIVE, INACTIVE, DISCONTINUED

  // Valuation
  costPrice       Float?    @map("cost_price")
  sellingPrice    Float?    @map("selling_price")
  currency        String    @default("INR")

  // Images
  imageUrl        String?   @map("image_url")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  batches         InventoryBatch[]
  movements       InventoryMovement[]
  pickListItems   PickListItem[]

  @@unique([clientId, warehouseId, sku])
  @@index([barcode])
  @@index([status])
  @@map("inventory_items")
}

// Inventory Batches - Track inventory by batch/lot
model InventoryBatch {
  id              String    @id @default(cuid())
  itemId          String    @map("item_id")
  binId           String    @map("bin_id")

  // Batch identification
  batchNumber     String    @map("batch_number")
  lotNumber       String?   @map("lot_number")
  serialNumbers   String?   @map("serial_numbers") // JSON array for serialized items

  // Quantity
  quantity        Int       @default(0)
  reservedQty     Int       @default(0) @map("reserved_qty") // Reserved for pending orders
  availableQty    Int       @default(0) @map("available_qty") // quantity - reservedQty

  // Dates
  manufacturingDate DateTime? @map("manufacturing_date")
  expiryDate      DateTime?  @map("expiry_date")
  receivedDate    DateTime   @map("received_date")

  // Source
  poNumber        String?   @map("po_number")
  supplierId      String?   @map("supplier_id")

  // Status
  status          String    @default("AVAILABLE") // AVAILABLE, RESERVED, QUARANTINE, EXPIRED, DAMAGED

  // Quality
  qualityStatus   String    @default("PASSED") // PENDING, PASSED, FAILED, HOLD
  qualityNotes    String?   @map("quality_notes")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  item            InventoryItem @relation(fields: [itemId], references: [id])
  bin             StorageBin    @relation(fields: [binId], references: [id])
  movements       InventoryMovement[]

  @@index([itemId, status])
  @@index([binId])
  @@index([batchNumber])
  @@index([expiryDate])
  @@map("inventory_batches")
}

// Inventory Movements - All stock movements
model InventoryMovement {
  id              String    @id @default(cuid())
  itemId          String    @map("item_id")
  batchId         String?   @map("batch_id")

  // Movement type
  type            String    // RECEIVE, PUTAWAY, PICK, PACK, SHIP, ADJUST, TRANSFER, RETURN, CYCLE_COUNT

  // Quantity
  quantity        Int
  previousQty     Int       @map("previous_qty")
  newQty          Int       @map("new_qty")

  // Location
  fromBinId       String?   @map("from_bin_id")
  toBinId         String?   @map("to_bin_id")

  // Reference
  referenceType   String?   @map("reference_type") // ORDER, PICK_LIST, ADJUSTMENT, TRANSFER
  referenceId     String?   @map("reference_id")
  referenceNumber String?   @map("reference_number")

  // Reason (for adjustments)
  reason          String?
  notes           String?

  // Performed by
  performedBy     String?   @map("performed_by")
  performedAt     DateTime  @default(now()) @map("performed_at")

  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  item            InventoryItem  @relation(fields: [itemId], references: [id])
  batch           InventoryBatch? @relation(fields: [batchId], references: [id])

  @@index([itemId, type])
  @@index([referenceId])
  @@index([performedAt])
  @@map("inventory_movements")
}

// WMS Wave - Batch processing for pick-pack-ship
model WMSWave {
  id              String    @id @default(cuid())
  warehouseId     String    @map("warehouse_id")

  waveNumber      String    @unique @map("wave_number")
  name            String?

  // Wave configuration
  type            String    @default("STANDARD") // STANDARD, PRIORITY, EXPRESS, BULK

  // Orders included
  orderCount      Int       @default(0) @map("order_count")
  totalItems      Int       @default(0) @map("total_items")
  totalUnits      Int       @default(0) @map("total_units")

  // Timing
  plannedStartTime DateTime? @map("planned_start_time")
  plannedEndTime   DateTime? @map("planned_end_time")
  actualStartTime  DateTime? @map("actual_start_time")
  actualEndTime    DateTime? @map("actual_end_time")

  // Cutoff for carrier
  carrierCutoff   DateTime? @map("carrier_cutoff")

  // Status
  status          String    @default("PLANNED") // PLANNED, RELEASED, IN_PROGRESS, COMPLETED, CANCELLED

  // Progress
  pickedOrders    Int       @default(0) @map("picked_orders")
  packedOrders    Int       @default(0) @map("packed_orders")
  shippedOrders   Int       @default(0) @map("shipped_orders")

  // Created by
  createdBy       String?   @map("created_by")
  releasedBy      String?   @map("released_by")
  releasedAt      DateTime? @map("released_at")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  pickLists       PickList[]

  @@index([warehouseId, status])
  @@index([plannedStartTime])
  @@map("wms_waves")
}

// Pick List - Picking assignments
model PickList {
  id              String    @id @default(cuid())
  warehouseId     String    @map("warehouse_id")
  waveId          String?   @map("wave_id")

  pickListNumber  String    @unique @map("pick_list_number")

  // Assignment
  assignedTo      String?   @map("assigned_to") // User ID
  assignedAt      DateTime? @map("assigned_at")

  // Pick method
  pickMethod      String    @default("DISCRETE") // DISCRETE (one order), BATCH (multiple orders), ZONE

  // Orders in this pick list
  orderIds        String    @map("order_ids") // JSON array of order IDs

  // Item counts
  totalItems      Int       @default(0) @map("total_items")
  totalUnits      Int       @default(0) @map("total_units")
  pickedItems     Int       @default(0) @map("picked_items")
  pickedUnits     Int       @default(0) @map("picked_units")

  // Timing
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  // Status
  status          String    @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, PARTIAL, CANCELLED
  priority        Int       @default(5) // 1=Urgent, 10=Low priority

  // Equipment
  cartId          String?   @map("cart_id")
  scannerId       String?   @map("scanner_id")

  // Route optimization
  optimizedRoute  String?   @map("optimized_route") // JSON: Ordered list of bin locations

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  wave            WMSWave?   @relation(fields: [waveId], references: [id])
  items           PickListItem[]

  @@index([warehouseId, status])
  @@index([assignedTo, status])
  @@map("pick_lists")
}

// Pick List Items - Individual items to pick
model PickListItem {
  id              String    @id @default(cuid())
  pickListId      String    @map("pick_list_id")
  itemId          String    @map("item_id")
  orderId         String    @map("order_id")

  // Pick location
  binCode         String    @map("bin_code")
  binId           String?   @map("bin_id")
  zoneCode        String?   @map("zone_code")

  // Quantities
  quantityRequired Int      @map("quantity_required")
  quantityPicked  Int       @default(0) @map("quantity_picked")
  quantityShorted Int       @default(0) @map("quantity_shorted")

  // Batch info
  batchNumber     String?   @map("batch_number")
  serialNumbers   String?   @map("serial_numbers") // JSON array of picked serial numbers

  // Sequence in pick path
  sequence        Int       @default(0)

  // Status
  status          String    @default("PENDING") // PENDING, IN_PROGRESS, PICKED, SHORTED, CANCELLED

  // Verification
  scannedBarcode  String?   @map("scanned_barcode")
  pickedAt        DateTime? @map("picked_at")
  pickedBy        String?   @map("picked_by")

  // Issues
  shortReason     String?   @map("short_reason")
  notes           String?

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  pickList        PickList       @relation(fields: [pickListId], references: [id], onDelete: Cascade)
  item            InventoryItem  @relation(fields: [itemId], references: [id])

  @@index([pickListId, sequence])
  @@index([status])
  @@map("pick_list_items")
}

// Pack Station - Packing workstations
model PackStation {
  id              String    @id @default(cuid())
  zoneId          String    @map("zone_id")

  code            String    // e.g., "PACK-01"
  name            String

  // Equipment
  hasScale        Boolean   @default(true) @map("has_scale")
  hasScanner      Boolean   @default(true) @map("has_scanner")
  hasPrinter      Boolean   @default(true) @map("has_printer")
  hasCamera       Boolean   @default(false) @map("has_camera") // For photo POD

  // Current assignment
  assignedTo      String?   @map("assigned_to")
  currentOrderId  String?   @map("current_order_id")

  // Status
  status          String    @default("AVAILABLE") // AVAILABLE, IN_USE, MAINTENANCE, OFFLINE

  // Statistics (today)
  ordersPackedToday Int     @default(0) @map("orders_packed_today")
  avgPackTimeSeconds Int?   @map("avg_pack_time_seconds")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  zone            WarehouseZone @relation(fields: [zoneId], references: [id])
  packingTasks    PackingTask[]

  @@unique([zoneId, code])
  @@index([status])
  @@map("pack_stations")
}

// Packing Task - Individual packing jobs
model PackingTask {
  id              String    @id @default(cuid())
  packStationId   String?   @map("pack_station_id")
  orderId         String    @map("order_id")
  awbNumber       String?   @map("awb_number")

  // Task number
  taskNumber      String    @unique @map("task_number")

  // Assignment
  assignedTo      String?   @map("assigned_to")
  assignedAt      DateTime? @map("assigned_at")

  // Items
  totalItems      Int       @default(0) @map("total_items")
  packedItems     Int       @default(0) @map("packed_items")
  itemsList       String?   @map("items_list") // JSON array of items to pack

  // Packaging used
  boxType         String?   @map("box_type") // SMALL, MEDIUM, LARGE, CUSTOM
  boxDimensions   String?   @map("box_dimensions") // LxWxH
  packagingMaterial String? @map("packaging_material")

  // Weights
  itemsWeightGrams Int?     @map("items_weight_grams")
  packagedWeightGrams Int?  @map("packaged_weight_grams")

  // Verification
  allItemsScanned Boolean   @default(false) @map("all_items_scanned")
  weightVerified  Boolean   @default(false) @map("weight_verified")
  photoTaken      Boolean   @default(false) @map("photo_taken")
  photoUrl        String?   @map("photo_url")

  // Labels
  shippingLabelPrinted Boolean @default(false) @map("shipping_label_printed")
  invoicePrinted  Boolean   @default(false) @map("invoice_printed")

  // Timing
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  packTimeSeconds Int?      @map("pack_time_seconds")

  // Status
  status          String    @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, ON_HOLD, CANCELLED
  priority        Int       @default(5)

  // Issues
  hasIssue        Boolean   @default(false) @map("has_issue")
  issueType       String?   @map("issue_type") // MISSING_ITEM, DAMAGED_ITEM, WRONG_ITEM
  issueNotes      String?   @map("issue_notes")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  packStation     PackStation? @relation(fields: [packStationId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([assignedTo, status])
  @@map("packing_tasks")
}

// Receiving - Inbound shipments
model ReceivingRecord {
  id              String    @id @default(cuid())
  warehouseId     String    @map("warehouse_id")

  receiptNumber   String    @unique @map("receipt_number")

  // Supplier/Source
  supplierId      String?   @map("supplier_id")
  supplierName    String?   @map("supplier_name")
  poNumber        String?   @map("po_number")

  // Carrier
  carrierName     String?   @map("carrier_name")
  trackingNumber  String?   @map("tracking_number")
  vehicleNumber   String?   @map("vehicle_number")

  // Expected
  expectedDate    DateTime? @map("expected_date")
  expectedItems   Int       @default(0) @map("expected_items")
  expectedUnits   Int       @default(0) @map("expected_units")

  // Received
  receivedDate    DateTime? @map("received_date")
  receivedItems   Int       @default(0) @map("received_items")
  receivedUnits   Int       @default(0) @map("received_units")

  // Discrepancies
  shortItems      Int       @default(0) @map("short_items")
  overItems       Int       @default(0) @map("over_items")
  damagedItems    Int       @default(0) @map("damaged_items")

  // Status
  status          String    @default("EXPECTED") // EXPECTED, ARRIVED, IN_PROGRESS, COMPLETED, CLOSED

  // Receiving dock
  dockDoor        String?   @map("dock_door")

  // Processing
  receivedBy      String?   @map("received_by")
  verifiedBy      String?   @map("verified_by")
  putawayComplete Boolean   @default(false) @map("putaway_complete")

  notes           String?

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  items           ReceivingItem[]

  @@index([warehouseId, status])
  @@index([poNumber])
  @@map("receiving_records")
}

// Receiving Items - Line items in a receiving record
model ReceivingItem {
  id              String    @id @default(cuid())
  receivingId     String    @map("receiving_id")

  // SKU
  sku             String
  itemName        String    @map("item_name")
  barcode         String?

  // Expected
  expectedQty     Int       @map("expected_qty")

  // Received
  receivedQty     Int       @default(0) @map("received_qty")
  damagedQty      Int       @default(0) @map("damaged_qty")

  // Batch/Lot info
  batchNumber     String?   @map("batch_number")
  lotNumber       String?   @map("lot_number")
  expiryDate      DateTime? @map("expiry_date")

  // Putaway
  putawayBinId    String?   @map("putaway_bin_id")
  putawayComplete Boolean   @default(false) @map("putaway_complete")
  putawayBy       String?   @map("putaway_by")
  putawayAt       DateTime? @map("putaway_at")

  // Status
  status          String    @default("PENDING") // PENDING, RECEIVED, VERIFIED, PUTAWAY

  // Quality
  qcStatus        String    @default("PENDING") // PENDING, PASSED, FAILED, HOLD
  qcNotes         String?   @map("qc_notes")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  receiving       ReceivingRecord @relation(fields: [receivingId], references: [id], onDelete: Cascade)

  @@index([receivingId])
  @@index([sku])
  @@map("receiving_items")
}

// Cycle Count - Inventory verification
model CycleCount {
  id              String    @id @default(cuid())
  warehouseId     String    @map("warehouse_id")

  countNumber     String    @unique @map("count_number")
  name            String?

  // Count type
  type            String    @default("ZONE") // FULL, ZONE, ABC, RANDOM, ITEM
  scope           String?   // Zone codes or item categories to count

  // Schedule
  scheduledDate   DateTime  @map("scheduled_date")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")

  // Counts
  totalLocations  Int       @default(0) @map("total_locations")
  countedLocations Int      @default(0) @map("counted_locations")
  totalItems      Int       @default(0) @map("total_items")
  countedItems    Int       @default(0) @map("counted_items")

  // Variance
  varianceItems   Int       @default(0) @map("variance_items")
  varianceValue   Float     @default(0) @map("variance_value")

  // Status
  status          String    @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, APPROVED, CANCELLED

  // Approval
  approvedBy      String?   @map("approved_by")
  approvedAt      DateTime? @map("approved_at")
  adjustmentsApplied Boolean @default(false) @map("adjustments_applied")

  createdBy       String?   @map("created_by")
  assignedTo      String?   @map("assigned_to")

  notes           String?

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  countItems      CycleCountItem[]

  @@index([warehouseId, status])
  @@index([scheduledDate])
  @@map("cycle_counts")
}

// Cycle Count Items - Individual count entries
model CycleCountItem {
  id              String    @id @default(cuid())
  cycleCountId    String    @map("cycle_count_id")

  // Location
  binId           String    @map("bin_id")
  binCode         String    @map("bin_code")

  // Item
  sku             String
  batchNumber     String?   @map("batch_number")

  // Counts
  systemQty       Int       @map("system_qty")
  countedQty      Int?      @map("counted_qty")
  recountQty      Int?      @map("recount_qty") // For double-check

  // Variance
  variance        Int       @default(0)
  varianceReason  String?   @map("variance_reason")

  // Status
  status          String    @default("PENDING") // PENDING, COUNTED, RECOUNTED, VERIFIED, ADJUSTED

  countedBy       String?   @map("counted_by")
  countedAt       DateTime? @map("counted_at")

  notes           String?

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  cycleCount      CycleCount @relation(fields: [cycleCountId], references: [id], onDelete: Cascade)

  @@index([cycleCountId])
  @@index([binId])
  @@map("cycle_count_items")
}

// ============================================
// ERP INTEGRATION (SAP, Tally, Zoho)
// ============================================

// ERP Integration Configuration
model ERPIntegration {
  id                  String    @id @default(cuid())
  clientId            String    @map("client_id")

  // ERP System Info
  erpType             String    @map("erp_type") // SAP, TALLY, ZOHO_BOOKS, ZOHO_INVENTORY, QUICKBOOKS, CUSTOM
  erpName             String    @map("erp_name") // Display name
  erpVersion          String?   @map("erp_version")

  // Connection
  connectionType      String    @default("API") @map("connection_type") // API, WEBHOOK, FILE_IMPORT, DIRECT_DB
  apiBaseUrl          String?   @map("api_base_url")
  apiKey              String?   @map("api_key")
  apiSecret           String?   @map("api_secret")
  authType            String?   @map("auth_type") // API_KEY, OAUTH2, BASIC, TOKEN
  accessToken         String?   @map("access_token")
  refreshToken        String?   @map("refresh_token")
  tokenExpiresAt      DateTime? @map("token_expires_at")

  // SAP Specific
  sapClientId         String?   @map("sap_client_id")
  sapCompanyCode      String?   @map("sap_company_code")
  sapPlantCode        String?   @map("sap_plant_code")

  // Tally Specific
  tallyHost           String?   @map("tally_host")
  tallyPort           Int?      @map("tally_port")
  tallyCompanyName    String?   @map("tally_company_name")

  // Zoho Specific
  zohoOrganizationId  String?   @map("zoho_organization_id")
  zohoDataCenter      String?   @map("zoho_data_center") // US, EU, IN, AU

  // Sync Settings
  isActive            Boolean   @default(true) @map("is_active")
  syncDirection       String    @default("BIDIRECTIONAL") @map("sync_direction") // INBOUND, OUTBOUND, BIDIRECTIONAL
  syncFrequency       String    @default("REALTIME") @map("sync_frequency") // REALTIME, HOURLY, DAILY, MANUAL

  // Entity Sync Settings (JSON)
  enabledEntities     String    @map("enabled_entities") // JSON: {orders: true, inventory: true, invoices: true, etc.}

  // Error Handling
  retryAttempts       Int       @default(3) @map("retry_attempts")
  retryDelayMinutes   Int       @default(5) @map("retry_delay_minutes")
  errorNotifyEmail    String?   @map("error_notify_email")

  // Status
  lastSyncAt          DateTime? @map("last_sync_at")
  lastSyncStatus      String?   @map("last_sync_status") // SUCCESS, PARTIAL, FAILED
  connectionStatus    String    @default("PENDING") @map("connection_status") // PENDING, CONNECTED, DISCONNECTED, ERROR

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  syncJobs            ERPSyncJob[]
  fieldMappings       ERPFieldMapping[]
  webhooks            ERPWebhook[]

  @@unique([clientId, erpType])
  @@index([clientId])
  @@index([erpType, isActive])
  @@map("erp_integrations")
}

// ERP Sync Jobs
model ERPSyncJob {
  id                  String    @id @default(cuid())
  integrationId       String    @map("integration_id")

  // Job Info
  jobNumber           String    @unique @map("job_number")
  jobType             String    @map("job_type") // FULL_SYNC, INCREMENTAL, ENTITY_SYNC, RETRY, MANUAL

  // Entity being synced
  entityType          String    @map("entity_type") // ORDER, SHIPMENT, INVOICE, INVENTORY, CUSTOMER, PRODUCT
  direction           String    @default("OUTBOUND") // INBOUND, OUTBOUND

  // Filters
  dateFrom            DateTime? @map("date_from")
  dateTo              DateTime? @map("date_to")
  entityIds           String?   @map("entity_ids") // JSON array of specific IDs to sync

  // Status
  status              String    @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, FAILED, CANCELLED, PARTIAL

  // Progress
  totalRecords        Int       @default(0) @map("total_records")
  processedRecords    Int       @default(0) @map("processed_records")
  successRecords      Int       @default(0) @map("success_records")
  failedRecords       Int       @default(0) @map("failed_records")
  skippedRecords      Int       @default(0) @map("skipped_records")

  // Timing
  scheduledAt         DateTime? @map("scheduled_at")
  startedAt           DateTime? @map("started_at")
  completedAt         DateTime? @map("completed_at")

  // Error Info
  errorMessage        String?   @map("error_message")
  errorDetails        String?   @map("error_details") // JSON

  // Triggered by
  triggeredBy         String?   @map("triggered_by") // SCHEDULE, WEBHOOK, MANUAL, RETRY
  triggeredByUserId   String?   @map("triggered_by_user_id")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  integration         ERPIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  syncLogs            ERPSyncLog[]

  @@index([integrationId, status])
  @@index([entityType, status])
  @@index([scheduledAt])
  @@map("erp_sync_jobs")
}

// ERP Sync Log - Detailed record-level logs
model ERPSyncLog {
  id                  String    @id @default(cuid())
  syncJobId           String    @map("sync_job_id")

  // Entity Info
  entityType          String    @map("entity_type")
  entityId            String    @map("entity_id")
  entityRef           String?   @map("entity_ref") // AWB number, order ID, etc.

  // Direction
  direction           String    // INBOUND, OUTBOUND

  // Status
  status              String    @default("PENDING") // PENDING, PROCESSING, SUCCESS, FAILED, SKIPPED

  // Data
  requestPayload      String?   @map("request_payload") // JSON
  responsePayload     String?   @map("response_payload") // JSON

  // ERP Reference
  erpEntityId         String?   @map("erp_entity_id") // ID in ERP system
  erpDocumentNumber   String?   @map("erp_document_number")

  // Error
  errorCode           String?   @map("error_code")
  errorMessage        String?   @map("error_message")

  // Timing
  startedAt           DateTime? @map("started_at")
  completedAt         DateTime? @map("completed_at")
  durationMs          Int?      @map("duration_ms")

  // Retry info
  attemptNumber       Int       @default(1) @map("attempt_number")
  maxRetries          Int       @default(3) @map("max_retries")
  nextRetryAt         DateTime? @map("next_retry_at")

  createdAt           DateTime  @default(now()) @map("created_at")

  // Relations
  syncJob             ERPSyncJob @relation(fields: [syncJobId], references: [id], onDelete: Cascade)

  @@index([syncJobId, status])
  @@index([entityType, entityId])
  @@index([status, nextRetryAt])
  @@map("erp_sync_logs")
}

// ERP Field Mapping - Custom field mappings
model ERPFieldMapping {
  id                  String    @id @default(cuid())
  integrationId       String    @map("integration_id")

  // Entity Type
  entityType          String    @map("entity_type") // ORDER, SHIPMENT, INVOICE, INVENTORY, etc.

  // Mapping
  cjdFieldName        String    @map("cjd_field_name")
  cjdFieldPath        String?   @map("cjd_field_path") // For nested fields: "order.customer.name"
  erpFieldName        String    @map("erp_field_name")
  erpFieldPath        String?   @map("erp_field_path")

  // Transformation
  transformationType  String?   @map("transformation_type") // DIRECT, FORMAT, LOOKUP, CALCULATE, CUSTOM
  transformationRule  String?   @map("transformation_rule") // JSON: {format: "YYYY-MM-DD", lookup: {...}, formula: "..."}

  // Direction
  direction           String    @default("BIDIRECTIONAL") // INBOUND, OUTBOUND, BIDIRECTIONAL

  // Settings
  isRequired          Boolean   @default(false) @map("is_required")
  defaultValue        String?   @map("default_value")
  isActive            Boolean   @default(true) @map("is_active")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  integration         ERPIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, entityType, cjdFieldName, direction])
  @@index([integrationId, entityType])
  @@map("erp_field_mappings")
}

// ERP Webhook Configuration
model ERPWebhook {
  id                  String    @id @default(cuid())
  integrationId       String    @map("integration_id")

  // Webhook Details
  webhookUrl          String    @map("webhook_url")
  webhookSecret       String?   @map("webhook_secret")

  // Events
  eventTypes          String    @map("event_types") // JSON array: ["ORDER_CREATED", "SHIPMENT_DELIVERED", etc.]

  // Settings
  isActive            Boolean   @default(true) @map("is_active")
  retryAttempts       Int       @default(3) @map("retry_attempts")
  timeoutSeconds      Int       @default(30) @map("timeout_seconds")

  // Headers
  customHeaders       String?   @map("custom_headers") // JSON

  // Status
  lastTriggeredAt     DateTime? @map("last_triggered_at")
  lastStatus          String?   @map("last_status") // SUCCESS, FAILED
  consecutiveFailures Int       @default(0) @map("consecutive_failures")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  integration         ERPIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId, isActive])
  @@map("erp_webhooks")
}

// ERP Entity Mapping - Links CJD entities to ERP entities
model ERPEntityLink {
  id                  String    @id @default(cuid())

  // Client
  clientId            String    @map("client_id")
  erpType             String    @map("erp_type")

  // Entity Info
  entityType          String    @map("entity_type") // ORDER, SHIPMENT, INVOICE, PRODUCT, etc.
  cjdEntityId         String    @map("cjd_entity_id")
  erpEntityId         String    @map("erp_entity_id")

  // Additional References
  erpDocumentNumber   String?   @map("erp_document_number")
  erpDocumentType     String?   @map("erp_document_type")

  // Sync Status
  lastSyncedAt        DateTime? @map("last_synced_at")
  lastSyncStatus      String?   @map("last_sync_status")
  syncVersion         Int       @default(1) @map("sync_version") // For conflict detection

  // Metadata
  metadata            String?   // JSON for any additional data

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@unique([clientId, erpType, entityType, cjdEntityId])
  @@unique([clientId, erpType, entityType, erpEntityId])
  @@index([clientId, erpType])
  @@index([entityType, cjdEntityId])
  @@map("erp_entity_links")
}

// ============================================
// ADVANCED ANALYTICS & BI
// ============================================

// Daily Metrics Snapshot (Pre-aggregated for fast dashboards)
model DailyMetricsSnapshot {
  id                  String    @id @default(cuid())

  snapshotDate        DateTime  @map("snapshot_date")
  entityType          String    @map("entity_type") // CLIENT, HUB, ROUTE, PARTNER, OVERALL
  entityId            String?   @map("entity_id") // null for OVERALL

  // Volume Metrics
  shipmentsCreated    Int       @default(0) @map("shipments_created")
  shipmentsDelivered  Int       @default(0) @map("shipments_delivered")
  shipmentsRTO        Int       @default(0) @map("shipments_rto")
  shipmentsPending    Int       @default(0) @map("shipments_pending")
  shipmentsInTransit  Int       @default(0) @map("shipments_in_transit")
  shipmentsNDR        Int       @default(0) @map("shipments_ndr")

  // Revenue Metrics
  totalRevenue        Float     @default(0) @map("total_revenue")
  freightCharges      Float     @default(0) @map("freight_charges")
  codCollected        Float     @default(0) @map("cod_collected")
  codRemitted         Float     @default(0) @map("cod_remitted")

  // Performance Metrics
  onTimeDeliveryRate  Float     @default(0) @map("on_time_delivery_rate") // Percentage
  firstAttemptRate    Float     @default(0) @map("first_attempt_rate")
  rtoRate             Float     @default(0) @map("rto_rate")
  ndrRate             Float     @default(0) @map("ndr_rate")
  avgDeliveryDays     Float     @default(0) @map("avg_delivery_days")

  // SLA Metrics
  slaMet              Int       @default(0) @map("sla_met")
  slaBreached         Int       @default(0) @map("sla_breached")
  slaComplianceRate   Float     @default(0) @map("sla_compliance_rate")

  // Weight & Dimensions
  totalWeightKg       Float     @default(0) @map("total_weight_kg")
  avgWeightKg         Float     @default(0) @map("avg_weight_kg")

  // Cost Metrics
  totalCost           Float     @default(0) @map("total_cost")
  costPerShipment     Float     @default(0) @map("cost_per_shipment")

  createdAt           DateTime  @default(now()) @map("created_at")

  @@unique([snapshotDate, entityType, entityId])
  @@index([snapshotDate])
  @@index([entityType, entityId])
  @@map("daily_metrics_snapshots")
}

// Hourly Traffic Metrics (For real-time charts)
model HourlyTrafficMetrics {
  id                  String    @id @default(cuid())

  metricHour          DateTime  @map("metric_hour")
  hubId               String?   @map("hub_id")

  // Volume
  shipmentsIn         Int       @default(0) @map("shipments_in")
  shipmentsOut        Int       @default(0) @map("shipments_out")
  ordersCreated       Int       @default(0) @map("orders_created")
  deliveriesCompleted Int       @default(0) @map("deliveries_completed")

  // Capacity
  hubUtilization      Float?    @map("hub_utilization")
  activeVehicles      Int       @default(0) @map("active_vehicles")
  activeTrips         Int       @default(0) @map("active_trips")

  createdAt           DateTime  @default(now()) @map("created_at")

  @@unique([metricHour, hubId])
  @@index([metricHour])
  @@index([hubId])
  @@map("hourly_traffic_metrics")
}

// Lane Performance Analytics
model LanePerformance {
  id                  String    @id @default(cuid())

  // Lane Definition
  originPincode       String    @map("origin_pincode")
  originCity          String    @map("origin_city")
  originState         String    @map("origin_state")
  destinationPincode  String    @map("destination_pincode")
  destinationCity     String    @map("destination_city")
  destinationState    String    @map("destination_state")

  // Period
  periodType          String    @map("period_type") // DAILY, WEEKLY, MONTHLY
  periodStart         DateTime  @map("period_start")
  periodEnd           DateTime  @map("period_end")

  // Volume
  totalShipments      Int       @default(0) @map("total_shipments")
  deliveredShipments  Int       @default(0) @map("delivered_shipments")
  rtoShipments        Int       @default(0) @map("rto_shipments")

  // Performance
  avgTransitDays      Float     @default(0) @map("avg_transit_days")
  onTimeRate          Float     @default(0) @map("on_time_rate")
  firstAttemptRate    Float     @default(0) @map("first_attempt_rate")
  deliverySuccessRate Float     @default(0) @map("delivery_success_rate")

  // Cost & Revenue
  avgFreightPerKg     Float     @default(0) @map("avg_freight_per_kg")
  avgShipmentValue    Float     @default(0) @map("avg_shipment_value")

  // Best Performing Partner on this lane
  bestPartnerId       String?   @map("best_partner_id")
  bestPartnerScore    Float?    @map("best_partner_score")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@unique([originPincode, destinationPincode, periodType, periodStart])
  @@index([originCity, destinationCity])
  @@index([periodStart, periodEnd])
  @@map("lane_performance")
}

// Client Analytics Dashboard Cache
model ClientAnalyticsCache {
  id                  String    @id @default(cuid())
  clientId            String    @map("client_id")

  // Time Period
  periodType          String    @map("period_type") // TODAY, WEEK, MONTH, QUARTER, YEAR
  periodStart         DateTime  @map("period_start")
  periodEnd           DateTime  @map("period_end")

  // Summary Stats (JSON for flexibility)
  volumeStats         String    @map("volume_stats") // JSON
  revenueStats        String    @map("revenue_stats") // JSON
  performanceStats    String    @map("performance_stats") // JSON
  topLanes            String    @map("top_lanes") // JSON
  topProducts         String    @map("top_products") // JSON

  // Trend Data
  dailyTrend          String    @map("daily_trend") // JSON array

  // Comparisons
  periodOverPeriod    String?   @map("period_over_period") // JSON

  generatedAt         DateTime  @default(now()) @map("generated_at")
  expiresAt           DateTime  @map("expires_at")

  @@unique([clientId, periodType, periodStart])
  @@index([clientId, periodType])
  @@index([expiresAt])
  @@map("client_analytics_cache")
}

// Custom Report Definition
model CustomReport {
  id                  String    @id @default(cuid())
  clientId            String?   @map("client_id") // null for system-wide reports

  name                String
  description         String?
  reportType          String    @map("report_type") // SHIPMENT, REVENUE, PERFORMANCE, COD, CUSTOM

  // Configuration
  dimensions          String    // JSON: ["date", "hub", "client"]
  metrics             String    // JSON: ["shipmentCount", "revenue", "onTimeRate"]
  filters             String?   // JSON: {status: ["DELIVERED"], dateRange: "last_30_days"}
  groupBy             String?   @map("group_by") // JSON
  sortBy              String?   @map("sort_by") // JSON

  // Visualization
  chartType           String?   @map("chart_type") // TABLE, LINE, BAR, PIE, MAP, FUNNEL
  chartConfig         String?   @map("chart_config") // JSON

  // Schedule
  isScheduled         Boolean   @default(false) @map("is_scheduled")
  scheduleFrequency   String?   @map("schedule_frequency") // DAILY, WEEKLY, MONTHLY
  scheduleTime        String?   @map("schedule_time") // "09:00"
  scheduleRecipients  String?   @map("schedule_recipients") // JSON array of emails

  // Access
  isPublic            Boolean   @default(false) @map("is_public")
  createdBy           String    @map("created_by")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  executions          ReportExecution[]

  @@index([clientId, reportType])
  @@index([createdBy])
  @@map("custom_reports")
}

// Report Execution History
model ReportExecution {
  id                  String    @id @default(cuid())
  reportId            String    @map("report_id")

  // Execution Details
  executionNumber     String    @unique @map("execution_number")
  triggeredBy         String    @map("triggered_by") // SCHEDULE, MANUAL, API
  triggeredByUserId   String?   @map("triggered_by_user_id")

  // Parameters Used
  parameters          String?   // JSON

  // Status
  status              String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED

  // Results
  rowCount            Int       @default(0) @map("row_count")
  resultUrl           String?   @map("result_url") // S3/storage URL for large reports
  resultPreview       String?   @map("result_preview") // JSON - first few rows

  // Timing
  startedAt           DateTime? @map("started_at")
  completedAt         DateTime? @map("completed_at")
  durationMs          Int?      @map("duration_ms")

  // Error Info
  errorMessage        String?   @map("error_message")

  createdAt           DateTime  @default(now()) @map("created_at")

  // Relations
  report              CustomReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId, status])
  @@index([triggeredBy])
  @@map("report_executions")
}

// Saved Dashboard Configuration
model DashboardConfig {
  id                  String    @id @default(cuid())
  userId              String    @map("user_id")
  clientId            String?   @map("client_id")

  name                String
  description         String?
  isDefault           Boolean   @default(false) @map("is_default")

  // Layout Configuration
  layout              String    // JSON: array of widget positions
  widgets             String    // JSON: array of widget configurations

  // Filters
  defaultFilters      String?   @map("default_filters") // JSON
  dateRange           String?   @map("date_range") // last_7_days, last_30_days, custom

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([userId])
  @@index([clientId])
  @@map("dashboard_configs")
}

// ============================================
// CAPACITY PLANNING & FORECASTING
// ============================================

// Demand Forecast
model DemandForecast {
  id                  String    @id @default(cuid())

  // Scope
  forecastType        String    @map("forecast_type") // OVERALL, CLIENT, HUB, LANE, ZONE
  entityId            String?   @map("entity_id")

  // Time Period
  forecastDate        DateTime  @map("forecast_date")
  periodType          String    @map("period_type") // DAILY, WEEKLY, MONTHLY

  // Predictions
  predictedShipments  Int       @map("predicted_shipments")
  predictedWeightKg   Float     @map("predicted_weight_kg")
  predictedRevenue    Float     @map("predicted_revenue")

  // Confidence
  confidenceLevel     Float     @map("confidence_level") // 0-100
  predictionLow       Int       @map("prediction_low") // Lower bound
  predictionHigh      Int       @map("prediction_high") // Upper bound

  // Factors influencing forecast
  seasonalityFactor   Float     @default(1) @map("seasonality_factor")
  trendFactor         Float     @default(1) @map("trend_factor")
  eventFactor         Float     @default(1) @map("event_factor") // Festivals, sales, etc.

  // Actual vs Predicted (updated after period ends)
  actualShipments     Int?      @map("actual_shipments")
  actualWeightKg      Float?    @map("actual_weight_kg")
  accuracyPercent     Float?    @map("accuracy_percent")

  // Model info
  modelVersion        String?   @map("model_version")
  generatedAt         DateTime  @default(now()) @map("generated_at")

  createdAt           DateTime  @default(now()) @map("created_at")

  @@unique([forecastType, entityId, forecastDate, periodType])
  @@index([forecastDate])
  @@index([forecastType, entityId])
  @@map("demand_forecasts")
}

// Hub Capacity Planning
model HubCapacityPlan {
  id                  String    @id @default(cuid())
  hubId               String    @map("hub_id")

  // Planning Period
  planDate            DateTime  @map("plan_date")

  // Current Capacity
  maxDailyCapacity    Int       @map("max_daily_capacity") // Max shipments per day
  currentUtilization  Float     @map("current_utilization") // Percentage

  // Storage Capacity
  storageCapacitySqFt Float?    @map("storage_capacity_sq_ft")
  storageUsedSqFt     Float?    @map("storage_used_sq_ft")
  storageUtilization  Float?    @map("storage_utilization")

  // Staffing
  staffRequired       Int       @map("staff_required")
  staffAvailable      Int       @map("staff_available")
  staffUtilization    Float?    @map("staff_utilization")

  // Expected Load
  forecastedShipments Int       @map("forecasted_shipments")
  forecastedWeight    Float     @map("forecasted_weight")

  // Capacity Status
  capacityStatus      String    @map("capacity_status") // UNDER_UTILIZED, OPTIMAL, NEAR_CAPACITY, OVER_CAPACITY
  alertLevel          String?   @map("alert_level") // LOW, MEDIUM, HIGH, CRITICAL

  // Recommendations
  recommendations     String?   // JSON array of recommendations

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@unique([hubId, planDate])
  @@index([hubId, planDate])
  @@index([capacityStatus])
  @@map("hub_capacity_plans")
}

// Fleet Capacity Planning
model FleetCapacityPlan {
  id                  String    @id @default(cuid())

  // Planning Period
  planDate            DateTime  @map("plan_date")
  hubId               String?   @map("hub_id") // null for overall

  // Vehicle Requirements
  vehiclesRequired    Int       @map("vehicles_required")
  vehiclesAvailable   Int       @map("vehicles_available")
  vehicleShortfall    Int       @default(0) @map("vehicle_shortfall")

  // By Vehicle Type (JSON)
  vehicleBreakdown    String    @map("vehicle_breakdown") // JSON: {bike: 10, tempo: 5, truck: 2}

  // Capacity
  totalCapacityKg     Float     @map("total_capacity_kg")
  forecastedLoadKg    Float     @map("forecasted_load_kg")
  capacityUtilization Float     @map("capacity_utilization")

  // Drivers
  driversRequired     Int       @map("drivers_required")
  driversAvailable    Int       @map("drivers_available")
  driverShortfall     Int       @default(0) @map("driver_shortfall")

  // Status
  capacityStatus      String    @map("capacity_status")
  alertLevel          String?   @map("alert_level")

  // Recommendations
  recommendations     String?   // JSON

  createdAt           DateTime  @default(now()) @map("created_at")

  @@unique([planDate, hubId])
  @@index([planDate])
  @@index([capacityStatus])
  @@map("fleet_capacity_plans")
}

// Route Optimization
model RouteOptimization {
  id                  String    @id @default(cuid())

  // Context
  hubId               String    @map("hub_id")
  optimizationDate    DateTime  @map("optimization_date")
  routeType           String    @map("route_type") // PICKUP, DELIVERY, LINEHAUL

  // Before Optimization
  originalRouteCount  Int       @map("original_route_count")
  originalDistanceKm  Float     @map("original_distance_km")
  originalDuration    Float     @map("original_duration") // minutes
  originalCost        Float     @map("original_cost")

  // After Optimization
  optimizedRouteCount Int       @map("optimized_route_count")
  optimizedDistanceKm Float     @map("optimized_distance_km")
  optimizedDuration   Float     @map("optimized_duration")
  optimizedCost       Float     @map("optimized_cost")

  // Savings
  distanceSavedKm     Float     @map("distance_saved_km")
  timeSavedMinutes    Float     @map("time_saved_minutes")
  costSaved           Float     @map("cost_saved")
  efficiencyGain      Float     @map("efficiency_gain") // Percentage

  // Stops
  totalStops          Int       @map("total_stops")
  avgStopsPerRoute    Float     @map("avg_stops_per_route")

  // Details
  routeDetails        String?   @map("route_details") // JSON

  createdAt           DateTime  @default(now()) @map("created_at")

  @@unique([hubId, optimizationDate, routeType])
  @@index([hubId, optimizationDate])
  @@map("route_optimizations")
}

// Capacity Alert
model CapacityAlert {
  id                  String    @id @default(cuid())

  // Alert Type
  alertType           String    @map("alert_type") // HUB_CAPACITY, FLEET_SHORTAGE, DRIVER_SHORTAGE, ROUTE_OVERLOAD
  severity            String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL

  // Context
  entityType          String    @map("entity_type") // HUB, FLEET, ROUTE, ZONE
  entityId            String    @map("entity_id")
  entityName          String?   @map("entity_name")

  // Alert Details
  title               String
  description         String
  metrics             String?   // JSON: current utilization, thresholds, etc.

  // Threshold
  thresholdValue      Float     @map("threshold_value")
  currentValue        Float     @map("current_value")

  // Status
  status              String    @default("ACTIVE") // ACTIVE, ACKNOWLEDGED, RESOLVED, IGNORED

  // Resolution
  acknowledgedBy      String?   @map("acknowledged_by")
  acknowledgedAt      DateTime? @map("acknowledged_at")
  resolvedAt          DateTime? @map("resolved_at")
  resolutionNotes     String?   @map("resolution_notes")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([alertType, status])
  @@index([entityType, entityId])
  @@index([severity, status])
  @@map("capacity_alerts")
}

// ============================================
// CARBON FOOTPRINT & SUSTAINABILITY
// ============================================

// Carbon Emission Record
model CarbonEmission {
  id                  String    @id @default(cuid())

  // Context
  emissionType        String    @map("emission_type") // TRIP, SHIPMENT, HUB_OPERATION, VEHICLE
  referenceId         String    @map("reference_id")
  referenceType       String    @map("reference_type") // TRIP, SHIPMENT, HUB, VEHICLE

  // Date
  emissionDate        DateTime  @map("emission_date")

  // Vehicle Details
  vehicleId           String?   @map("vehicle_id")
  vehicleType         String?   @map("vehicle_type")
  fuelType            String?   @map("fuel_type") // DIESEL, PETROL, CNG, ELECTRIC, HYBRID

  // Distance & Load
  distanceKm          Float     @map("distance_km")
  loadWeightKg        Float?    @map("load_weight_kg")
  loadUtilization     Float?    @map("load_utilization") // Percentage

  // Emissions
  co2EmissionKg       Float     @map("co2_emission_kg")
  co2PerKmKg          Float     @map("co2_per_km_kg")
  co2PerKgCargo       Float?    @map("co2_per_kg_cargo")

  // Emission Factors Used
  emissionFactorId    String?   @map("emission_factor_id")
  emissionFactorValue Float?    @map("emission_factor_value") // kg CO2 per km or per liter

  // Calculation Method
  calculationMethod   String    @map("calculation_method") // DISTANCE_BASED, FUEL_BASED, WEIGHT_DISTANCE

  createdAt           DateTime  @default(now()) @map("created_at")

  @@index([emissionDate])
  @@index([referenceType, referenceId])
  @@index([vehicleId])
  @@map("carbon_emissions")
}

// Daily Carbon Summary
model CarbonDailySummary {
  id                  String    @id @default(cuid())

  summaryDate         DateTime  @map("summary_date")
  entityType          String    @map("entity_type") // OVERALL, HUB, CLIENT, VEHICLE
  entityId            String?   @map("entity_id")

  // Totals
  totalDistanceKm     Float     @map("total_distance_km")
  totalCo2Kg          Float     @map("total_co2_kg")
  totalShipments      Int       @map("total_shipments")
  totalWeightKg       Float     @map("total_weight_kg")

  // Averages
  avgCo2PerShipment   Float     @map("avg_co2_per_shipment")
  avgCo2PerKm         Float     @map("avg_co2_per_km")
  avgCo2PerKgCargo    Float?    @map("avg_co2_per_kg_cargo")

  // By Fuel Type
  dieselCo2Kg         Float     @default(0) @map("diesel_co2_kg")
  petrolCo2Kg         Float     @default(0) @map("petrol_co2_kg")
  cngCo2Kg            Float     @default(0) @map("cng_co2_kg")
  electricCo2Kg       Float     @default(0) @map("electric_co2_kg")

  // Comparison
  previousDayCo2Kg    Float?    @map("previous_day_co2_kg")
  changePercent       Float?    @map("change_percent")

  createdAt           DateTime  @default(now()) @map("created_at")

  @@unique([summaryDate, entityType, entityId])
  @@index([summaryDate])
  @@index([entityType, entityId])
  @@map("carbon_daily_summaries")
}

// Green Logistics Initiatives
model GreenInitiative {
  id                  String    @id @default(cuid())

  name                String
  description         String
  category            String    // ELECTRIC_FLEET, ROUTE_OPTIMIZATION, PACKAGING, CONSOLIDATION, CARBON_OFFSET

  // Target
  targetCo2ReductionKg Float    @map("target_co2_reduction_kg")
  targetDate          DateTime  @map("target_date")

  // Progress
  currentReductionKg  Float     @default(0) @map("current_reduction_kg")
  progressPercent     Float     @default(0) @map("progress_percent")

  // Status
  status              String    @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, ON_HOLD

  // Tracking
  startDate           DateTime? @map("start_date")
  completedDate       DateTime? @map("completed_date")

  // Costs & Savings
  investmentCost      Float?    @map("investment_cost")
  operationalSavings  Float?    @map("operational_savings")
  paybackPeriodMonths Int?      @map("payback_period_months")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([category, status])
  @@map("green_initiatives")
}

// ============================================
// INSURANCE MODULE
// ============================================

// Insurance Policy
model InsurancePolicy {
  id                  String    @id @default(cuid())
  clientId            String?   @map("client_id") // null for default policy

  policyNumber        String    @unique @map("policy_number")
  insurerName         String    @map("insurer_name")

  // Policy Details
  policyType          String    @map("policy_type") // TRANSIT, WAREHOUSE, COMPREHENSIVE
  coverageType        String    @map("coverage_type") // ALL_RISK, NAMED_PERILS, BASIC

  // Coverage
  maxCoveragePerShipment Float  @map("max_coverage_per_shipment")
  maxCoverageTotal    Float     @map("max_coverage_total")
  deductibleAmount    Float     @default(0) @map("deductible_amount")
  deductiblePercent   Float     @default(0) @map("deductible_percent")

  // Premium
  premiumRate         Float     @map("premium_rate") // Percentage of declared value
  minimumPremium      Float     @map("minimum_premium")

  // Coverage Exclusions (JSON)
  exclusions          String?   // JSON array

  // Validity
  startDate           DateTime  @map("start_date")
  endDate             DateTime  @map("end_date")
  isActive            Boolean   @default(true) @map("is_active")

  // Terms
  claimSettlementDays Int       @default(30) @map("claim_settlement_days")
  termsConditions     String?   @map("terms_conditions")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  claims              InsuranceClaim[]

  @@index([clientId, isActive])
  @@index([policyType])
  @@map("insurance_policies")
}

// Shipment Insurance Record
model ShipmentInsurance {
  id                  String    @id @default(cuid())
  shipmentId          String    @unique @map("shipment_id")
  policyId            String    @map("policy_id")

  // Coverage Details
  declaredValue       Float     @map("declared_value")
  insuredValue        Float     @map("insured_value")
  premiumAmount       Float     @map("premium_amount")

  // Status
  status              String    @default("ACTIVE") // ACTIVE, CLAIM_FILED, CLAIM_SETTLED, EXPIRED, CANCELLED

  // Certificate
  certificateNumber   String?   @unique @map("certificate_number")
  certificateUrl      String?   @map("certificate_url")

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([policyId])
  @@index([status])
  @@map("shipment_insurances")
}

// Insurance Claim
model InsuranceClaim {
  id                  String    @id @default(cuid())
  policyId            String    @map("policy_id")
  shipmentId          String    @map("shipment_id")

  claimNumber         String    @unique @map("claim_number")

  // Claim Details
  claimType           String    @map("claim_type") // DAMAGE, LOSS, THEFT, DELAY, PARTIAL_LOSS
  claimReason         String    @map("claim_reason")
  description         String

  // Amount
  claimAmount         Float     @map("claim_amount")
  declaredValue       Float     @map("declared_value")
  approvedAmount      Float?    @map("approved_amount")
  deductibleApplied   Float?    @map("deductible_applied")
  settledAmount       Float?    @map("settled_amount")

  // Evidence
  incidentDate        DateTime  @map("incident_date")
  incidentLocation    String?   @map("incident_location")
  photos              String?   // JSON array of photo URLs
  documents           String?   // JSON array of document URLs
  policeReportNumber  String?   @map("police_report_number")
  policeReportUrl     String?   @map("police_report_url")

  // Status
  status              String    @default("FILED") // FILED, UNDER_REVIEW, ADDITIONAL_INFO_REQUIRED, APPROVED, REJECTED, SETTLED, CLOSED

  // Processing
  filedAt             DateTime  @default(now()) @map("filed_at")
  filedBy             String    @map("filed_by")
  reviewedBy          String?   @map("reviewed_by")
  reviewedAt          DateTime? @map("reviewed_at")
  approvedBy          String?   @map("approved_by")
  approvedAt          DateTime? @map("approved_at")
  settledAt           DateTime? @map("settled_at")

  // Rejection
  rejectionReason     String?   @map("rejection_reason")

  // Payment
  paymentRef          String?   @map("payment_ref")
  paymentMode         String?   @map("payment_mode")
  paymentDate         DateTime? @map("payment_date")

  // Communication
  claimantName        String    @map("claimant_name")
  claimantPhone       String    @map("claimant_phone")
  claimantEmail       String?   @map("claimant_email")

  notes               String?

  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  policy              InsurancePolicy @relation(fields: [policyId], references: [id])

  @@index([policyId, status])
  @@index([shipmentId])
  @@index([status])
  @@map("insurance_claims")
}

// ============================================
// ULIP INTEGRATION (Unified Logistics Interface Platform)
// Government logistics platform - Vehicle verification & Cargo tracking
// ============================================

model ULIPIntegration {
  id                    String    @id @default(cuid())
  clientId              String    @map("client_id")

  // ULIP Credentials
  ulipUserName          String    @map("ulip_user_name")
  ulipProviderId        String?   @map("ulip_provider_id")

  // Integration Status
  isActive              Boolean   @default(true) @map("is_active")
  lastSyncAt            DateTime? @map("last_sync_at")
  syncStatus            String    @default("PENDING") @map("sync_status") // PENDING, IN_PROGRESS, SUCCESS, FAILED

  // API Configuration
  apiEndpoint           String?   @map("api_endpoint")
  apiKey                String?   @map("api_key")

  // Vehicle Details for ULIP
  registeredVehicles    String?   @map("registered_vehicles") // JSON array of vehicle registration numbers

  // Error Tracking
  lastErrorMessage      String?   @map("last_error_message")
  lastErrorAt           DateTime? @map("last_error_at")
  retryCount            Int       @default(0) @map("retry_count")

  // Tracking Configuration
  enableCargoTracking   Boolean   @default(true) @map("enable_cargo_tracking")
  trackingUpdateFreq    Int       @default(300) @map("tracking_update_freq") // In seconds

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  client                Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  vehicleVerifications  ULIPVehicleVerification[]
  cargoTrackings        ULIPCargoTracking[]
  syncLogs              ULIPSyncLog[]

  @@index([clientId])
  @@index([isActive, lastSyncAt])
  @@map("ulip_integrations")
}

model ULIPVehicleVerification {
  id                    String    @id @default(cuid())
  ulipIntegrationId     String    @map("ulip_integration_id")
  vehicleId             String?   @map("vehicle_id")

  // Vehicle Verification Details
  registrationNo        String    @map("registration_no")
  rcNumber              String?   @map("rc_number")
  chasisNumber          String?   @map("chasis_number")
  engineNumber          String?   @map("engine_number")

  // Verification Status
  verificationStatus    String    @default("PENDING") // PENDING, VERIFIED, FAILED, EXPIRED
  verifiedAt            DateTime? @map("verified_at")
  expiryAt              DateTime? @map("expiry_at")

  // ULIP Response
  ulipRefNumber         String?   @map("ulip_ref_number")
  ulipResponse          String?   @map("ulip_response") // JSON response from ULIP

  // Verification Details
  ownerName             String?   @map("owner_name")
  ownerPhone            String?   @map("owner_phone")
  vehicleClass          String?   @map("vehicle_class")
  fuelType              String?   @map("fuel_type")
  insuranceProvider     String?   @map("insurance_provider")
  insurancePolicyNo     String?   @map("insurance_policy_no")
  insuranceExpiry       DateTime? @map("insurance_expiry")
  fitnessExpiry         DateTime? @map("fitness_expiry")
  permitExpiry          DateTime? @map("permit_expiry")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  ulipIntegration       ULIPIntegration @relation(fields: [ulipIntegrationId], references: [id], onDelete: Cascade)

  @@index([ulipIntegrationId])
  @@index([vehicleId])
  @@index([registrationNo])
  @@index([verificationStatus])
  @@map("ulip_vehicle_verifications")
}

model ULIPCargoTracking {
  id                    String    @id @default(cuid())
  ulipIntegrationId     String    @map("ulip_integration_id")
  shipmentId            String?   @map("shipment_id")
  tripId                String?   @map("trip_id")

  // Tracking Details
  cargoTrackingId       String    @unique @map("cargo_tracking_id")
  trackingStatus        String    @default("ACTIVE") // ACTIVE, COMPLETED, FAILED

  // Journey Details
  originLocation        String    @map("origin_location")
  destinationLocation   String    @map("destination_location")
  currentLocation       String?   @map("current_location")

  // GPS Coordinates
  lastLatitude          Float?    @map("last_latitude")
  lastLongitude         Float?    @map("last_longitude")
  lastLocationUpdate    DateTime? @map("last_location_update")

  // Cargo Details
  cargoWeight           Float?    @map("cargo_weight")
  cargoValue            Float?    @map("cargo_value")
  sealNumber            String?   @map("seal_number")
  vehicleNo             String?   @map("vehicle_no")

  // Timestamps
  startedAt             DateTime  @default(now()) @map("started_at")
  expectedCompletionAt  DateTime? @map("expected_completion_at")
  completedAt           DateTime? @map("completed_at")

  // ULIP Response
  ulipRefNumber         String?   @map("ulip_ref_number")
  lastSyncAt            DateTime? @map("last_sync_at")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  ulipIntegration       ULIPIntegration @relation(fields: [ulipIntegrationId], references: [id], onDelete: Cascade)

  @@index([ulipIntegrationId])
  @@index([shipmentId])
  @@index([tripId])
  @@index([trackingStatus])
  @@map("ulip_cargo_tracking")
}

model ULIPSyncLog {
  id                    String    @id @default(cuid())
  ulipIntegrationId     String    @map("ulip_integration_id")

  syncType              String    @map("sync_type") // VEHICLE_VERIFICATION, CARGO_TRACKING, FUEL_STATION
  status                String    // SUCCESS, FAILED, PARTIAL
  recordsProcessed      Int       @default(0) @map("records_processed")
  recordsFailed         Int       @default(0) @map("records_failed")

  errorMessage          String?   @map("error_message")
  response              String?   // JSON response

  startedAt             DateTime  @default(now()) @map("started_at")
  completedAt           DateTime? @map("completed_at")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  ulipIntegration       ULIPIntegration @relation(fields: [ulipIntegrationId], references: [id], onDelete: Cascade)

  @@index([ulipIntegrationId])
  @@index([syncType, status])
  @@map("ulip_sync_logs")
}

// ============================================
// E-WAY BILL (GST Compliance for Goods Movement > 50,000)
// ============================================

model EwayBill {
  id                    String    @id @default(cuid())
  clientId              String    @map("client_id")
  shipmentId            String?   @map("shipment_id")
  invoiceId             String?   @map("invoice_id")

  // E-way Bill Details
  ewayBillNumber        String?   @unique @map("eway_bill_number")
  ewayBillDate          DateTime? @map("eway_bill_date")

  // Document Type
  docType               String    @default("INV") @map("doc_type") // INV, BOE, BIL, CHL, CNT, OTH
  docNumber             String    @map("doc_number")
  docDate               DateTime  @map("doc_date")

  // GSTIN Details
  supplierGstin         String    @map("supplier_gstin")
  supplierName          String    @map("supplier_name")
  supplierAddress       String    @map("supplier_address")
  supplierPlace         String    @map("supplier_place")
  supplierState         String    @map("supplier_state")
  supplierPincode       String    @map("supplier_pincode")

  recipientGstin        String?   @map("recipient_gstin")
  recipientName         String    @map("recipient_name")
  recipientAddress      String    @map("recipient_address")
  recipientPlace        String    @map("recipient_place")
  recipientState        String    @map("recipient_state")
  recipientPincode      String    @map("recipient_pincode")

  transporterGstin      String?   @map("transporter_gstin")
  transporterName       String?   @map("transporter_name")

  // Shipment Reference
  awbNumber             String?   @map("awb_number")

  // Goods Details
  goodsDescription      String    @map("goods_description")
  goodsValue            Float     @map("goods_value")
  hsnCode               String?   @map("hsn_code")
  quantity              Float?
  unit                  String?   // KGS, MTR, NOS, etc.

  // GST Details
  taxableValue          Float     @map("taxable_value")
  sgstRate              Float     @default(0) @map("sgst_rate")
  cgstRate              Float     @default(0) @map("cgst_rate")
  igstRate              Float     @default(0) @map("igst_rate")
  cessRate              Float     @default(0) @map("cess_rate")
  sgstAmount            Float     @default(0) @map("sgst_amount")
  cgstAmount            Float     @default(0) @map("cgst_amount")
  igstAmount            Float     @default(0) @map("igst_amount")
  cessAmount            Float     @default(0) @map("cess_amount")
  totalGstAmount        Float     @default(0) @map("total_gst_amount")
  totalInvoiceValue     Float     @map("total_invoice_value")

  // Transportation Details
  transportMode         String    @default("ROAD") @map("transport_mode") // ROAD, RAIL, AIR, SHIP
  vehicleNo             String?   @map("vehicle_no")
  vehicleType           String?   @map("vehicle_type") // REG, ODC
  transactionType       String    @default("REGULAR") @map("transaction_type") // REGULAR, BILLTO_SHIPTO, BILLFRM_DISP, COMBO
  subSupplyType         String    @default("SUPPLY") @map("sub_supply_type") // SUPPLY, IMPORT, EXPORT, JOB_WORK, etc.

  // Distance
  approxDistance        Float?    @map("approx_distance") // in KMs

  // Validity
  validFrom             DateTime? @map("valid_from")
  validUpto             DateTime? @map("valid_upto")

  // Status
  status                String    @default("DRAFT") // DRAFT, GENERATED, ACTIVE, CANCELLED, EXPIRED, EXTENDED
  generatedAt           DateTime? @map("generated_at")
  cancelledAt           DateTime? @map("cancelled_at")
  cancellationReason    String?   @map("cancellation_reason")
  extendedAt            DateTime? @map("extended_at")
  extendedUpto          DateTime? @map("extended_upto")
  extensionReason       String?   @map("extension_reason")

  // NIC/GST Portal Response
  nicEwbNo              String?   @map("nic_ewb_no")
  nicStatus             String?   @map("nic_status")
  nicErrorMessage       String?   @map("nic_error_message")

  // Part-B Updates (Vehicle changes)
  partBUpdates          String?   @map("part_b_updates") // JSON array of vehicle updates

  // Consolidated E-way Bill
  isConsolidated        Boolean   @default(false) @map("is_consolidated")
  consolidatedEwbNo     String?   @map("consolidated_ewb_no")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  // Relations
  client                Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items                 EwayBillItem[]

  @@index([clientId])
  @@index([shipmentId])
  @@index([ewayBillNumber])
  @@index([status, validUpto])
  @@map("eway_bills")
}

model EwayBillItem {
  id                    String    @id @default(cuid())
  ewayBillId            String    @map("eway_bill_id")

  itemNo                Int       @map("item_no")
  productName           String    @map("product_name")
  productDesc           String?   @map("product_desc")
  hsnCode               String    @map("hsn_code")
  quantity              Float
  unit                  String    // UQC
  taxableValue          Float     @map("taxable_value")
  sgstRate              Float     @default(0) @map("sgst_rate")
  cgstRate              Float     @default(0) @map("cgst_rate")
  igstRate              Float     @default(0) @map("igst_rate")
  cessRate              Float     @default(0) @map("cess_rate")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  ewayBill              EwayBill  @relation(fields: [ewayBillId], references: [id], onDelete: Cascade)

  @@index([ewayBillId])
  @@map("eway_bill_items")
}

// ============================================
// E-INVOICE (GST B2B Invoicing - IRP Portal)
// Mandatory for B2B turnover > 5 Crore
// ============================================

model EInvoice {
  id                    String    @id @default(cuid())
  clientId              String    @map("client_id")
  invoiceId             String    @map("invoice_id")

  // IRN (Invoice Reference Number) from IRP
  irn                   String?   @unique @map("irn")
  ackNum                String?   @map("ack_num")
  ackDate               DateTime? @map("ack_date")

  // Document Details
  docType               String    @default("INV") @map("doc_type") // INV, CRN, DBN
  docNumber             String    @map("doc_number")
  docDate               DateTime  @map("doc_date")

  // Supplier Details (Seller)
  supplierGstin         String    @map("supplier_gstin")
  supplierLegalName     String    @map("supplier_legal_name")
  supplierTradeName     String?   @map("supplier_trade_name")
  supplierAddress1      String    @map("supplier_address1")
  supplierAddress2      String?   @map("supplier_address2")
  supplierPlace         String    @map("supplier_place")
  supplierState         String    @map("supplier_state")
  supplierPincode       String    @map("supplier_pincode")
  supplierPhone         String?   @map("supplier_phone")
  supplierEmail         String?   @map("supplier_email")

  // Buyer Details
  buyerGstin            String    @map("buyer_gstin")
  buyerLegalName        String    @map("buyer_legal_name")
  buyerTradeName        String?   @map("buyer_trade_name")
  buyerAddress1         String    @map("buyer_address1")
  buyerAddress2         String?   @map("buyer_address2")
  buyerPlace            String    @map("buyer_place")
  buyerState            String    @map("buyer_state")
  buyerPincode          String    @map("buyer_pincode")
  buyerPhone            String?   @map("buyer_phone")
  buyerEmail            String?   @map("buyer_email")
  buyerPos              String?   @map("buyer_pos") // Place of Supply

  // Ship To (if different)
  shipToGstin           String?   @map("ship_to_gstin")
  shipToLegalName       String?   @map("ship_to_legal_name")
  shipToAddress1        String?   @map("ship_to_address1")
  shipToAddress2        String?   @map("ship_to_address2")
  shipToPlace           String?   @map("ship_to_place")
  shipToState           String?   @map("ship_to_state")
  shipToPincode         String?   @map("ship_to_pincode")

  // Dispatch From (if different)
  dispatchFromGstin     String?   @map("dispatch_from_gstin")
  dispatchFromName      String?   @map("dispatch_from_name")
  dispatchFromAddress1  String?   @map("dispatch_from_address1")
  dispatchFromAddress2  String?   @map("dispatch_from_address2")
  dispatchFromPlace     String?   @map("dispatch_from_place")
  dispatchFromState     String?   @map("dispatch_from_state")
  dispatchFromPincode   String?   @map("dispatch_from_pincode")

  // Value Details
  totalAssessableValue  Float     @map("total_assessable_value")
  totalCgstValue        Float     @default(0) @map("total_cgst_value")
  totalSgstValue        Float     @default(0) @map("total_sgst_value")
  totalIgstValue        Float     @default(0) @map("total_igst_value")
  totalCessValue        Float     @default(0) @map("total_cess_value")
  totalStateCessValue   Float     @default(0) @map("total_state_cess_value")
  discount              Float     @default(0)
  otherCharges          Float     @default(0) @map("other_charges")
  roundOffAmount        Float     @default(0) @map("round_off_amount")
  totalInvoiceValue     Float     @map("total_invoice_value")

  // Payment Details
  paymentMode           String?   @map("payment_mode") // CASH, CREDIT, DIRECT_TRANSFER
  paymentTerms          String?   @map("payment_terms")
  paymentDueDate        DateTime? @map("payment_due_date")
  bankDetails           String?   @map("bank_details") // JSON

  // Reference Documents
  priorDocRef           String?   @map("prior_doc_ref") // For credit/debit notes
  priorDocDate          DateTime? @map("prior_doc_date")
  contractRef           String?   @map("contract_ref")
  poRef                 String?   @map("po_ref")

  // Status
  status                String    @default("DRAFT") // DRAFT, PENDING, GENERATED, CANCELLED, FAILED
  generatedAt           DateTime? @map("generated_at")
  cancelledAt           DateTime? @map("cancelled_at")
  cancellationReason    String?   @map("cancellation_reason")

  // IRP Portal Response
  irpStatus             String?   @map("irp_status")
  irpErrorCode          String?   @map("irp_error_code")
  irpErrorMessage       String?   @map("irp_error_message")
  signedInvoice         String?   @map("signed_invoice") // Signed JSON from IRP
  signedQRCode          String?   @map("signed_qr_code") // QR Code data

  // Files
  pdfUrl                String?   @map("pdf_url")
  jsonUrl               String?   @map("json_url")
  qrCodeUrl             String?   @map("qr_code_url")

  // Linked E-way Bill
  ewayBillNo            String?   @map("eway_bill_no")
  ewayBillDate          DateTime? @map("eway_bill_date")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  createdBy             String?   @map("created_by")

  // Relations
  client                Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items                 EInvoiceItem[]

  @@index([clientId])
  @@index([invoiceId])
  @@index([irn])
  @@index([status])
  @@index([docDate])
  @@map("e_invoices")
}

model EInvoiceItem {
  id                    String    @id @default(cuid())
  einvoiceId            String    @map("einvoice_id")

  slNo                  Int       @map("sl_no")
  productDesc           String    @map("product_desc")
  isService             Boolean   @default(false) @map("is_service")
  hsnCode               String    @map("hsn_code")

  // Quantity
  quantity              Float
  unit                  String    // UQC - Unit Quantity Code
  unitPrice             Float     @map("unit_price")
  grossAmount           Float     @map("gross_amount")
  discount              Float     @default(0)
  preTaxValue           Float     @map("pre_tax_value")

  // Tax Rates
  cgstRate              Float     @default(0) @map("cgst_rate")
  sgstRate              Float     @default(0) @map("sgst_rate")
  igstRate              Float     @default(0) @map("igst_rate")
  cessRate              Float     @default(0) @map("cess_rate")
  stateCessRate         Float     @default(0) @map("state_cess_rate")

  // Tax Amounts
  cgstAmount            Float     @default(0) @map("cgst_amount")
  sgstAmount            Float     @default(0) @map("sgst_amount")
  igstAmount            Float     @default(0) @map("igst_amount")
  cessAmount            Float     @default(0) @map("cess_amount")
  stateCessAmount       Float     @default(0) @map("state_cess_amount")

  totalItemValue        Float     @map("total_item_value")

  // Batch Details
  batchNo               String?   @map("batch_no")
  expiryDate            DateTime? @map("expiry_date")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  einvoice              EInvoice  @relation(fields: [einvoiceId], references: [id], onDelete: Cascade)

  @@index([einvoiceId])
  @@map("e_invoice_items")
}

// ============================================
// PAYMENT GATEWAY INTEGRATION
// Online payment processing (Razorpay, PayU, etc.)
// ============================================

model PaymentGateway {
  id                    String    @id @default(cuid())
  clientId              String?   @map("client_id") // Optional - can be global

  // Gateway Configuration
  gatewayType           String    @map("gateway_type") // RAZORPAY, PAYU, CCAVENUE, STRIPE, PHONEPE, PAYTM
  gatewayName           String    @map("gateway_name")
  displayName           String    @map("display_name")
  description           String?

  // API Credentials
  apiKey                String    @map("api_key")
  apiSecret             String    @map("api_secret")
  merchantId            String?   @map("merchant_id")
  salt                  String?   // For PayU

  // Mode
  mode                  String    @default("TEST") // TEST, LIVE
  isActive              Boolean   @default(true) @map("is_active")
  isPrimary             Boolean   @default(false) @map("is_primary")
  priority              Int       @default(1)

  // Supported Payment Methods
  supportsCreditCard    Boolean   @default(true) @map("supports_credit_card")
  supportsDebitCard     Boolean   @default(true) @map("supports_debit_card")
  supportsNetBanking    Boolean   @default(true) @map("supports_net_banking")
  supportsUPI           Boolean   @default(true) @map("supports_upi")
  supportsWallet        Boolean   @default(true) @map("supports_wallet")
  supportsEMI           Boolean   @default(false) @map("supports_emi")
  supportsQRCode        Boolean   @default(false) @map("supports_qr_code")

  // Webhook Configuration
  webhookUrl            String?   @map("webhook_url")
  webhookSecret         String?   @map("webhook_secret")

  // Fee Configuration
  transactionFeePercent Float     @default(2) @map("transaction_fee_percent")
  flatFeePerTxn         Float     @default(0) @map("flat_fee_per_txn")
  gstOnFee              Float     @default(18) @map("gst_on_fee")
  minimumAmount         Float     @default(1) @map("minimum_amount")
  maximumAmount         Float     @default(10000000) @map("maximum_amount")

  // Settlement
  settlementType        String    @default("T+2") @map("settlement_type") // T+1, T+2, T+3, INSTANT
  settlementDays        Int       @default(2) @map("settlement_days")
  bankAccountId         String?   @map("bank_account_id")

  // Monitoring
  lastHealthCheckAt     DateTime? @map("last_health_check_at")
  healthStatus          String    @default("HEALTHY") @map("health_status") // HEALTHY, DEGRADED, DOWN
  lastErrorMessage      String?   @map("last_error_message")
  lastErrorAt           DateTime? @map("last_error_at")

  // Statistics
  totalTransactions     Int       @default(0) @map("total_transactions")
  successfulTxns        Int       @default(0) @map("successful_txns")
  totalAmountProcessed  Float     @default(0) @map("total_amount_processed")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  client                Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  transactions          PaymentTransaction[]
  webhookLogs           PaymentWebhookLog[]
  settlements           PaymentSettlement[]

  @@index([gatewayType])
  @@index([isActive, isPrimary])
  @@index([clientId])
  @@map("payment_gateways")
}

model PaymentTransaction {
  id                    String    @id @default(cuid())
  paymentGatewayId      String    @map("payment_gateway_id")

  // Transaction Reference
  transactionId         String    @unique @map("transaction_id")
  gatewayOrderId        String?   @map("gateway_order_id") // Order ID from gateway
  gatewayPaymentId      String?   @map("gateway_payment_id") // Payment ID from gateway

  // Order/Invoice Reference
  orderId               String?   @map("order_id")
  invoiceId             String?   @map("invoice_id")
  referenceType         String    @map("reference_type") // INVOICE, COD_COLLECTION, FREIGHT, SUBSCRIPTION
  referenceId           String    @map("reference_id")

  // Customer Details
  customerId            String?   @map("customer_id")
  customerName          String    @map("customer_name")
  customerEmail         String    @map("customer_email")
  customerPhone         String    @map("customer_phone")

  // Amount Details
  amount                Float
  currency              String    @default("INR")
  convenienceFee        Float     @default(0) @map("convenience_fee")
  gstOnFee              Float     @default(0) @map("gst_on_fee")
  totalAmount           Float     @map("total_amount")

  // Payment Method Details
  paymentMethod         String    @map("payment_method") // CARD, NET_BANKING, UPI, WALLET, EMI, QR
  cardLast4             String?   @map("card_last_4")
  cardNetwork           String?   @map("card_network") // VISA, MASTERCARD, AMEX, RUPAY
  cardType              String?   @map("card_type") // CREDIT, DEBIT
  bankCode              String?   @map("bank_code")
  bankName              String?   @map("bank_name")
  walletName            String?   @map("wallet_name")
  upiId                 String?   @map("upi_id")
  emiMonths             Int?      @map("emi_months")

  // Transaction Status
  status                String    @default("INITIATED") // INITIATED, PENDING, AUTHORIZED, CAPTURED, SUCCESS, FAILED, CANCELLED, REFUNDED
  statusCode            String?   @map("status_code")
  statusMessage         String?   @map("status_message")
  failureReason         String?   @map("failure_reason")

  // Timestamps
  initiatedAt           DateTime  @default(now()) @map("initiated_at")
  authorizedAt          DateTime? @map("authorized_at")
  capturedAt            DateTime? @map("captured_at")
  completedAt           DateTime? @map("completed_at")
  failedAt              DateTime? @map("failed_at")

  // Gateway Response
  gatewayResponse       String?   @map("gateway_response") // Full JSON response

  // Settlement
  settlementId          String?   @map("settlement_id")
  settledAt             DateTime? @map("settled_at")

  // Refund Details
  refundAmount          Float     @default(0) @map("refund_amount")
  refundStatus          String?   @map("refund_status")
  refundId              String?   @map("refund_id")
  refundedAt            DateTime? @map("refunded_at")
  refundReason          String?   @map("refund_reason")

  // Reconciliation
  reconciliationStatus  String    @default("PENDING") @map("reconciliation_status") // PENDING, MATCHED, MISMATCHED, DISPUTED
  reconciledAt          DateTime? @map("reconciled_at")
  reconciledBy          String?   @map("reconciled_by")

  // Metadata
  metadata              String?   // JSON
  notes                 String?
  ipAddress             String?   @map("ip_address")
  userAgent             String?   @map("user_agent")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  paymentGateway        PaymentGateway @relation(fields: [paymentGatewayId], references: [id], onDelete: Cascade)

  @@index([paymentGatewayId])
  @@index([orderId])
  @@index([invoiceId])
  @@index([customerId])
  @@index([status])
  @@index([completedAt])
  @@map("payment_transactions")
}

model PaymentWebhookLog {
  id                    String    @id @default(cuid())
  paymentGatewayId      String    @map("payment_gateway_id")

  // Webhook Details
  eventType             String    @map("event_type") // payment.authorized, payment.captured, payment.failed, refund.processed
  eventId               String?   @map("event_id")

  // Transaction Reference
  transactionId         String?   @map("transaction_id")
  gatewayPaymentId      String?   @map("gateway_payment_id")

  // Payload
  payload               String    // Full JSON payload
  signature             String?
  isSignatureValid      Boolean   @default(true) @map("is_signature_valid")

  // Processing
  status                String    @default("RECEIVED") // RECEIVED, PROCESSING, PROCESSED, FAILED, IGNORED
  processedAt           DateTime? @map("processed_at")
  errorMessage          String?   @map("error_message")

  // Retry
  retryCount            Int       @default(0) @map("retry_count")
  lastRetryAt           DateTime? @map("last_retry_at")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  paymentGateway        PaymentGateway @relation(fields: [paymentGatewayId], references: [id], onDelete: Cascade)

  @@index([paymentGatewayId])
  @@index([eventType])
  @@index([transactionId])
  @@index([status])
  @@map("payment_webhook_logs")
}

model PaymentSettlement {
  id                    String    @id @default(cuid())
  paymentGatewayId      String    @map("payment_gateway_id")

  // Settlement Details
  settlementId          String    @unique @map("settlement_id")
  settlementDate        DateTime  @map("settlement_date")

  // Period
  periodStart           DateTime  @map("period_start")
  periodEnd             DateTime  @map("period_end")

  // Amounts
  grossAmount           Float     @map("gross_amount")
  fees                  Float     @default(0)
  tax                   Float     @default(0)
  adjustments           Float     @default(0)
  netAmount             Float     @map("net_amount")

  // Transaction Count
  transactionCount      Int       @default(0) @map("transaction_count")
  refundCount           Int       @default(0) @map("refund_count")

  // Status
  status                String    @default("PENDING") // PENDING, PROCESSED, FAILED, REVERSED
  processedAt           DateTime? @map("processed_at")
  bankTransactionRef    String?   @map("bank_transaction_ref")
  utrNumber             String?   @map("utr_number")

  // Reconciliation
  reconciliationStatus  String    @default("PENDING") @map("reconciliation_status")
  reconciledAt          DateTime? @map("reconciled_at")
  reconciledBy          String?   @map("reconciled_by")
  variance              Float     @default(0)
  varianceReason        String?   @map("variance_reason")

  // Breakdown
  breakdown             String?   // JSON breakdown

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  paymentGateway        PaymentGateway @relation(fields: [paymentGatewayId], references: [id], onDelete: Cascade)

  @@index([paymentGatewayId])
  @@index([settlementDate])
  @@index([status])
  @@map("payment_settlements")
}

// ============================================
// PHASE 2: TRAFFIC-BASED ROUTE OPTIMIZATION
// ============================================

model TrafficRouteCalculation {
  id                    String    @id @default(cuid())

  // Route Details
  originLat             Float     @map("origin_lat")
  originLng             Float     @map("origin_lng")
  destinationLat        Float     @map("destination_lat")
  destinationLng        Float     @map("destination_lng")

  // Waypoints (JSON array of {lat, lng, address})
  waypoints             String?   // JSON array

  // Route Results
  distanceMeters        Int       @map("distance_meters")
  durationMinutes       Int       @map("duration_minutes")
  durationInTraffic     Int       @map("duration_in_traffic") // With current traffic
  polyline              String?   // Encoded polyline

  // Traffic Conditions
  trafficLevel          String    @default("NORMAL") // LIGHT, NORMAL, HEAVY, SEVERE
  congestionScore       Float     @default(0) @map("congestion_score") // 0-100

  // Toll & Cost Estimation
  estimatedTollCost     Float     @default(0) @map("estimated_toll_cost")
  estimatedFuelCost     Float     @default(0) @map("estimated_fuel_cost")
  tollPlazaCount        Int       @default(0) @map("toll_plaza_count")

  // Weather Impact
  weatherCondition      String?   @map("weather_condition") // CLEAR, RAIN, FOG, STORM
  weatherDelayMinutes   Int       @default(0) @map("weather_delay_minutes")

  // Optimization Details
  optimizationType      String    @default("FASTEST") // FASTEST, SHORTEST, CHEAPEST, BALANCED
  alternateRoutes       String?   @map("alternate_routes") // JSON array of alternate routes

  // API Provider
  provider              String    @default("GOOGLE") // GOOGLE, HERE, MAPBOX
  providerRouteId       String?   @map("provider_route_id")

  // Associated Trip/Shipment
  tripId                String?   @map("trip_id")
  shipmentId            String?   @map("shipment_id")

  calculatedAt          DateTime  @default(now()) @map("calculated_at")
  validUntil            DateTime  @map("valid_until")

  @@index([tripId])
  @@index([shipmentId])
  @@index([calculatedAt])
  @@map("traffic_route_calculations")
}

model TollPlaza {
  id                    String    @id @default(cuid())

  // Plaza Details
  name                  String
  code                  String    @unique
  highway               String?   // NH-48, NH-44, etc.

  // Location
  latitude              Float
  longitude             Float
  state                 String

  // Rates (in Rs)
  carSingleTrip         Float     @default(0) @map("car_single_trip")
  carReturnTrip         Float     @default(0) @map("car_return_trip")
  lcvSingleTrip         Float     @default(0) @map("lcv_single_trip")
  lcvReturnTrip         Float     @default(0) @map("lcv_return_trip")
  busTruckSingleTrip    Float     @default(0) @map("bus_truck_single_trip")
  busTruckReturnTrip    Float     @default(0) @map("bus_truck_return_trip")
  heavyVehicleSingleTrip Float    @default(0) @map("heavy_vehicle_single_trip")
  heavyVehicleReturnTrip Float    @default(0) @map("heavy_vehicle_return_trip")

  // FASTag Integration
  fastagEnabled         Boolean   @default(true) @map("fastag_enabled")
  fastagPlazaCode       String?   @map("fastag_plaza_code")

  isActive              Boolean   @default(true) @map("is_active")
  lastUpdated           DateTime  @default(now()) @map("last_updated")

  @@index([state])
  @@index([highway])
  @@map("toll_plazas")
}

model WeatherAlert {
  id                    String    @id @default(cuid())

  // Location
  region                String
  state                 String
  city                  String?
  latitude              Float?
  longitude             Float?

  // Alert Details
  alertType             String    // RAIN, STORM, FOG, FLOOD, CYCLONE, HEATWAVE
  severity              String    @default("MODERATE") // LOW, MODERATE, HIGH, SEVERE
  headline              String
  description           String?

  // Impact
  impactOnDelivery      String?   @map("impact_on_delivery") // MINOR, MODERATE, MAJOR, CRITICAL
  suggestedDelayHours   Int       @default(0) @map("suggested_delay_hours")
  affectedRoutes        String?   @map("affected_routes") // JSON array of route IDs

  // Validity
  effectiveFrom         DateTime  @map("effective_from")
  effectiveUntil        DateTime  @map("effective_until")

  // Source
  source                String    @default("IMD") // IMD (India Meteorological Dept), OpenWeather
  sourceAlertId         String?   @map("source_alert_id")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")

  @@index([state, isActive])
  @@index([severity, isActive])
  @@index([effectiveUntil])
  @@map("weather_alerts")
}

model TrafficIncident {
  id                    String    @id @default(cuid())

  // Location
  latitude              Float
  longitude             Float
  roadName              String?   @map("road_name")
  city                  String?
  state                 String?

  // Incident Details
  incidentType          String    // ACCIDENT, CONSTRUCTION, ROAD_CLOSURE, CONGESTION, EVENT
  severity              String    @default("MODERATE") // LOW, MODERATE, HIGH, SEVERE
  description           String?

  // Impact
  delayMinutes          Int       @default(0) @map("delay_minutes")
  lengthMeters          Int       @default(0) @map("length_meters") // Length of affected area
  lanesBlocked          Int       @default(0) @map("lanes_blocked")

  // Validity
  startTime             DateTime  @map("start_time")
  endTime               DateTime? @map("end_time")
  expectedClearTime     DateTime? @map("expected_clear_time")

  // Source
  source                String    @default("GOOGLE") // GOOGLE, HERE, USER_REPORTED
  sourceIncidentId      String?   @map("source_incident_id")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@index([latitude, longitude])
  @@index([state, isActive])
  @@index([incidentType, isActive])
  @@map("traffic_incidents")
}

// ============================================
// PHASE 2: HYPERLOCAL DELIVERY MODULE
// ============================================

model DarkStore {
  id                    String    @id @default(cuid())

  // Store Details
  code                  String    @unique
  name                  String
  type                  String    @default("DARK_STORE") // DARK_STORE, MICRO_FULFILLMENT, STORE_IN_STORE

  // Location
  address               String
  city                  String
  state                 String
  pincode               String
  latitude              Float
  longitude             Float

  // Coverage
  servicePincodes       String    @map("service_pincodes") // JSON array
  serviceRadiusKm       Float     @default(5) @map("service_radius_km")

  // Capacity
  maxOrdersPerHour      Int       @default(50) @map("max_orders_per_hour")
  maxDailyOrders        Int       @default(500) @map("max_daily_orders")
  storageCapacitySqFt   Float     @default(0) @map("storage_capacity_sqft")

  // Operations
  openTime              String    @default("06:00") @map("open_time")
  closeTime             String    @default("23:00") @map("close_time")
  operatingDays         String    @default("MON,TUE,WED,THU,FRI,SAT,SUN") @map("operating_days")

  // Contact
  managerName           String?   @map("manager_name")
  managerPhone          String?   @map("manager_phone")

  // Metrics
  avgPickupTimeMinutes  Float     @default(10) @map("avg_pickup_time_minutes")
  avgDeliveryTimeMinutes Float    @default(20) @map("avg_delivery_time_minutes")
  currentUtilization    Float     @default(0) @map("current_utilization")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  hyperlocalOrders      HyperlocalOrder[]
  riders                HyperlocalRider[]
  inventory             DarkStoreInventory[]

  @@index([city, isActive])
  @@index([pincode])
  @@index([latitude, longitude])
  @@map("dark_stores")
}

model PUDOPoint {
  id                    String    @id @default(cuid())

  // Point Details
  code                  String    @unique
  name                  String
  type                  String    @default("STORE") // STORE, LOCKER, KIRANA, PETROL_PUMP, METRO_STATION

  // Partner
  partnerName           String    @map("partner_name")
  partnerType           String    @map("partner_type") // FRANCHISE, INDEPENDENT, CHAIN

  // Location
  address               String
  landmark              String?
  city                  String
  state                 String
  pincode               String
  latitude              Float
  longitude             Float

  // Capacity
  lockerCount           Int       @default(0) @map("locker_count") // For locker type
  maxHoldDays           Int       @default(7) @map("max_hold_days")
  maxPackageWeight      Float     @default(25) @map("max_package_weight") // kg
  maxPackagesPerDay     Int       @default(100) @map("max_packages_per_day")

  // Operating Hours
  openTime              String    @default("09:00") @map("open_time")
  closeTime             String    @default("21:00") @map("close_time")
  operatingDays         String    @default("MON,TUE,WED,THU,FRI,SAT,SUN") @map("operating_days")

  // Contact
  contactName           String?   @map("contact_name")
  contactPhone          String?   @map("contact_phone")

  // Pricing
  pickupFee             Float     @default(0) @map("pickup_fee")
  dropoffFee            Float     @default(0) @map("dropoff_fee")
  storageFeePday        Float     @default(0) @map("storage_fee_per_day")

  // Metrics
  packagesHeld          Int       @default(0) @map("packages_held")
  successfulPickups     Int       @default(0) @map("successful_pickups")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  packages              PUDOPackage[]

  @@index([city, isActive])
  @@index([pincode])
  @@index([type, isActive])
  @@map("pudo_points")
}

model PUDOPackage {
  id                    String    @id @default(cuid())

  pudoPointId           String    @map("pudo_point_id")
  shipmentId            String?   @map("shipment_id")
  awbNumber             String    @map("awb_number")

  // Package Details
  packageType           String    @default("DROPOFF") // DROPOFF, PICKUP, RETURN
  status                String    @default("PENDING") // PENDING, ARRIVED, READY, COLLECTED, EXPIRED, RETURNED

  // Customer
  customerName          String    @map("customer_name")
  customerPhone         String    @map("customer_phone")
  customerEmail         String?   @map("customer_email")

  // Locker Details (if applicable)
  lockerNumber          String?   @map("locker_number")
  accessCode            String?   @map("access_code")

  // Timing
  arrivedAt             DateTime? @map("arrived_at")
  notifiedAt            DateTime? @map("notified_at")
  collectedAt           DateTime? @map("collected_at")
  expiresAt             DateTime  @map("expires_at")

  // Charges
  storageDays           Int       @default(0) @map("storage_days")
  storageCharge         Float     @default(0) @map("storage_charge")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  pudoPoint             PUDOPoint @relation(fields: [pudoPointId], references: [id], onDelete: Cascade)

  @@index([pudoPointId])
  @@index([awbNumber])
  @@index([status])
  @@index([customerPhone])
  @@map("pudo_packages")
}

model HyperlocalOrder {
  id                    String    @id @default(cuid())

  orderNumber           String    @unique @map("order_number")
  darkStoreId           String    @map("dark_store_id")

  // Order Type
  orderType             String    @default("EXPRESS") // EXPRESS (15-30min), SCHEDULED, SAME_DAY
  priority              String    @default("NORMAL") // LOW, NORMAL, HIGH, CRITICAL

  // Customer Details
  customerId            String?   @map("customer_id")
  customerName          String    @map("customer_name")
  customerPhone         String    @map("customer_phone")
  customerEmail         String?   @map("customer_email")

  // Delivery Address
  deliveryAddress       String    @map("delivery_address")
  deliveryLat           Float     @map("delivery_lat")
  deliveryLng           Float     @map("delivery_lng")
  deliveryPincode       String    @map("delivery_pincode")
  deliveryInstructions  String?   @map("delivery_instructions")

  // Slot & Timing
  slotId                String?   @map("slot_id")
  promisedDeliveryTime  DateTime  @map("promised_delivery_time")
  actualPickupTime      DateTime? @map("actual_pickup_time")
  actualDeliveryTime    DateTime? @map("actual_delivery_time")

  // Items
  itemCount             Int       @default(1) @map("item_count")
  itemDetails           String?   @map("item_details") // JSON
  totalWeight           Float     @default(0) @map("total_weight")

  // Pricing
  itemValue             Float     @default(0) @map("item_value")
  deliveryCharge        Float     @default(0) @map("delivery_charge")
  surgeFee              Float     @default(0) @map("surge_fee")
  discount              Float     @default(0)
  totalAmount           Float     @default(0) @map("total_amount")

  // Payment
  paymentMode           String    @default("PREPAID") // PREPAID, COD
  paymentStatus         String    @default("PENDING") @map("payment_status")
  codAmount             Float     @default(0) @map("cod_amount")
  codCollected          Float     @default(0) @map("cod_collected")

  // Rider Assignment
  riderId               String?   @map("rider_id")
  riderAssignedAt       DateTime? @map("rider_assigned_at")

  // Status
  status                String    @default("PENDING") // PENDING, CONFIRMED, PICKING, PICKED, IN_TRANSIT, DELIVERED, CANCELLED, FAILED
  statusUpdatedAt       DateTime  @default(now()) @map("status_updated_at")
  cancellationReason    String?   @map("cancellation_reason")
  failureReason         String?   @map("failure_reason")

  // POD
  podSignature          String?   @map("pod_signature")
  podPhoto              String?   @map("pod_photo")
  podOtp                String?   @map("pod_otp")
  deliveredTo           String?   @map("delivered_to")

  // Rating
  customerRating        Float?    @map("customer_rating")
  customerFeedback      String?   @map("customer_feedback")

  // Linked Shipment (if any)
  shipmentId            String?   @map("shipment_id")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  darkStore             DarkStore @relation(fields: [darkStoreId], references: [id])
  rider                 HyperlocalRider? @relation(fields: [riderId], references: [id])
  slot                  DeliverySlot? @relation(fields: [slotId], references: [id])

  @@index([darkStoreId])
  @@index([riderId])
  @@index([status])
  @@index([customerPhone])
  @@index([promisedDeliveryTime])
  @@map("hyperlocal_orders")
}

model HyperlocalRider {
  id                    String    @id @default(cuid())

  // Rider Details
  riderCode             String    @unique @map("rider_code")
  name                  String
  phone                 String    @unique
  email                 String?

  // Documents
  aadhaarNumber         String?   @map("aadhaar_number")
  dlNumber              String?   @map("dl_number")
  dlExpiry              DateTime? @map("dl_expiry")

  // Vehicle
  vehicleType           String    @default("BIKE") // BIKE, CYCLE, EV_BIKE, SCOOTER
  vehicleNumber         String?   @map("vehicle_number")
  vehicleModel          String?   @map("vehicle_model")

  // Assignment
  darkStoreId           String?   @map("dark_store_id")
  shiftStart            String?   @map("shift_start")
  shiftEnd              String?   @map("shift_end")

  // Status
  status                String    @default("OFFLINE") // ONLINE, OFFLINE, BUSY, ON_BREAK
  lastLocationLat       Float?    @map("last_location_lat")
  lastLocationLng       Float?    @map("last_location_lng")
  lastLocationTime      DateTime? @map("last_location_time")

  // Metrics
  totalDeliveries       Int       @default(0) @map("total_deliveries")
  todayDeliveries       Int       @default(0) @map("today_deliveries")
  avgRating             Float     @default(5) @map("avg_rating")
  onTimePercentage      Float     @default(100) @map("on_time_percentage")

  // Earnings
  basePay               Float     @default(0) @map("base_pay")
  perDeliveryPay        Float     @default(0) @map("per_delivery_pay")
  incentiveEarned       Float     @default(0) @map("incentive_earned")

  // Bank Details
  bankAccountNumber     String?   @map("bank_account_number")
  bankIfsc              String?   @map("bank_ifsc")
  bankAccountName       String?   @map("bank_account_name")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  darkStore             DarkStore? @relation(fields: [darkStoreId], references: [id])
  orders                HyperlocalOrder[]
  locationHistory       RiderLocationHistory[]

  @@index([darkStoreId])
  @@index([status])
  @@index([phone])
  @@map("hyperlocal_riders")
}

model RiderLocationHistory {
  id                    String    @id @default(cuid())

  riderId               String    @map("rider_id")
  latitude              Float
  longitude             Float
  accuracy              Float?
  speed                 Float?    // km/h
  heading               Float?    // degrees

  // Battery & Device
  batteryLevel          Float?    @map("battery_level")
  isCharging            Boolean   @default(false) @map("is_charging")

  // Context
  orderId               String?   @map("order_id")
  status                String?   // IDLE, EN_ROUTE_PICKUP, AT_PICKUP, EN_ROUTE_DELIVERY, AT_DELIVERY

  timestamp             DateTime  @default(now())

  // Relations
  rider                 HyperlocalRider @relation(fields: [riderId], references: [id], onDelete: Cascade)

  @@index([riderId, timestamp])
  @@index([orderId])
  @@map("rider_location_history")
}

model DeliverySlot {
  id                    String    @id @default(cuid())

  // Slot Details
  name                  String    // "Morning Express", "Afternoon Slot"
  slotType              String    @default("EXPRESS") // EXPRESS, STANDARD, SCHEDULED

  // Time Window
  startTime             String    @map("start_time") // "09:00"
  endTime               String    @map("end_time")   // "11:00"

  // Availability
  applicableDays        String    @default("MON,TUE,WED,THU,FRI,SAT,SUN") @map("applicable_days")
  maxOrdersPerSlot      Int       @default(50) @map("max_orders_per_slot")

  // Pricing
  slotCharge            Float     @default(0) @map("slot_charge")
  surgeMultiplier       Float     @default(1) @map("surge_multiplier")

  // Cutoff
  cutoffMinutes         Int       @default(60) @map("cutoff_minutes") // Order must be placed X mins before slot

  // Pincode/Zone Specific
  applicablePincodes    String?   @map("applicable_pincodes") // JSON array, null = all
  darkStoreIds          String?   @map("dark_store_ids") // JSON array, null = all

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  orders                HyperlocalOrder[]

  @@index([slotType, isActive])
  @@map("delivery_slots")
}

model DarkStoreInventory {
  id                    String    @id @default(cuid())

  darkStoreId           String    @map("dark_store_id")
  sku                   String
  productName           String    @map("product_name")

  // Stock
  quantity              Int       @default(0)
  reservedQuantity      Int       @default(0) @map("reserved_quantity")
  reorderLevel          Int       @default(10) @map("reorder_level")

  // Location
  binLocation           String?   @map("bin_location")

  lastRestockedAt       DateTime? @map("last_restocked_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  darkStore             DarkStore @relation(fields: [darkStoreId], references: [id], onDelete: Cascade)

  @@unique([darkStoreId, sku])
  @@index([darkStoreId])
  @@index([sku])
  @@map("dark_store_inventory")
}

// ============================================
// PHASE 2: E-COMMERCE INTEGRATIONS
// ============================================

model EcommerceIntegration {
  id                    String    @id @default(cuid())

  // Integration Details
  name                  String
  platform              String    // SHOPIFY, WOOCOMMERCE, AMAZON, FLIPKART, MAGENTO, CUSTOM

  // Client
  clientId              String    @map("client_id")

  // Credentials (encrypted)
  apiKey                String?   @map("api_key")
  apiSecret             String?   @map("api_secret")
  accessToken           String?   @map("access_token")
  refreshToken          String?   @map("refresh_token")
  tokenExpiresAt        DateTime? @map("token_expires_at")

  // Platform Specific
  shopUrl               String?   @map("shop_url") // For Shopify/WooCommerce
  sellerId              String?   @map("seller_id") // For Amazon/Flipkart
  marketplaceId         String?   @map("marketplace_id")

  // Webhook URLs
  webhookUrl            String?   @map("webhook_url")
  webhookSecret         String?   @map("webhook_secret")

  // Sync Settings
  autoSyncOrders        Boolean   @default(true) @map("auto_sync_orders")
  autoSyncInventory     Boolean   @default(false) @map("auto_sync_inventory")
  autoUpdateTracking    Boolean   @default(true) @map("auto_update_tracking")
  syncIntervalMinutes   Int       @default(15) @map("sync_interval_minutes")

  // Status Mapping (JSON)
  statusMapping         String?   @map("status_mapping") // Custom status mapping

  // Metrics
  lastSyncAt            DateTime? @map("last_sync_at")
  totalOrdersSynced     Int       @default(0) @map("total_orders_synced")
  syncErrorCount        Int       @default(0) @map("sync_error_count")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  stores                EcommerceStore[]
  orders                EcommerceOrder[]
  syncLogs              EcommerceSyncLog[]

  @@index([clientId])
  @@index([platform, isActive])
  @@map("ecommerce_integrations")
}

model EcommerceStore {
  id                    String    @id @default(cuid())

  integrationId         String    @map("integration_id")

  // Store Details
  storeId               String    @map("store_id") // Platform's store ID
  storeName             String    @map("store_name")
  storeUrl              String?   @map("store_url")

  // Location (for inventory sync)
  warehouseId           String?   @map("warehouse_id")
  hubId                 String?   @map("hub_id")

  // Settings
  defaultShippingMethod String?   @map("default_shipping_method")
  defaultCarrier        String?   @map("default_carrier")
  autoFulfill           Boolean   @default(false) @map("auto_fulfill")

  // Sync
  lastOrderSync         DateTime? @map("last_order_sync")
  lastInventorySync     DateTime? @map("last_inventory_sync")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  integration           EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, storeId])
  @@index([integrationId])
  @@map("ecommerce_stores")
}

model EcommerceOrder {
  id                    String    @id @default(cuid())

  integrationId         String    @map("integration_id")

  // Platform Order Details
  platformOrderId       String    @map("platform_order_id")
  platformOrderNumber   String    @map("platform_order_number")
  platformStatus        String    @map("platform_status")

  // Order Data
  orderDate             DateTime  @map("order_date")
  currency              String    @default("INR")
  subtotal              Float     @default(0)
  shippingCost          Float     @default(0) @map("shipping_cost")
  taxAmount             Float     @default(0) @map("tax_amount")
  discount              Float     @default(0)
  totalAmount           Float     @default(0) @map("total_amount")

  // Customer
  customerName          String    @map("customer_name")
  customerEmail         String?   @map("customer_email")
  customerPhone         String?   @map("customer_phone")

  // Shipping Address
  shippingName          String?   @map("shipping_name")
  shippingAddress1      String    @map("shipping_address_1")
  shippingAddress2      String?   @map("shipping_address_2")
  shippingCity          String    @map("shipping_city")
  shippingState         String    @map("shipping_state")
  shippingPincode       String    @map("shipping_pincode")
  shippingCountry       String    @default("IN") @map("shipping_country")
  shippingPhone         String?   @map("shipping_phone")

  // Items (JSON)
  lineItems             String    @map("line_items") // JSON array of items
  itemCount             Int       @default(1) @map("item_count")
  totalWeight           Float     @default(0) @map("total_weight")

  // Payment
  paymentMethod         String?   @map("payment_method")
  paymentStatus         String?   @map("payment_status")
  isCod                 Boolean   @default(false) @map("is_cod")

  // Fulfillment
  fulfillmentStatus     String    @default("PENDING") @map("fulfillment_status") // PENDING, PROCESSING, SHIPPED, DELIVERED, CANCELLED

  // CJDQuick Shipment
  shipmentId            String?   @map("shipment_id")
  awbNumber             String?   @map("awb_number")
  shippedAt             DateTime? @map("shipped_at")
  deliveredAt           DateTime? @map("delivered_at")

  // Tracking Sync
  trackingSynced        Boolean   @default(false) @map("tracking_synced")
  lastTrackingSync      DateTime? @map("last_tracking_sync")
  trackingSyncError     String?   @map("tracking_sync_error")

  // Raw Data
  rawOrderData          String?   @map("raw_order_data") // Full JSON from platform

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  integration           EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([integrationId, platformOrderId])
  @@index([integrationId])
  @@index([platformOrderNumber])
  @@index([shipmentId])
  @@index([fulfillmentStatus])
  @@map("ecommerce_orders")
}

model EcommerceSyncLog {
  id                    String    @id @default(cuid())

  integrationId         String    @map("integration_id")

  // Sync Details
  syncType              String    @map("sync_type") // ORDERS, INVENTORY, TRACKING, PRODUCTS
  direction             String    @default("INBOUND") // INBOUND, OUTBOUND

  // Results
  status                String    @default("PENDING") // PENDING, RUNNING, SUCCESS, FAILED
  recordsProcessed      Int       @default(0) @map("records_processed")
  recordsCreated        Int       @default(0) @map("records_created")
  recordsUpdated        Int       @default(0) @map("records_updated")
  recordsFailed         Int       @default(0) @map("records_failed")

  // Timing
  startedAt             DateTime  @default(now()) @map("started_at")
  completedAt           DateTime? @map("completed_at")
  durationMs            Int?      @map("duration_ms")

  // Error Details
  errorMessage          String?   @map("error_message")
  errorDetails          String?   @map("error_details") // JSON
  failedRecords         String?   @map("failed_records") // JSON array

  // Trigger
  triggerType           String    @default("SCHEDULED") // SCHEDULED, MANUAL, WEBHOOK
  triggeredBy           String?   @map("triggered_by")

  // Relations
  integration           EcommerceIntegration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([syncType, status])
  @@index([startedAt])
  @@map("ecommerce_sync_logs")
}

// ============================================
// PHASE 2: CONSUMER TRACKING APP
// ============================================

model ConsumerUser {
  id                    String    @id @default(cuid())

  // Authentication
  phone                 String    @unique
  email                 String?   @unique
  name                  String?

  // Verification
  phoneVerified         Boolean   @default(false) @map("phone_verified")
  emailVerified         Boolean   @default(false) @map("email_verified")

  // Profile
  profilePhoto          String?   @map("profile_photo")
  defaultAddress        String?   @map("default_address")
  defaultAddressLat     Float?    @map("default_address_lat")
  defaultAddressLng     Float?    @map("default_address_lng")

  // Preferences
  language              String    @default("en")
  notifyViaPush         Boolean   @default(true) @map("notify_via_push")
  notifyViaSms          Boolean   @default(true) @map("notify_via_sms")
  notifyViaEmail        Boolean   @default(true) @map("notify_via_email")
  notifyViaWhatsApp     Boolean   @default(true) @map("notify_via_whatsapp")

  // Device
  fcmToken              String?   @map("fcm_token")
  deviceType            String?   @map("device_type") // IOS, ANDROID
  appVersion            String?   @map("app_version")

  // Status
  isActive              Boolean   @default(true) @map("is_active")
  lastActiveAt          DateTime  @default(now()) @map("last_active_at")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  trackingSubscriptions TrackingSubscription[]
  notifications         ConsumerNotification[]
  ratings               DeliveryRating[]
  savedAddresses        ConsumerAddress[]

  @@index([phone])
  @@index([email])
  @@map("consumer_users")
}

model ConsumerAddress {
  id                    String    @id @default(cuid())

  consumerId            String    @map("consumer_id")

  label                 String    // "Home", "Office", "Other"
  name                  String
  phone                 String?
  address               String
  landmark              String?
  city                  String
  state                 String
  pincode               String
  latitude              Float?
  longitude             Float?

  isDefault             Boolean   @default(false) @map("is_default")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  consumer              ConsumerUser @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  @@index([consumerId])
  @@map("consumer_addresses")
}

model TrackingSubscription {
  id                    String    @id @default(cuid())

  consumerId            String?   @map("consumer_id")

  // What to track
  awbNumber             String    @map("awb_number")
  shipmentId            String?   @map("shipment_id")

  // Subscriber (if not a registered user)
  subscriberPhone       String?   @map("subscriber_phone")
  subscriberEmail       String?   @map("subscriber_email")

  // Notification Preferences
  notifyOnPickup        Boolean   @default(true) @map("notify_on_pickup")
  notifyOnTransit       Boolean   @default(true) @map("notify_on_transit")
  notifyOnOutForDelivery Boolean  @default(true) @map("notify_on_out_for_delivery")
  notifyOnDelivered     Boolean   @default(true) @map("notify_on_delivered")
  notifyOnException     Boolean   @default(true) @map("notify_on_exception")

  // Status
  isActive              Boolean   @default(true) @map("is_active")
  lastNotifiedAt        DateTime? @map("last_notified_at")
  lastNotifiedStatus    String?   @map("last_notified_status")

  createdAt             DateTime  @default(now()) @map("created_at")
  expiresAt             DateTime? @map("expires_at")

  // Relations
  consumer              ConsumerUser? @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  @@unique([awbNumber, subscriberPhone])
  @@index([consumerId])
  @@index([awbNumber])
  @@index([isActive])
  @@map("tracking_subscriptions")
}

model ConsumerNotification {
  id                    String    @id @default(cuid())

  consumerId            String    @map("consumer_id")

  // Content
  title                 String
  body                  String
  type                  String    // SHIPMENT_UPDATE, DELIVERY_SCHEDULED, OUT_FOR_DELIVERY, DELIVERED, EXCEPTION, PROMOTIONAL

  // Reference
  awbNumber             String?   @map("awb_number")
  shipmentId            String?   @map("shipment_id")

  // Deep Link
  actionUrl             String?   @map("action_url")
  actionData            String?   @map("action_data") // JSON

  // Delivery
  channel               String    @default("PUSH") // PUSH, SMS, EMAIL, WHATSAPP
  sentVia               String?   @map("sent_via") // FCM, TWILIO, SENDGRID, WHATSAPP_BUSINESS
  sentAt                DateTime? @map("sent_at")
  deliveredAt           DateTime? @map("delivered_at")
  readAt                DateTime? @map("read_at")

  // Status
  status                String    @default("PENDING") // PENDING, SENT, DELIVERED, FAILED, READ
  errorMessage          String?   @map("error_message")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  consumer              ConsumerUser @relation(fields: [consumerId], references: [id], onDelete: Cascade)

  @@index([consumerId])
  @@index([awbNumber])
  @@index([status])
  @@index([createdAt])
  @@map("consumer_notifications")
}

model DeliveryRating {
  id                    String    @id @default(cuid())

  consumerId            String?   @map("consumer_id")

  // What is being rated
  shipmentId            String?   @map("shipment_id")
  awbNumber             String    @map("awb_number")
  orderId               String?   @map("order_id")

  // Rating
  overallRating         Int       @map("overall_rating") // 1-5
  deliverySpeedRating   Int?      @map("delivery_speed_rating")
  packagingRating       Int?      @map("packaging_rating")
  driverRating          Int?      @map("driver_rating")

  // Feedback
  feedbackText          String?   @map("feedback_text")
  feedbackTags          String?   @map("feedback_tags") // JSON array: ["FAST", "POLITE", "DAMAGED_PACKAGE"]

  // Photos (if any issues)
  feedbackPhotos        String?   @map("feedback_photos") // JSON array of URLs

  // Driver/Rider
  driverId              String?   @map("driver_id")
  riderId               String?   @map("rider_id")

  // Response
  responseText          String?   @map("response_text")
  respondedBy           String?   @map("responded_by")
  respondedAt           DateTime? @map("responded_at")

  // Status
  status                String    @default("SUBMITTED") // SUBMITTED, ACKNOWLEDGED, RESOLVED

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  consumer              ConsumerUser? @relation(fields: [consumerId], references: [id])

  @@unique([awbNumber, consumerId])
  @@index([consumerId])
  @@index([awbNumber])
  @@index([overallRating])
  @@index([driverId])
  @@map("delivery_ratings")
}

// ============================================
// PHASE 2: WHATSAPP BUSINESS INTEGRATION
// ============================================

model WhatsAppConfig {
  id                    String    @id @default(cuid())

  // Client (if multi-tenant)
  clientId              String?   @map("client_id")

  // WhatsApp Business API
  businessAccountId     String    @map("business_account_id")
  phoneNumberId         String    @map("phone_number_id")
  displayPhoneNumber    String    @map("display_phone_number")

  // Credentials (encrypted)
  accessToken           String    @map("access_token")
  webhookVerifyToken    String    @map("webhook_verify_token")

  // Provider
  provider              String    @default("META") // META (Cloud API), TWILIO, GUPSHUP, WATI

  // Settings
  defaultLanguage       String    @default("en")
  businessName          String    @map("business_name")
  businessCategory      String?   @map("business_category")

  // Webhook
  webhookUrl            String?   @map("webhook_url")
  webhookEnabled        Boolean   @default(true) @map("webhook_enabled")

  // Status
  isVerified            Boolean   @default(false) @map("is_verified")
  qualityRating         String?   @map("quality_rating") // GREEN, YELLOW, RED
  messagingLimit        String?   @map("messaging_limit") // TIER_1K, TIER_10K, TIER_100K, UNLIMITED

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  templates             WhatsAppTemplate[]
  messages              WhatsAppMessage[]

  @@index([clientId])
  @@map("whatsapp_configs")
}

model WhatsAppTemplate {
  id                    String    @id @default(cuid())

  configId              String    @map("config_id")

  // Template Details
  templateName          String    @map("template_name")
  templateId            String?   @map("template_id") // Meta's template ID after approval
  category              String    // UTILITY, MARKETING, AUTHENTICATION
  language              String    @default("en")

  // Content
  headerType            String?   @map("header_type") // NONE, TEXT, IMAGE, VIDEO, DOCUMENT
  headerContent         String?   @map("header_content")
  bodyContent           String    @map("body_content") // Template text with {{1}} placeholders
  footerContent         String?   @map("footer_content")

  // Buttons
  buttonType            String?   @map("button_type") // NONE, QUICK_REPLY, CALL_TO_ACTION
  buttons               String?   // JSON array of button configs

  // Variables
  variableCount         Int       @default(0) @map("variable_count")
  sampleVariables       String?   @map("sample_variables") // JSON array for approval

  // Use Cases
  useCase               String?   @map("use_case") // SHIPMENT_BOOKED, OUT_FOR_DELIVERY, DELIVERED, NDR, OTP

  // Approval Status
  status                String    @default("PENDING") // PENDING, APPROVED, REJECTED, DISABLED
  rejectionReason       String?   @map("rejection_reason")
  approvedAt            DateTime? @map("approved_at")

  isActive              Boolean   @default(true) @map("is_active")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  config                WhatsAppConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  messages              WhatsAppMessage[]

  @@unique([configId, templateName, language])
  @@index([configId])
  @@index([useCase, status])
  @@map("whatsapp_templates")
}

model WhatsAppMessage {
  id                    String    @id @default(cuid())

  configId              String    @map("config_id")
  templateId            String?   @map("template_id")

  // Message Details
  messageType           String    @map("message_type") // TEMPLATE, TEXT, MEDIA, INTERACTIVE
  direction             String    @default("OUTBOUND") // OUTBOUND, INBOUND

  // Recipient
  recipientPhone        String    @map("recipient_phone")
  recipientName         String?   @map("recipient_name")

  // Content
  templateName          String?   @map("template_name")
  templateVariables     String?   @map("template_variables") // JSON array
  messageBody           String?   @map("message_body") // For text messages
  mediaUrl              String?   @map("media_url")

  // Reference
  shipmentId            String?   @map("shipment_id")
  awbNumber             String?   @map("awb_number")
  orderId               String?   @map("order_id")

  // WhatsApp API Response
  waMessageId           String?   @map("wa_message_id")
  waConversationId      String?   @map("wa_conversation_id")

  // Status
  status                String    @default("PENDING") // PENDING, SENT, DELIVERED, READ, FAILED
  errorCode             String?   @map("error_code")
  errorMessage          String?   @map("error_message")

  // Timestamps
  sentAt                DateTime? @map("sent_at")
  deliveredAt           DateTime? @map("delivered_at")
  readAt                DateTime? @map("read_at")

  // Cost
  conversationType      String?   @map("conversation_type") // UTILITY, MARKETING, SERVICE, AUTHENTICATION
  isBillable            Boolean   @default(true) @map("is_billable")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  config                WhatsAppConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  template              WhatsAppTemplate? @relation(fields: [templateId], references: [id])

  @@index([configId])
  @@index([recipientPhone])
  @@index([awbNumber])
  @@index([status])
  @@index([createdAt])
  @@map("whatsapp_messages")
}

// ============================================
// PHASE 3: FREIGHT EXCHANGE PLATFORM
// ============================================

// Freight request for bidding
model FreightRequest {
  id                    String    @id @default(cuid())
  requestNumber         String    @unique @map("request_number")
  clientId              String    @map("client_id")

  // Origin and destination
  originPincode         String    @map("origin_pincode")
  originCity            String    @map("origin_city")
  originState           String    @map("origin_state")
  destinationPincode    String    @map("destination_pincode")
  destinationCity       String    @map("destination_city")
  destinationState      String    @map("destination_state")

  // Shipment details
  shipmentType          String    @map("shipment_type") // FTL, PTL, EXPRESS, SAME_DAY
  vehicleType           String?   @map("vehicle_type") // TATA_ACE, TATA_407, EICHER_14FT, etc.
  totalWeightKg         Float     @map("total_weight_kg")
  totalVolumeCBM        Float?    @map("total_volume_cbm")
  packageCount          Int       @map("package_count")
  contentDescription    String?   @map("content_description")
  specialInstructions   String?   @map("special_instructions")

  // Requirements
  requiresColdChain     Boolean   @default(false) @map("requires_cold_chain")
  requiresODA           Boolean   @default(false) @map("requires_oda") // Out of delivery area
  requiresFragile       Boolean   @default(false) @map("requires_fragile")
  requiresHazmat        Boolean   @default(false) @map("requires_hazmat")
  requiresInsurance     Boolean   @default(false) @map("requires_insurance")
  insuranceValue        Float?    @map("insurance_value")

  // Timing
  pickupDate            DateTime  @map("pickup_date")
  pickupTimeSlot        String?   @map("pickup_time_slot") // 09:00-12:00, 12:00-15:00, etc.
  expectedDeliveryDate  DateTime  @map("expected_delivery_date")

  // Pricing
  baseBudget            Float?    @map("base_budget") // Client's max budget
  reservePrice          Float?    @map("reserve_price") // Minimum acceptable price
  pricingModel          String    @default("PER_KG") @map("pricing_model") // PER_KG, PER_SHIPMENT, FLAT_RATE

  // Bidding settings
  biddingStartTime      DateTime  @map("bidding_start_time")
  biddingEndTime        DateTime  @map("bidding_end_time")
  autoAward             Boolean   @default(false) @map("auto_award") // Auto-award to lowest bid
  minBids               Int       @default(1) @map("min_bids") // Minimum bids required
  visibleToAll          Boolean   @default(true) @map("visible_to_all") // Or invite-only

  // Status
  status                String    @default("DRAFT") // DRAFT, OPEN, BIDDING, AWARDED, COMPLETED, CANCELLED, EXPIRED
  awardedBidId          String?   @map("awarded_bid_id")
  awardedAt             DateTime? @map("awarded_at")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  bids                  FreightBid[]
  invitedCarriers       FreightRequestInvite[]

  @@index([clientId])
  @@index([status])
  @@index([originPincode, destinationPincode])
  @@index([biddingEndTime])
  @@map("freight_requests")
}

// Carrier bid on a freight request
model FreightBid {
  id                    String    @id @default(cuid())
  requestId             String    @map("request_id")
  carrierId             String    @map("carrier_id") // Partner ID
  carrierName           String    @map("carrier_name")

  // Pricing
  bidAmount             Float     @map("bid_amount")
  bidPerKg              Float?    @map("bid_per_kg")
  fuelSurcharge         Float?    @map("fuel_surcharge")
  odaCharges            Float?    @map("oda_charges")
  handlingCharges       Float?    @map("handling_charges")
  insuranceCharges      Float?    @map("insurance_charges")
  totalAmount           Float     @map("total_amount")

  // Commitment
  estimatedPickupTime   DateTime  @map("estimated_pickup_time")
  estimatedDeliveryTime DateTime  @map("estimated_delivery_time")
  vehicleType           String?   @map("vehicle_type")
  vehicleRegNo          String?   @map("vehicle_reg_no")
  driverName            String?   @map("driver_name")
  driverPhone           String?   @map("driver_phone")

  // Terms
  paymentTerms          String?   @map("payment_terms") // PREPAID, COD, CREDIT_30, CREDIT_45
  validUntil            DateTime  @map("valid_until")
  remarks               String?

  // Status
  status                String    @default("SUBMITTED") // SUBMITTED, SHORTLISTED, ACCEPTED, REJECTED, WITHDRAWN
  isLowestBid           Boolean   @default(false) @map("is_lowest_bid")
  rankPosition          Int?      @map("rank_position")

  // Rejection
  rejectionReason       String?   @map("rejection_reason")
  rejectedAt            DateTime? @map("rejected_at")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  request               FreightRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([carrierId])
  @@index([status])
  @@map("freight_bids")
}

// Invited carriers for a request
model FreightRequestInvite {
  id                    String    @id @default(cuid())
  requestId             String    @map("request_id")
  carrierId             String    @map("carrier_id")
  carrierName           String    @map("carrier_name")
  carrierEmail          String?   @map("carrier_email")
  carrierPhone          String?   @map("carrier_phone")

  invitedAt             DateTime  @default(now()) @map("invited_at")
  viewedAt              DateTime? @map("viewed_at")
  respondedAt           DateTime? @map("responded_at")
  response              String?   // INTERESTED, NOT_INTERESTED, BID_SUBMITTED

  request               FreightRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@unique([requestId, carrierId])
  @@map("freight_request_invites")
}

// Carrier performance profile
model CarrierProfile {
  id                    String    @id @default(cuid())
  partnerId             String    @unique @map("partner_id")

  // Rating scores
  overallRating         Float     @default(0) @map("overall_rating") // 0-5
  deliveryRating        Float     @default(0) @map("delivery_rating")
  pricingRating         Float     @default(0) @map("pricing_rating")
  communicationRating   Float     @default(0) @map("communication_rating")

  // Performance metrics
  totalBidsSubmitted    Int       @default(0) @map("total_bids_submitted")
  totalBidsWon          Int       @default(0) @map("total_bids_won")
  winRate               Float     @default(0) @map("win_rate")
  totalShipmentsCompleted Int     @default(0) @map("total_shipments_completed")
  onTimeDeliveryRate    Float     @default(0) @map("on_time_delivery_rate")
  damageRate            Float     @default(0) @map("damage_rate")

  // Capabilities
  serviceablePincodes   String?   @map("serviceable_pincodes") // JSON array
  vehicleTypes          String?   @map("vehicle_types") // JSON array
  specializations       String?   // COLD_CHAIN, HAZMAT, FRAGILE, EXPRESS
  maxWeightCapacity     Float?    @map("max_weight_capacity")

  // Verification
  isVerified            Boolean   @default(false) @map("is_verified")
  verifiedAt            DateTime? @map("verified_at")
  documentsVerified     Boolean   @default(false) @map("documents_verified")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@map("carrier_profiles")
}

// ============================================
// PHASE 3: IOT & COLD CHAIN MONITORING
// ============================================

// IoT device registry
model IoTDevice {
  id                    String    @id @default(cuid())
  deviceId              String    @unique @map("device_id")
  deviceType            String    @map("device_type") // TEMPERATURE_SENSOR, GPS_TRACKER, HUMIDITY_SENSOR, DOOR_SENSOR
  manufacturer          String?
  model                 String?
  serialNumber          String?   @map("serial_number")
  firmwareVersion       String?   @map("firmware_version")

  // Assignment
  assignmentType        String?   @map("assignment_type") // VEHICLE, CONTAINER, SHIPMENT, WAREHOUSE
  vehicleId             String?   @map("vehicle_id")
  containerId           String?   @map("container_id")
  warehouseId           String?   @map("warehouse_id")
  zoneId                String?   @map("zone_id")

  // Configuration
  reportingIntervalSec  Int       @default(300) @map("reporting_interval_sec") // 5 minutes default
  tempMinThreshold      Float?    @map("temp_min_threshold")
  tempMaxThreshold      Float?    @map("temp_max_threshold")
  humidityMinThreshold  Float?    @map("humidity_min_threshold")
  humidityMaxThreshold  Float?    @map("humidity_max_threshold")

  // Status
  status                String    @default("ACTIVE") // ACTIVE, INACTIVE, MAINTENANCE, LOST
  batteryLevel          Float?    @map("battery_level") // 0-100
  signalStrength        Float?    @map("signal_strength")
  lastSeenAt            DateTime? @map("last_seen_at")
  lastLatitude          Float?    @map("last_latitude")
  lastLongitude         Float?    @map("last_longitude")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  readings              IoTReading[]
  alerts                ColdChainAlert[]

  @@index([deviceType])
  @@index([status])
  @@index([vehicleId])
  @@map("iot_devices")
}

// IoT sensor readings
model IoTReading {
  id                    String    @id @default(cuid())
  deviceId              String    @map("device_id")

  // Reading values
  temperature           Float?    // Celsius
  humidity              Float?    // Percentage
  pressure              Float?    // hPa
  lightLevel            Float?    @map("light_level") // Lux
  shockLevel            Float?    @map("shock_level") // g-force
  doorStatus            String?   @map("door_status") // OPEN, CLOSED

  // Location
  latitude              Float?
  longitude             Float?
  altitude              Float?
  speed                 Float?    // km/h

  // Status
  batteryLevel          Float?    @map("battery_level")
  signalStrength        Float?    @map("signal_strength")

  // Context
  shipmentId            String?   @map("shipment_id")
  tripId                String?   @map("trip_id")

  // Flags
  isAnomaly             Boolean   @default(false) @map("is_anomaly")
  anomalyType           String?   @map("anomaly_type") // TEMP_HIGH, TEMP_LOW, SHOCK, DOOR_OPEN

  recordedAt            DateTime  @default(now()) @map("recorded_at")
  receivedAt            DateTime  @default(now()) @map("received_at")

  // Relations
  device                IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId, recordedAt])
  @@index([shipmentId])
  @@index([isAnomaly])
  @@map("iot_readings")
}

// Cold chain shipment requirements
model ColdChainShipment {
  id                    String    @id @default(cuid())
  shipmentId            String    @unique @map("shipment_id")

  // Temperature requirements
  tempCategory          String    @map("temp_category") // FROZEN, CHILLED, AMBIENT_CONTROLLED
  tempMinRequired       Float     @map("temp_min_required") // Celsius
  tempMaxRequired       Float     @map("temp_max_required") // Celsius
  tempTolerance         Float     @default(2) @map("temp_tolerance") // Allowed deviation

  // Additional requirements
  humidityMinRequired   Float?    @map("humidity_min_required")
  humidityMaxRequired   Float?    @map("humidity_max_required")
  lightSensitive        Boolean   @default(false) @map("light_sensitive")
  shockSensitive        Boolean   @default(false) @map("shock_sensitive")
  maxShockG             Float?    @map("max_shock_g")

  // Monitoring devices
  assignedDeviceIds     String?   @map("assigned_device_ids") // JSON array

  // Compliance
  requiresDataLogger    Boolean   @default(true) @map("requires_data_logger")
  requiresGDPCompliance Boolean   @default(false) @map("requires_gdp_compliance") // Good Distribution Practice
  requiresHACCP         Boolean   @default(false) @map("requires_haccp") // Hazard Analysis

  // Product details
  productType           String?   @map("product_type") // PHARMA, VACCINE, FOOD, CHEMICALS
  batchNumbers          String?   @map("batch_numbers") // JSON array
  expiryDate            DateTime? @map("expiry_date")

  // Status
  monitoringStatus      String    @default("ACTIVE") @map("monitoring_status") // ACTIVE, PAUSED, COMPLETED, BREACH
  totalExcursions       Int       @default(0) @map("total_excursions")
  maxExcursionDuration  Int       @default(0) @map("max_excursion_duration") // Minutes

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  excursions            ColdChainExcursion[]
  certificates          ColdChainCertificate[]

  @@map("cold_chain_shipments")
}

// Temperature/condition excursion events
model ColdChainExcursion {
  id                    String    @id @default(cuid())
  coldChainShipmentId   String    @map("cold_chain_shipment_id")
  deviceId              String?   @map("device_id")

  // Excursion details
  excursionType         String    @map("excursion_type") // TEMP_HIGH, TEMP_LOW, HUMIDITY_HIGH, HUMIDITY_LOW, SHOCK, DOOR_OPEN
  thresholdValue        Float     @map("threshold_value")
  actualValue           Float     @map("actual_value")
  deviationAmount       Float     @map("deviation_amount")

  // Duration
  startTime             DateTime  @map("start_time")
  endTime               DateTime? @map("end_time")
  durationMinutes       Int?      @map("duration_minutes")

  // Location
  latitude              Float?
  longitude             Float?
  locationDescription   String?   @map("location_description")

  // Severity
  severity              String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL

  // Resolution
  status                String    @default("ACTIVE") // ACTIVE, RESOLVED, ACKNOWLEDGED
  resolvedAt            DateTime? @map("resolved_at")
  resolvedBy            String?   @map("resolved_by")
  resolutionNotes       String?   @map("resolution_notes")

  // Impact assessment
  productImpact         String?   @map("product_impact") // NONE, MINOR, MAJOR, TOTAL_LOSS

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  coldChainShipment     ColdChainShipment @relation(fields: [coldChainShipmentId], references: [id], onDelete: Cascade)

  @@index([coldChainShipmentId])
  @@index([severity, status])
  @@map("cold_chain_excursions")
}

// Cold chain alerts
model ColdChainAlert {
  id                    String    @id @default(cuid())
  deviceId              String    @map("device_id")
  shipmentId            String?   @map("shipment_id")

  alertType             String    @map("alert_type") // TEMP_BREACH, HUMIDITY_BREACH, SHOCK, DOOR_OPEN, BATTERY_LOW, DEVICE_OFFLINE
  severity              String    @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL

  message               String
  currentValue          Float?    @map("current_value")
  thresholdValue        Float?    @map("threshold_value")

  status                String    @default("ACTIVE") // ACTIVE, ACKNOWLEDGED, RESOLVED
  acknowledgedBy        String?   @map("acknowledged_by")
  acknowledgedAt        DateTime? @map("acknowledged_at")
  resolvedAt            DateTime? @map("resolved_at")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  device                IoTDevice @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@index([deviceId])
  @@index([shipmentId])
  @@index([alertType, status])
  @@map("cold_chain_alerts")
}

// Cold chain compliance certificates
model ColdChainCertificate {
  id                    String    @id @default(cuid())
  coldChainShipmentId   String    @map("cold_chain_shipment_id")

  certificateType       String    @map("certificate_type") // TEMPERATURE_LOG, GDP_COMPLIANCE, HACCP, CUSTOMS_RELEASE
  certificateNumber     String    @map("certificate_number")

  // Validity
  issuedAt              DateTime  @map("issued_at")
  validUntil            DateTime? @map("valid_until")

  // Content
  temperatureDataUrl    String?   @map("temperature_data_url") // Link to temperature log
  chartImageUrl         String?   @map("chart_image_url") // Temperature chart image
  pdfUrl                String?   @map("pdf_url")

  // Summary
  minTempRecorded       Float?    @map("min_temp_recorded")
  maxTempRecorded       Float?    @map("max_temp_recorded")
  avgTempRecorded       Float?    @map("avg_temp_recorded")
  totalReadings         Int?      @map("total_readings")
  excursionCount        Int       @default(0) @map("excursion_count")

  // Compliance result
  complianceStatus      String    @map("compliance_status") // COMPLIANT, NON_COMPLIANT, PARTIAL
  remarks               String?

  // Digital signature
  signedBy              String?   @map("signed_by")
  signatureHash         String?   @map("signature_hash")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  coldChainShipment     ColdChainShipment @relation(fields: [coldChainShipmentId], references: [id], onDelete: Cascade)

  @@index([coldChainShipmentId])
  @@map("cold_chain_certificates")
}

// ============================================
// PHASE 3: ADVANCED ML MODELS
// ============================================

// ML model registry
model MLModel {
  id                    String    @id @default(cuid())
  modelName             String    @map("model_name")
  modelType             String    @map("model_type") // DEMAND_FORECAST, ETA_PREDICTION, DELAY_RISK, ROUTE_OPTIMIZATION
  version               String

  // Training details
  trainingDataStart     DateTime? @map("training_data_start")
  trainingDataEnd       DateTime? @map("training_data_end")
  sampleCount           Int?      @map("sample_count")
  features              String?   // JSON array of features used

  // Algorithm
  algorithm             String?   // XGBoost, LSTM, Prophet, Random Forest, etc.
  hyperparameters       String?   // JSON object

  // Performance metrics
  trainingAccuracy      Float?    @map("training_accuracy")
  validationAccuracy    Float?    @map("validation_accuracy")
  mape                  Float?    // Mean Absolute Percentage Error
  rmse                  Float?    // Root Mean Square Error

  // Deployment
  status                String    @default("TRAINING") // TRAINING, VALIDATED, DEPLOYED, DEPRECATED
  deployedAt            DateTime? @map("deployed_at")
  isActive              Boolean   @default(false) @map("is_active")

  // Artifacts
  modelArtifactUrl      String?   @map("model_artifact_url")
  modelSize             Int?      @map("model_size") // bytes

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  trainingJobs          MLTrainingJob[]

  @@index([modelType, isActive])
  @@map("ml_models")
}

// ML model training jobs
model MLTrainingJob {
  id                    String    @id @default(cuid())
  modelId               String?   @map("model_id")
  modelType             String    @map("model_type")

  // Job details
  jobName               String    @map("job_name")
  status                String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED

  // Training parameters
  trainingConfig        String?   @map("training_config") // JSON
  datasetConfig         String?   @map("dataset_config") // JSON

  // Progress
  progress              Float     @default(0) // 0-100
  currentEpoch          Int?      @map("current_epoch")
  totalEpochs           Int?      @map("total_epochs")

  // Results
  metricsLog            String?   @map("metrics_log") // JSON array of epoch metrics
  finalMetrics          String?   @map("final_metrics") // JSON

  // Timing
  startedAt             DateTime? @map("started_at")
  completedAt           DateTime? @map("completed_at")
  durationSeconds       Int?      @map("duration_seconds")

  // Error handling
  errorMessage          String?   @map("error_message")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  model                 MLModel?  @relation(fields: [modelId], references: [id])

  @@index([modelType, status])
  @@index([createdAt])
  @@map("ml_training_jobs")
}

// ============================================
// PHASE 3: BI TOOL INTEGRATION
// ============================================

// BI tool connections
model BIConnection {
  id                    String    @id @default(cuid())
  name                  String
  toolType              String    @map("tool_type") // POWER_BI, TABLEAU, METABASE, LOOKER, CUSTOM

  // Connection details
  connectionType        String    @map("connection_type") // DIRECT, OAUTH, API_KEY, SERVICE_ACCOUNT
  host                  String?
  port                  Int?
  database              String?
  username              String?
  encryptedPassword     String?   @map("encrypted_password")
  apiKey                String?   @map("api_key")
  oauthToken            String?   @map("oauth_token")

  // Settings
  refreshIntervalMin    Int       @default(60) @map("refresh_interval_min")
  autoRefresh           Boolean   @default(true) @map("auto_refresh")

  // Status
  status                String    @default("ACTIVE") // ACTIVE, INACTIVE, ERROR
  lastConnectedAt       DateTime? @map("last_connected_at")
  lastError             String?   @map("last_error")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  datasets              BIDataset[]

  @@map("bi_connections")
}

// BI datasets/data sources
model BIDataset {
  id                    String    @id @default(cuid())
  connectionId          String    @map("connection_id")
  name                  String
  description           String?

  // Data definition
  dataType              String    @map("data_type") // SHIPMENTS, HUBS, VEHICLES, PERFORMANCE, CUSTOM
  queryDefinition       String?   @map("query_definition") // SQL or query config
  aggregationLevel      String?   @map("aggregation_level") // RAW, HOURLY, DAILY, WEEKLY, MONTHLY

  // Schema
  columns               String?   // JSON array of column definitions
  primaryKey            String?   @map("primary_key")

  // Refresh
  lastRefreshAt         DateTime? @map("last_refresh_at")
  nextRefreshAt         DateTime? @map("next_refresh_at")
  rowCount              Int?      @map("row_count")
  sizeBytes             Int?      @map("size_bytes")

  // Status
  status                String    @default("ACTIVE") // ACTIVE, REFRESHING, ERROR, PAUSED
  lastError             String?   @map("last_error")

  isPublic              Boolean   @default(false) @map("is_public")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  connection            BIConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  reports               BIReport[]

  @@map("bi_datasets")
}

// BI reports
model BIReport {
  id                    String    @id @default(cuid())
  datasetId             String    @map("dataset_id")
  name                  String
  description           String?

  // Report configuration
  reportType            String    @map("report_type") // DASHBOARD, TABLE, CHART, PIVOT
  visualizations        String?   // JSON array of visualization configs
  filters               String?   // JSON array of filter configs

  // Sharing
  isPublic              Boolean   @default(false) @map("is_public")
  shareableLink         String?   @map("shareable_link")
  allowedUsers          String?   @map("allowed_users") // JSON array

  // Scheduling
  scheduleEnabled       Boolean   @default(false) @map("schedule_enabled")
  scheduleCron          String?   @map("schedule_cron")
  emailRecipients       String?   @map("email_recipients") // JSON array

  // Stats
  viewCount             Int       @default(0) @map("view_count")
  lastViewedAt          DateTime? @map("last_viewed_at")

  createdBy             String?   @map("created_by")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  dataset               BIDataset @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@map("bi_reports")
}

// ============================================
// PHASE 3: WAREHOUSE ROBOTICS
// ============================================

// Warehouse robot/AGV/AMR registry
model WarehouseRobot {
  id                    String    @id @default(cuid())
  robotId               String    @unique @map("robot_id")
  warehouseId           String    @map("warehouse_id")

  // Robot details
  robotType             String    @map("robot_type") // AGV, AMR, PICKING_ARM, SORTING_ROBOT, PALLET_MOVER
  manufacturer          String?
  model                 String?
  serialNumber          String?   @map("serial_number")

  // Capabilities
  maxPayloadKg          Float?    @map("max_payload_kg")
  maxSpeedMps           Float?    @map("max_speed_mps") // meters per second
  navigationTechnology  String?   @map("navigation_technology") // LIDAR, VISION, MAGNETIC, QR_CODE
  canPickItems          Boolean   @default(false) @map("can_pick_items")
  canPlaceItems         Boolean   @default(false) @map("can_place_items")
  canTransportPallets   Boolean   @default(false) @map("can_transport_pallets")
  canSortPackages       Boolean   @default(false) @map("can_sort_packages")

  // Current status
  status                String    @default("IDLE") // IDLE, WORKING, CHARGING, MAINTENANCE, ERROR, OFFLINE
  currentZoneId         String?   @map("current_zone_id")
  currentTaskId         String?   @map("current_task_id")

  // Position
  positionX             Float?    @map("position_x")
  positionY             Float?    @map("position_y")
  positionZ             Float?    @map("position_z")
  orientationDeg        Float?    @map("orientation_deg")

  // Battery/power
  batteryLevel          Float?    @map("battery_level") // 0-100
  isCharging            Boolean   @default(false) @map("is_charging")
  chargingStationId     String?   @map("charging_station_id")

  // Stats
  totalTasksCompleted   Int       @default(0) @map("total_tasks_completed")
  totalDistanceMeters   Float     @default(0) @map("total_distance_meters")
  totalOperatingHours   Float     @default(0) @map("total_operating_hours")
  errorCount            Int       @default(0) @map("error_count")

  // Maintenance
  lastMaintenanceAt     DateTime? @map("last_maintenance_at")
  nextMaintenanceDue    DateTime? @map("next_maintenance_due")

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  // Relations
  tasks                 RobotTask[]
  maintenanceRecords    RobotMaintenance[]

  @@index([warehouseId])
  @@index([status])
  @@map("warehouse_robots")
}

// Robot task assignments
model RobotTask {
  id                    String    @id @default(cuid())
  robotId               String    @map("robot_id")
  warehouseId           String    @map("warehouse_id")

  // Task details
  taskType              String    @map("task_type") // PICK, PLACE, TRANSPORT, SORT, CHARGE, RELOCATE
  priority              Int       @default(5) // 1-10, 1 is highest

  // Source and destination
  sourceZoneId          String?   @map("source_zone_id")
  sourceLocation        String?   @map("source_location") // Bin/slot location
  destinationZoneId     String?   @map("destination_zone_id")
  destinationLocation   String?   @map("destination_location")

  // Items
  itemId                String?   @map("item_id")
  itemSku               String?   @map("item_sku")
  itemQuantity          Int?      @map("item_quantity")
  containerType         String?   @map("container_type") // BIN, PALLET, TOTE
  containerId           String?   @map("container_id")

  // Linked orders
  pickListId            String?   @map("pick_list_id")
  waveId                String?   @map("wave_id")
  orderId               String?   @map("order_id")

  // Status
  status                String    @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, FAILED, CANCELLED

  // Timing
  scheduledAt           DateTime? @map("scheduled_at")
  startedAt             DateTime? @map("started_at")
  completedAt           DateTime? @map("completed_at")
  estimatedDurationSec  Int?      @map("estimated_duration_sec")
  actualDurationSec     Int?      @map("actual_duration_sec")

  // Errors
  failureReason         String?   @map("failure_reason")
  retryCount            Int       @default(0) @map("retry_count")

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  robot                 WarehouseRobot @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([robotId, status])
  @@index([warehouseId, status])
  @@index([priority, status])
  @@map("robot_tasks")
}

// Robot operating zones
model RobotZone {
  id                    String    @id @default(cuid())
  warehouseId           String    @map("warehouse_id")
  zoneName              String    @map("zone_name")
  zoneCode              String    @map("zone_code")

  // Zone type
  zoneType              String    @map("zone_type") // PICKING, PACKING, STORAGE, RECEIVING, SHIPPING, CHARGING

  // Boundaries (coordinates in meters from warehouse origin)
  minX                  Float     @map("min_x")
  maxX                  Float     @map("max_x")
  minY                  Float     @map("min_y")
  maxY                  Float     @map("max_y")

  // Configuration
  maxRobots             Int       @default(5) @map("max_robots")
  speedLimitMps         Float?    @map("speed_limit_mps")
  isRestrictedAccess    Boolean   @default(false) @map("is_restricted_access")
  allowedRobotTypes     String?   @map("allowed_robot_types") // JSON array

  // Traffic rules
  oneWayDirection       String?   @map("one_way_direction") // N, S, E, W, or null for bidirectional
  priority              Int       @default(5) // Zone priority for routing

  status                String    @default("ACTIVE") // ACTIVE, MAINTENANCE, BLOCKED

  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  @@unique([warehouseId, zoneCode])
  @@map("robot_zones")
}

// Robot maintenance records
model RobotMaintenance {
  id                    String    @id @default(cuid())
  robotId               String    @map("robot_id")

  // Maintenance details
  maintenanceType       String    @map("maintenance_type") // PREVENTIVE, CORRECTIVE, EMERGENCY
  description           String

  // Parts
  partsReplaced         String?   @map("parts_replaced") // JSON array
  partsCost             Float?    @map("parts_cost")
  laborCost             Float?    @map("labor_cost")
  totalCost             Float?    @map("total_cost")

  // Technician
  technicianName        String?   @map("technician_name")
  technicianId          String?   @map("technician_id")

  // Timing
  scheduledAt           DateTime? @map("scheduled_at")
  startedAt             DateTime  @map("started_at")
  completedAt           DateTime? @map("completed_at")
  durationMinutes       Int?      @map("duration_minutes")

  // Status
  status                String    @default("SCHEDULED") // SCHEDULED, IN_PROGRESS, COMPLETED, CANCELLED

  notes                 String?

  createdAt             DateTime  @default(now()) @map("created_at")

  // Relations
  robot                 WarehouseRobot @relation(fields: [robotId], references: [id], onDelete: Cascade)

  @@index([robotId])
  @@index([maintenanceType])
  @@map("robot_maintenance")
}
